
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="CarPropertyService服务">
      
      
        <meta name="author" content="Solo">
      
      
        <link rel="canonical" href="https://0.0.0.0:8000/android/car/carservice/car-property-service/">
      
      
        <link rel="prev" href="../car-property-manager/">
      
      
        <link rel="next" href="../../vehicle/android-s-hal-intro/">
      
      
      <link rel="icon" href="../../../../assets/images/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>Android 15 CarService源码09-CarPropertyService - Solo's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../fonts/lxgw-wenkai.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/extra2.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/link.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/customize.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/bannerSlider.css">
    
      <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      



<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="页眉">
        <a href="../../../.." title="Solo&#39;s Blog"
           class="md-header__button md-logo" aria-label="Solo's Blog" data-md-component="logo">
            
  <img src="../../../../assets/images/logo.png" alt="logo">

        </a>
        <label class="md-header__button md-icon" for="__drawer">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
        </label>
        <div class="md-header__title" data-md-component="header-title">
            <div class="md-header__ellipsis">
                <div class="md-header__topic">
          <span class="md-ellipsis">
            Solo's Blog
          </span>
                </div>
                <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Android 15 CarService源码09-CarPropertyService
            
          </span>
                </div>
            </div>
        </div>
        
        



<div class="md-copyright">
    
    <font color=#608DBD size=3>
        <span id="jinrishici-sentence">正在加载今日诗词....</span>
        <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    </font>
    

    
</div>
        
        
        
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
        
        
        
        <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
        
        
        
        <label class="md-header__button md-icon" for="__search">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
        
        <div class="md-header__source">
            <a href="https://github.com/i-rtfsc/note" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    i-rtfsc/note
  </div>
</a>
        </div>
        
    </nav>
    
    
    
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../brightness/automatic-brightness-intro/" class="md-tabs__link">
          
  
    
  
  Android

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../base/51-android-rules/" class="md-tabs__link">
          
  
    
  
  基础技术

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../development-board/raspberry-pi/intro/" class="md-tabs__link">
          
  
    
  
  开发板

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../source-code/personal-source-code-intro/" class="md-tabs__link">
          
  
    
  
  源码工程

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
    
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Solo&#39;s Blog" class="md-nav__button md-logo" aria-label="Solo's Blog" data-md-component="logo">
      
  <img src="../../../../assets/images/logo.png" alt="logo">

    </a>
    Solo's Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/i-rtfsc/note" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    i-rtfsc/note
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Android
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Android
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../brightness/automatic-brightness-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android自动背光机制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tombstones/tombstones-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NativeTombstoneManager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../bootanimation/bootanimation-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bootanimation程序简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AMS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            AMS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/launch-modes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity四大启动模式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/client_transaction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架01-客户端事务管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/activity_client_record/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架02-ActivityClientRecord
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/activity_thread/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架03-ActivityThread
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/activity_context/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架04-Activity和Context的关系
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/lifecycle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity生命周期
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/android11-activity-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android11 Activity启动流程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/wm-layout-params/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WindowManager.LayoutParams
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/frida-dump-activity-lifecycle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    frida dump activity生命周期
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Broadcast
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            Broadcast
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../broadcast/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Broadcast概述
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    SELinux
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            SELinux
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../selinux/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android SELinux介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../selinux/genfscon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    genfscon
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Binder
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            Binder
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/android12-native-binder-change/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 12 Native Binder 代码变迁
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/ashmem/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ashmem简介（Android IPC传输大数据）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/driver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制01-驱动
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/service-manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制02-ServiceManager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/framework-native/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制03-Framework-Native
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/framework-java/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制04-Framework-Java
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/aidl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制05-AIDL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder概述
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/am-trace-ipc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    am trace-ipc 分析
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" checked>
        
          
          <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Car
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            Car
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_8_1" id="__nav_2_8_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    CarService
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_8_1">
            <span class="md-nav__icon md-icon"></span>
            CarService
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../start-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码01-服务启动
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../init-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码02-服务初始化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../all-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码03-服务及接口
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carservice-call-vhal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码04-CarService与Vehicle HAL交互
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../system-interface/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码05-SystemInterface
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../car-input-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码06-CarInputService
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../car-wifi-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码07-CarWifiService
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../car-property-manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码08-CarPropertyService
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Android 15 CarService源码09-CarPropertyService
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码09-CarPropertyService
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      前言
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      初始化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="初始化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#propertyhalservice" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PropertyHalService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#propertyhalservice_1" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService构造函数
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PropertyHalService构造函数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vehiclehalgethalpropvaluebuilder" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.getHalPropValueBuilder()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aidlvehiclestubgethalpropvaluebuilder" class="md-nav__link">
    <span class="md-ellipsis">
      AidlVehicleStub.getHalPropValueBuilder()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalservicetakeproperties" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.takeProperties()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PropertyHalService.takeProperties()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#propertyhalserviceissupportedproperty" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.isSupportedProperty()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalserviceconfigsissupportedproperty" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalServiceConfigs.isSupportedProperty()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalserviceinit" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.init()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalservicegetallsupportedproperties" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.getAllSupportedProperties()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#carpropertyservice" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CarPropertyService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#carpropertyservice_1" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService构造函数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#carpropertyserviceinit" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService.init()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CarPropertyService.init()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#propertyhalservicegetpropertylist" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.getPropertyList()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalservicesetpropertyhallistener" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.setPropertyHalListener()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#carpropertyserviceoninitcomplete" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService.onInitComplete()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      属性事件回调
    </span>
  </a>
  
    <nav class="md-nav" aria-label="属性事件回调">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#carpropertyservice_2" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService 监听属性事件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CarPropertyService 监听属性事件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#propertyhalservicesetpropertyhallistener_1" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.setPropertyHalListener()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalserviceonhalevents" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.onHalEvents()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalhandleonpropertyevent" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.handleOnPropertyEvent()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalpriorityinit" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.priorityInit()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#carpropertyserviceonpropertychange" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService.onPropertyChange()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#carpropertymanager" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyManager 监听属性事件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CarPropertyManager 监听属性事件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#carpropertyserviceregisterlistener" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService.registerListener()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subscriptionmanager" class="md-nav__link">
    <span class="md-ellipsis">
      SubscriptionManager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subscriptionmanagerstagenewoptions" class="md-nav__link">
    <span class="md-ellipsis">
      SubscriptionManager.stageNewOptions()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#carpropertyserviceapplystagedchangeslocked" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService.applyStagedChangesLocked()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subscriptionmanagerdiffbetweencurrentandstage" class="md-nav__link">
    <span class="md-ellipsis">
      SubscriptionManager.diffBetweenCurrentAndStage()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalservicesubscribeproperty" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.subscribeProperty()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PropertyHalService.subscribeProperty()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#propertyhalserviceupdatesubscriptionratelocked" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.updateSubscriptionRateLocked()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalserviceunsubscribeproperty" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.unsubscribeProperty()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PropertyHalService.unsubscribeProperty()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#subscriptionmanagerstageunregister" class="md-nav__link">
    <span class="md-ellipsis">
      SubscriptionManager.stageUnregister()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subscriptionmanagercommit" class="md-nav__link">
    <span class="md-ellipsis">
      SubscriptionManager.commit()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      设置属性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="设置属性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#carpropertyservicesetproperty" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService.setProperty()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalservicesetproperty" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.setProperty()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalset" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.set()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aidlvehiclestubset" class="md-nav__link">
    <span class="md-ellipsis">
      AidlVehicleStub.set()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      获取属性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="获取属性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#carpropertyservicegetproperty" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService.getProperty()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalservicegetproperty" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.getProperty()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalget" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.get()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aidlvehiclestubget" class="md-nav__link">
    <span class="md-ellipsis">
      AidlVehicleStub.get()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      后话
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_2" >
        
          
          <label class="md-nav__link" for="__nav_2_8_2" id="__nav_2_8_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Vehicle
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_2">
            <span class="md-nav__icon md-icon"></span>
            Vehicle
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vehicle/android-s-hal-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android-S Vehicle HAL架构
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vehicle/android-u-hal-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android-U Vehicle HAL架构
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
        
          
          <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Input
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            Input
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/focused-window/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 窗口焦点介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/inotify-epoll/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    INotify与Epoll机制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/inputDispatcher-inputChannel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    InputDispatcher与InputChannel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Input概述
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Input系统01-Input启动过程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/input-reader/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Input系统02-InputReader线程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/scancode-keycode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scancode到Keycode的映射
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/add-new-key/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    新增物理按键处理流程
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" >
        
          
          <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    基础与工具
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_10">
            <span class="md-nav__icon md-icon"></span>
            基础与工具
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/adb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ADB
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/api-levels/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android API Levels
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/as-shortcut-keys/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android Studio 快捷键
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/as-compdb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Compdb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/apksigner/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    apksigner签名工具
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/c-ifdef/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    c代码中 ifdef 多条件判断
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/repo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    repo常用操作
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/ccache/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用ccache加快编译速度
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/winscope/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编译winscope
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" >
        
          
          <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    巧夺天工
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11">
            <span class="md-nav__icon md-icon"></span>
            巧夺天工
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../divine-skill/android-bp-if-else/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android.bp 添加宏控
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../divine-skill/service-extra-func-without-aidl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    aosp原生Service快捷扩展接口
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../divine-skill/mem-pressure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内存加压
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../divine-skill/log-to-line-chart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    通过log中的坐标转成折线图
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_12" >
        
          
          <label class="md-nav__link" for="__nav_2_12" id="__nav_2_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    调试技巧
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_12">
            <span class="md-nav__icon md-icon"></span>
            调试技巧
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/tomestone-stack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android Native crash tomestone trace tools
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/call-stack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android打印函数调用流程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/am-set-debug-app/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    am set-debug-app 介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/privapp-permissions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    privapp permissions检查
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/event-log/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    借助 event log 有效排查问题
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/merge-sort-log/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    按时间顺序合并log
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/jdwp-enabled/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    无法打断点调试
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_12_8" >
        
          
          <label class="md-nav__link" for="__nav_2_12_8" id="__nav_2_12_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    调频命令
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_12_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_12_8">
            <span class="md-nav__icon md-icon"></span>
            调频命令
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/frequency/cpu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CPU提频命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/frequency/gpu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GPU提频命令
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_13" >
        
          
          <label class="md-nav__link" for="__nav_2_13" id="__nav_2_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    问题及方案
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_13">
            <span class="md-nav__icon md-icon"></span>
            问题及方案
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../issue-solution/set-affinity/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android进程绑核方案
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../issue_solution/car-service-updatable-call-hide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CarServiceUpdatable引用hide接口
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    基础技术
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            基础技术
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/51-android-rules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    51-android.rules
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/jar-delete/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Jar包删除部分内容
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/jetbrains_directories/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JetBrains配置目录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/git_branch_commit_single/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    git小技巧-commit single
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/hexo-next/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hexo、next主题美化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/linux-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linux service
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/mkdocs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mkdocs博客搭建
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/sshfs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sshfs命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/tmux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tmux
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/tar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tar命令
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    开发板
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            开发板
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    树莓派
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            树莓派
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../development-board/raspberry-pi/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    树莓派基础配置
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    源码工程
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            源码工程
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/personal-source-code-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    个人源码工程简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ExtFrameworks
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            ExtFrameworks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/aosp-ext/fwk-ext/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    aosp frameworks扩展方案
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Android feature
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Android feature
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/android-feature/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android Device Feature
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    As aosp
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            As aosp
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    as-aosp工程简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/first-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程001-首次配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程002-设计思路
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/simple-extra/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程003-简单扩展
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/plugin-extra/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程004-插件扩展
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/jump-system-code/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程005-跳转系统源码[6.x版本默认跳转]
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/jump-aidl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程006-aidl跳转
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/jump-cpp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程007-c++跳转
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/jump-system-code-2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程008-跳转系统源码[进阶版]
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Global scripts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            Global scripts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/global-scripts/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    global_scripts工程简介
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      前言
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      初始化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="初始化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#propertyhalservice" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PropertyHalService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#propertyhalservice_1" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService构造函数
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PropertyHalService构造函数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vehiclehalgethalpropvaluebuilder" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.getHalPropValueBuilder()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aidlvehiclestubgethalpropvaluebuilder" class="md-nav__link">
    <span class="md-ellipsis">
      AidlVehicleStub.getHalPropValueBuilder()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalservicetakeproperties" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.takeProperties()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PropertyHalService.takeProperties()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#propertyhalserviceissupportedproperty" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.isSupportedProperty()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalserviceconfigsissupportedproperty" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalServiceConfigs.isSupportedProperty()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalserviceinit" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.init()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalservicegetallsupportedproperties" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.getAllSupportedProperties()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#carpropertyservice" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CarPropertyService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#carpropertyservice_1" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService构造函数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#carpropertyserviceinit" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService.init()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CarPropertyService.init()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#propertyhalservicegetpropertylist" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.getPropertyList()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalservicesetpropertyhallistener" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.setPropertyHalListener()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#carpropertyserviceoninitcomplete" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService.onInitComplete()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      属性事件回调
    </span>
  </a>
  
    <nav class="md-nav" aria-label="属性事件回调">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#carpropertyservice_2" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService 监听属性事件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CarPropertyService 监听属性事件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#propertyhalservicesetpropertyhallistener_1" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.setPropertyHalListener()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalserviceonhalevents" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.onHalEvents()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalhandleonpropertyevent" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.handleOnPropertyEvent()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalpriorityinit" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.priorityInit()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#carpropertyserviceonpropertychange" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService.onPropertyChange()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#carpropertymanager" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyManager 监听属性事件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CarPropertyManager 监听属性事件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#carpropertyserviceregisterlistener" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService.registerListener()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subscriptionmanager" class="md-nav__link">
    <span class="md-ellipsis">
      SubscriptionManager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subscriptionmanagerstagenewoptions" class="md-nav__link">
    <span class="md-ellipsis">
      SubscriptionManager.stageNewOptions()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#carpropertyserviceapplystagedchangeslocked" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService.applyStagedChangesLocked()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subscriptionmanagerdiffbetweencurrentandstage" class="md-nav__link">
    <span class="md-ellipsis">
      SubscriptionManager.diffBetweenCurrentAndStage()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalservicesubscribeproperty" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.subscribeProperty()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PropertyHalService.subscribeProperty()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#propertyhalserviceupdatesubscriptionratelocked" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.updateSubscriptionRateLocked()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalserviceunsubscribeproperty" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.unsubscribeProperty()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PropertyHalService.unsubscribeProperty()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#subscriptionmanagerstageunregister" class="md-nav__link">
    <span class="md-ellipsis">
      SubscriptionManager.stageUnregister()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subscriptionmanagercommit" class="md-nav__link">
    <span class="md-ellipsis">
      SubscriptionManager.commit()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      设置属性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="设置属性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#carpropertyservicesetproperty" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService.setProperty()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalservicesetproperty" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.setProperty()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalset" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.set()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aidlvehiclestubset" class="md-nav__link">
    <span class="md-ellipsis">
      AidlVehicleStub.set()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      获取属性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="获取属性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#carpropertyservicegetproperty" class="md-nav__link">
    <span class="md-ellipsis">
      CarPropertyService.getProperty()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propertyhalservicegetproperty" class="md-nav__link">
    <span class="md-ellipsis">
      PropertyHalService.getProperty()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalget" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.get()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aidlvehiclestubget" class="md-nav__link">
    <span class="md-ellipsis">
      AidlVehicleStub.get()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      后话
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

<nav class="md-tags" >
  
    
    
      
      
    
    
      <span class="md-tag md-tag-icon">Android</span>
    
  
    
    
      
      
    
    
      <span class="md-tag md-tag-icon">car</span>
    
  
    
    
      
      
    
    
      <span class="md-tag md-tag-icon">CarService</span>
    
  
    
    
      
      
    
    
      <span class="md-tag md-tag-icon">CarPropertyService</span>
    
  
</nav>


  
    <a href="https://github.com/i-rtfsc/note/edit/main/docs/Android/car/CarService/Android 15 CarService源码09-CarPropertyService.md" title="编辑此页" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  


<h1>Android 15 CarService源码09-CarPropertyService</h1>

<h2 id="_1">前言<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>在 <a href="../car-property-manager/">Android 15 CarService源码08-CarPropertyService之接口</a> 分析了客户端如何通过 CarPropertyManager 跟 CarPropertyService，接下来我们继续分析 CarPropertyService 的初始化流程。</p>
<h2 id="_2">初始化<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>根据 <a href="../init-service/">Android 15 CarService源码02-服务初始化</a> 的分析，CarService 服务的初始化过程实际上包括以下几个步骤：</p>
<ul>
<li>
<p><strong>Native服务的初始化</strong>：</p>
<ul>
<li>首先，构建每个 <code>HalService</code> 实例。</li>
<li>然后，调用 <code>HalService</code> 的 <code>takeProperties()</code> 方法。</li>
<li>接着，调用 <code>HalService</code> 的 <code>init()</code> 方法。</li>
</ul>
</li>
<li>
<p><strong>Java服务的初始化</strong>：</p>
<ul>
<li>构建每个 <code>CarSystemService</code> 实例。</li>
<li>调用 <code>CarSystemService</code> 的 <code>init()</code> 方法。</li>
<li>最后，调用 <code>CarSystemService</code> 的 <code>onInitComplete()</code> 方法。</li>
</ul>
</li>
</ul>
<p>接下来，我们将按照这个思路，从 <code>PropertyHalService</code> 开始进行分析。</p>
<h3 id="propertyhalservice">PropertyHalService<a class="headerlink" href="#propertyhalservice" title="Permanent link">&para;</a></h3>
<h4 id="propertyhalservice_1">PropertyHalService构造函数<a class="headerlink" href="#propertyhalservice_1" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/PropertyHalService.java</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="cm">/**</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="cm"> * 该类是一个HAL服务的公共接口类，用于通过ICarProperty来传输车辆属性。</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="cm"> * 所有通过ICarProperty来进行车辆属性传递的服务应该继承该类。</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="cm"> * 该类属于HAL（硬件抽象层）服务的一部分。</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="cm"> */</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PropertyHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="c1">// 车辆硬件抽象层的接口实例，负责与底层硬件通信</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">VehicleHal</span><span class="w"> </span><span class="n">mVehicleHal</span><span class="p">;</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">    </span><span class="c1">// 用于构建Hal属性值的辅助工具类，负责创建和管理车辆属性值</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">HalPropValueBuilder</span><span class="w"> </span><span class="n">mPropValueBuilder</span><span class="p">;</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="cm">     * 构造函数，初始化PropertyHalService实例。</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="cm">     * </span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="cm">     * @param vehicleHal 车辆硬件抽象层接口的实例，提供与硬件层的交互。</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="cm">     */</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">PropertyHalService</span><span class="p">(</span><span class="n">VehicleHal</span><span class="w"> </span><span class="n">vehicleHal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">        </span><span class="c1">// 初始化 mVehicleHal 为传入的 vehicleHal 实例</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="w">        </span><span class="n">mVehicleHal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vehicleHal</span><span class="p">;</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">        </span><span class="c1">// 如果启用了调试模式，则输出服务启动的日志</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="w">            </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;started PropertyHalService&quot;</span><span class="p">);</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="w">        </span><span class="c1">// 获取用于构建属性值的工具类实例</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="w">        </span><span class="n">mPropValueBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vehicleHal</span><span class="p">.</span><span class="na">getHalPropValueBuilder</span><span class="p">();</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>PropertyHalService</code> 是一个继承自 <code>HalServiceBase</code> 的服务类，专门用于通过 <code>ICarProperty</code> 接口传输车辆属性。它负责初始化与车辆硬件的通信接口（<code>VehicleHal</code>）并提供构建车辆属性值的工具（<code>HalPropValueBuilder</code>）。</p>
<h5 id="vehiclehalgethalpropvaluebuilder">VehicleHal.getHalPropValueBuilder()<a class="headerlink" href="#vehiclehalgethalpropvaluebuilder" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/VehicleHal.java</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="cm">/**</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="cm"> * 车辆硬件抽象层（Vehicle HAL）的抽象类。</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="cm"> * 该类处理与原生 HAL 的接口，并对接收到的数据进行基本的解析（如类型检查）。</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="cm"> * 然后，每个事件会被发送到相应的 {@link HalServiceBase} 实现中。</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="cm"> * {@link HalServiceBase} 负责将数据转换为对应的 Car*Service 供 Car*Manager API 使用。</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="cm"> */</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VehicleHal</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">VehicleHalCallback</span><span class="p">,</span><span class="w"> </span><span class="n">CarSystemService</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="c1">// 用于构建车辆属性值的工具类实例</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">HalPropValueBuilder</span><span class="w"> </span><span class="n">mPropValueBuilder</span><span class="p">;</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="cm">     * 获取 Hal 属性值构建器的实例。</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="cm">     * </span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="cm">     * @return 返回 HalPropValueBuilder 实例</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="cm">     */</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">HalPropValueBuilder</span><span class="w"> </span><span class="nf">getHalPropValueBuilder</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mPropValueBuilder</span><span class="p">;</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="cm">     * 构造函数，初始化 VehicleHal 实例。</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="cm">     * </span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="cm">     * @param vehicle 车辆实例，用于获取 HAL 属性值构建器</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="cm">     */</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="w">    </span><span class="n">VehicleHal</span><span class="p">(...</span><span class="w"> </span><span class="n">VehicleStub</span><span class="w"> </span><span class="n">vehicle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="w">        </span><span class="c1">// 必须在 HalService 初始化之前完成初始化，以便 HalService 使用该实例</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="w">        </span><span class="n">mPropValueBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vehicle</span><span class="p">.</span><span class="na">getHalPropValueBuilder</span><span class="p">();</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>VehicleHal</code> 类是一个车辆硬件抽象层（HAL）的实现，它与底层的原生 HAL 进行交互，接收数据并进行基本的解析，然后将解析后的事件交给相应的 <code>HalServiceBase</code> 实现来处理。<code>HalServiceBase</code> 的责任是将数据转换为具体的 <code>Car*Service</code>，供 <code>Car*Manager API</code> 使用。这个类的核心职责是提供与车辆硬件的交互接口，并帮助构建属性值。</p>
<h5 id="aidlvehiclestubgethalpropvaluebuilder">AidlVehicleStub.getHalPropValueBuilder()<a class="headerlink" href="#aidlvehiclestubgethalpropvaluebuilder" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/AidlVehicleStub.java</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AidlVehicleStub</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">VehicleStub</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="cm">     * 获取一个 HalPropValueBuilder，用于构建 HalPropValue。</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="cm">     * </span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="cm">     * @return 返回一个构建 HalPropValue 的构建器实例。</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="cm">     */</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">HalPropValueBuilder</span><span class="w"> </span><span class="nf">getHalPropValueBuilder</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mPropValueBuilder</span><span class="p">;</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="cm">     * AidlVehicleStub 的构造函数，初始化 AidlVehicleStub 实例。</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="cm">     * </span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="cm">     * @param aidlVehicle AIDL 接口实例，用于与底层车辆硬件进行交互。</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="cm">     * @param handlerThread 用于处理异步任务的线程。</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="cm">     */</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">    </span><span class="nd">@VisibleForTesting</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">    </span><span class="n">AidlVehicleStub</span><span class="p">(</span><span class="n">IVehicle</span><span class="w"> </span><span class="n">aidlVehicle</span><span class="p">,</span><span class="w"> </span><span class="n">HandlerThread</span><span class="w"> </span><span class="n">handlerThread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">        </span><span class="n">mAidlVehicle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aidlVehicle</span><span class="p">;</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">        </span><span class="c1">// 使用传入的参数初始化 HalPropValueBuilder，isAidl 标志为 true，表示这是一个 AIDL 实现。</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">        </span><span class="n">mPropValueBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HalPropValueBuilder</span><span class="p">(</span><span class="cm">/*isAidl=*/</span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>AidlVehicleStub</code> 类是 <code>VehicleStub</code> 类的子类，专门用于实现通过 AIDL 进行的车辆硬件交互。它重写了 <code>getHalPropValueBuilder()</code> 方法来返回一个构建 <code>HalPropValue</code> 的构建器实例。构造函数用于初始化与 AIDL 接口交互的相关实例（如 <code>IVehicle</code>）并配置一个用于构建属性值的构建器 (<code>HalPropValueBuilder</code>)。<code>mPropValueBuilder</code> 的初始化时传入 <code>isAidl=true</code>，表明它是 AIDL 特定的实现。</p>
<h4 id="propertyhalservicetakeproperties">PropertyHalService.takeProperties()<a class="headerlink" href="#propertyhalservicetakeproperties" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/PropertyHalService.java</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PropertyHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="c1">// 该方法在 HAL 的初始化过程中调用。避免在此处处理复杂的操作。</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">takeProperties</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">HalPropConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">halPropConfigs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">        </span><span class="c1">// 遍历所有传入的属性配置</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">HalPropConfig</span><span class="w"> </span><span class="n">halPropConfig</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">halPropConfigs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">            </span><span class="c1">// 获取当前属性的 ID</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">halPropId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">halPropConfig</span><span class="p">.</span><span class="na">getPropId</span><span class="p">();</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">            </span><span class="c1">// 检查该属性是否是支持的</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isSupportedProperty</span><span class="p">(</span><span class="n">halPropId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">                </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">                    </span><span class="c1">// 如果该属性是支持的，存储该属性配置到哈希映射中</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">                    </span><span class="n">mHalPropIdToPropConfig</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">halPropId</span><span class="p">,</span><span class="w"> </span><span class="n">halPropConfig</span><span class="p">);</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="w">                    </span><span class="c1">// 如果调试模式开启，打印日志，记录已接收并支持的属性</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="w">                    </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;takeSupportedProperties: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">halPropIdToName</span><span class="p">(</span><span class="n">halPropId</span><span class="p">));</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="w">                </span><span class="c1">// 如果该属性不被支持，打印日志，记录忽略该属性的情况</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="w">                    </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;takeProperties: Property: %s is not supported, ignore&quot;</span><span class="p">,</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="w">                            </span><span class="n">halPropIdToName</span><span class="p">(</span><span class="n">halPropId</span><span class="p">));</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="w">        </span><span class="c1">// 如果调试模式开启，打印总共处理的属性数量</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="w">            </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;takeSupportedProperties() took %d properties&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">halPropConfigs</span><span class="p">.</span><span class="na">size</span><span class="p">());</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a><span class="w">        </span><span class="c1">// 检查车辆 HAL 是否支持选择供应商属性的权限</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a><span class="w">        </span><span class="n">HalPropConfig</span><span class="w"> </span><span class="n">customizePermission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mVehicleHal</span><span class="p">.</span><span class="na">getPropConfig</span><span class="p">(</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a><span class="w">                </span><span class="n">VehicleProperty</span><span class="p">.</span><span class="na">SUPPORT_CUSTOMIZE_VENDOR_PERMISSION</span><span class="p">);</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">customizePermission</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a><span class="w">            </span><span class="c1">// 如果支持，定制供应商权限</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a><span class="w">            </span><span class="n">mPropertyHalServiceConfigs</span><span class="p">.</span><span class="na">customizeVendorPermission</span><span class="p">(</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a><span class="w">                    </span><span class="n">customizePermission</span><span class="p">.</span><span class="na">getConfigArray</span><span class="p">());</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a><span class="w">            </span><span class="c1">// 如果不支持，打印日志</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a><span class="w">                </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;No custom vendor permission defined in VHAL&quot;</span><span class="p">);</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a><span class="p">}</span>
</span></code></pre></div>
<p>我们在回顾一下 <code>takeProperties()</code> 是在 <code>VehicleHal.priorityInit()</code> 调用的，在 <a href="../init-service/">Android 15 CarService源码02-服务初始化</a> 有分析。
在这个例子中<code>PropertyHalService</code> 中传进来的 <code>halPropConfigs</code> 比较特殊。其大致代码如下：</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VehicleHal</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">VehicleHalCallback</span><span class="p">,</span><span class="w"> </span><span class="n">CarSystemService</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">priorityInit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">        </span><span class="c1">// 获取所有属性配置。  </span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">        </span><span class="n">fetchAllPropConfigs</span><span class="p">();</span><span class="w">  </span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mAllServices</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">                </span><span class="c1">// 获取服务支持的所有属性。  </span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">                </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">supportedProps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">service</span><span class="p">.</span><span class="na">getAllSupportedProperties</span><span class="p">();</span><span class="w">  </span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">supportedProps</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">                    </span><span class="p">...</span><span class="w">  </span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">                    </span><span class="c1">// 如果服务有明确支持的属性，只处理这些属性。  </span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">prop</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">supportedProps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">                        </span><span class="n">HalPropConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mAllProperties</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">                            </span><span class="k">continue</span><span class="p">;</span><span class="w">  </span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">                        </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="w">                        </span><span class="c1">// 将属性处理程序与服务关联。  </span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="w">                        </span><span class="n">mPropertyHandlers</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="w">                        </span><span class="c1">// 将属性配置添加到服务的配置列表中。  </span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="w">                        </span><span class="n">configsForService</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">config</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="w">                    </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="w">                </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="w">            </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="w">        </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="w">        </span><span class="c1">// 初始化每个服务并传递其属性配置。  </span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">HalServiceBase</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">HalPropConfig</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">entry</span><span class="w">  </span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="n">configsForAllServices</span><span class="p">.</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a><span class="w">            </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">();</span><span class="w">  </span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a><span class="w">            </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">HalPropConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">configsForService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">();</span><span class="w">  </span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a><span class="w">            </span><span class="c1">// 让服务接管其属性配置。  </span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a><span class="w">            </span><span class="n">service</span><span class="p">.</span><span class="na">takeProperties</span><span class="p">(</span><span class="n">configsForService</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a><span class="w">            </span><span class="c1">// 初始化服务。  </span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a><span class="w">            </span><span class="n">service</span><span class="p">.</span><span class="na">init</span><span class="p">();</span><span class="w">  </span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a><span class="w">        </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a><span class="w">    </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a><span class="p">}</span>
</span></code></pre></div>
<p>因为 <code>service.getAllSupportedProperties()</code> 也就是调用 <code>PropertyHalService.getAllSupportedProperties()</code> 得到是空的，所有是走else流程。那么这里传进来的 <code>takeProperties(Collection&lt;HalPropConfig&gt; halPropConfigs)</code> 其实就是从 <code>IVehicle.getAllPropConfigs()</code> 得到的。</p>
<p>回到 <code>PropertyHalService.takeProperties()</code> 中：</p>
<ul>
<li>检查是否支持该属性：<code>isSupportedProperty(halPropId)</code> ，支持的属性会被存储在一个哈希映射（<code>mHalPropIdToPropConfig</code>）中，映射的键是属性 ID，值是该属性的配置。</li>
<li>检查是否支持定制的供应商权限：通过调用 <code>mVehicleHal.getPropConfig()</code> 获取特定的车辆属性配置，判断车辆 HAL 是否支持定制的供应商权限（<code>SUPPORT_CUSTOMIZE_VENDOR_PERMISSION</code>）。</li>
</ul>
<h5 id="propertyhalserviceissupportedproperty">PropertyHalService.isSupportedProperty()<a class="headerlink" href="#propertyhalserviceissupportedproperty" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/PropertyHalService.java</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PropertyHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="c1">// 该字段用于存储 PropertyHalServiceConfigs 实例，该实例包含了与 PropertyHalService 配置相关的信息</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">PropertyHalServiceConfigs</span><span class="w"> </span><span class="n">mPropertyHalServiceConfigs</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">            </span><span class="n">PropertyHalServiceConfigs</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="cm">     * 判断指定的车辆属性是否被支持。</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="cm">     * </span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="cm">     * @param halPropId 车辆属性的 ID</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="cm">     * @return 如果该属性被支持，返回 true；否则返回 false</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="cm">     */</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isSupportedProperty</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">halPropId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">        </span><span class="c1">// 首先检查该属性是否在 PropertyHalServiceConfigs 中被支持，</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">        </span><span class="c1">// 其次再检查该属性是否在 CarPropertyHelper 中被支持，最终决定该属性是否被支持</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mPropertyHalServiceConfigs</span><span class="p">.</span><span class="na">isSupportedProperty</span><span class="p">(</span><span class="n">halPropId</span><span class="p">)</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">CarPropertyHelper</span><span class="p">.</span><span class="na">isSupported</span><span class="p">(</span><span class="n">halToManagerPropId</span><span class="p">(</span><span class="n">halPropId</span><span class="p">));</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>调用 <code>mPropertyHalServiceConfigs</code> 实例的 <code>isSupportedProperty()</code> 方法，检查该属性 ID 是否在配置中被支持。</li>
<li>调用 <code>CarPropertyHelper</code> 类的 <code>isSupported()</code> 方法，进一步判断该属性是否被车辆管理层支持。需要注意的是，<code>halToManagerPropId()</code> 方法是将 HAL 属性 ID 转换为车辆管理层使用的属性 ID，涉及到不同层次之间的属性映射。</li>
</ul>
<h5 id="propertyhalserviceconfigsissupportedproperty">PropertyHalServiceConfigs.isSupportedProperty()<a class="headerlink" href="#propertyhalserviceconfigsissupportedproperty" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/property/PropertyHalServiceConfigs.java</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PropertyHalServiceConfigs</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="cm">     * 判断属性 ID 是否在 PropertyHalService 所关心的已知属性列表中。</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="cm">     * </span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="cm">     * @param propId 车辆属性的 ID</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="cm">     * @return 如果该属性 ID 是 PropertyHalService 所关心的属性，返回 true；否则返回 false</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="cm">     */</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isSupportedProperty</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">propId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">        </span><span class="c1">// 检查属性 ID 是否存在于 mHalPropIdToCarSvcConfig 映射中，</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">        </span><span class="c1">// 如果存在，表示该属性是 PropertyHalService 所关心的已知属性。</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">        </span><span class="c1">// 或者检查该属性 ID 是否是厂商自定义或回溯的属性。</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mHalPropIdToCarSvcConfig</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">propId</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">CarPropertyHelper</span><span class="p">.</span><span class="na">isVendorOrBackportedProperty</span><span class="p">(</span><span class="n">propId</span><span class="p">);</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>PropertyHalServiceConfigs</code> 类提供了一种机制来判断 <code>PropertyHalService</code> 是否支持某个特定的车辆属性。它通过检查属性 ID 是否在 <code>CarSvcProps.json</code> 配置中。</p>
<p>这里如果深入去分析，发现 <strong>属性是否被支持</strong> 涉及到了很多内容，笔者实际上也做过这个模块，就不深入去分析了。
但我们可以预留一个 TODO ， 如果后续有需求可以再继续深入。</p>
<h4 id="propertyhalserviceinit">PropertyHalService.init()<a class="headerlink" href="#propertyhalserviceinit" title="Permanent link">&para;</a></h4>
<p>这里的 <code>init()</code> 函数不做任何操作。</p>
<h4 id="propertyhalservicegetallsupportedproperties">PropertyHalService.getAllSupportedProperties()<a class="headerlink" href="#propertyhalservicegetallsupportedproperties" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/PropertyHalService.java</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PropertyHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span><span class="w">      </span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="nf">getAllSupportedProperties</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">EMPTY_INT_ARRAY</span><span class="p">;</span><span class="w">  </span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="p">}</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CommonConstants</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">EMPTY_INT_ARRAY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">;</span><span class="w">  </span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="p">}</span>
</span></code></pre></div>
<p>在 <code>PropertyHalService.takeProperties()</code> 我们讲过 <code>getAllSupportedProperties()</code> 获取到的是空的。</p>
<h3 id="carpropertyservice">CarPropertyService<a class="headerlink" href="#carpropertyservice" title="Permanent link">&para;</a></h3>
<h4 id="carpropertyservice_1">CarPropertyService构造函数<a class="headerlink" href="#carpropertyservice_1" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/CarPropertyService.java</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CarPropertyService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ICarProperty</span><span class="p">.</span><span class="na">Stub</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">CarServiceBase</span><span class="p">,</span><span class="w"> </span><span class="n">PropertyHalService</span><span class="p">.</span><span class="na">PropertyHalListener</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="c1">// 构造函数，使用 Builder 模式构造 CarPropertyService 对象</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="nf">CarPropertyService</span><span class="p">(</span><span class="n">Builder</span><span class="w"> </span><span class="n">builder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">        </span><span class="c1">// 如果调试模式开启，打印服务启动的日志信息</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">            </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;CarPropertyService started!&quot;</span><span class="p">);</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">        </span><span class="c1">// 使用 builder 来初始化成员变量</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">        </span><span class="n">mPropertyHalService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Objects</span><span class="p">.</span><span class="na">requireNonNull</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="na">mPropertyHalService</span><span class="p">);</span><span class="w"> </span><span class="c1">// 必须传入 PropertyHalService 对象</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">        </span><span class="n">mContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Objects</span><span class="p">.</span><span class="na">requireNonNull</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="na">mContext</span><span class="p">);</span><span class="w"> </span><span class="c1">// 必须传入 Context 对象</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">        </span><span class="c1">// 如果 FeatureFlags 未提供，则使用默认实现 FeatureFlagsImpl</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">        </span><span class="n">mFeatureFlags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Objects</span><span class="p">.</span><span class="na">requireNonNullElseGet</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="na">mFeatureFlags</span><span class="p">,</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">                </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FeatureFlagsImpl</span><span class="p">());</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">        </span><span class="c1">// 如果 HistogramFactory 未提供，则使用默认实现 SystemHistogramFactory</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="w">        </span><span class="n">mHistogramFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Objects</span><span class="p">.</span><span class="na">requireNonNullElseGet</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="na">mHistogramFactory</span><span class="p">,</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">                </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SystemHistogramFactory</span><span class="p">());</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="w">        </span><span class="c1">// 初始化直方图（Histogram），这通常用于统计服务运行中的性能数据</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">        </span><span class="n">initializeHistogram</span><span class="p">();</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>CarPropertyService</code> 继承自 <code>ICarProperty.Stub</code>。<code>ICarProperty</code> 是一个用于管理和操作车辆属性（如车辆信息、状态等）的 AIDL 接口。</p>
<p>实现 <code>PropertyHalService.PropertyHalListener</code> 接口，监听来自 <code>PropertyHalService</code> 的回调事件。</p>
<p>其构造函数函数比较简单，就不深入分析了。</p>
<h4 id="carpropertyserviceinit">CarPropertyService.init()<a class="headerlink" href="#carpropertyserviceinit" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/CarPropertyService.java</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CarPropertyService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ICarProperty</span><span class="p">.</span><span class="na">Stub</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">CarServiceBase</span><span class="p">,</span><span class="w"> </span><span class="n">PropertyHalService</span><span class="p">.</span><span class="na">PropertyHalListener</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="cm">     * 初始化方法。</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="cm">     * 该方法在 CarPropertyService 启动时被调用，用于缓存车辆属性配置列表，</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="cm">     * 并设置 PropertyHalService 的回调监听器。</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="cm">     */</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">        </span><span class="c1">// 加锁确保线程安全，避免并发问题</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">            </span><span class="c1">// 从 PropertyHalService 获取车辆属性列表并缓存</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">            </span><span class="c1">// 目的是避免后续的 binder 调用来获取属性列表，减少性能开销</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">            </span><span class="n">mPropertyIdToCarPropertyConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPropertyHalService</span><span class="p">.</span><span class="na">getPropertyList</span><span class="p">();</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">            </span><span class="c1">// 如果调试模式开启，打印缓存的车辆属性配置列表的大小</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="w">                </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cache CarPropertyConfigs &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mPropertyIdToCarPropertyConfig</span><span class="p">.</span><span class="na">size</span><span class="p">());</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="w">        </span><span class="c1">// 设置 PropertyHalService 的回调监听器为当前类（this），用于监听来自 PropertyHalService 的事件</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="w">        </span><span class="n">mPropertyHalService</span><span class="p">.</span><span class="na">setPropertyHalListener</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>获取车辆属性列表：<code>mPropertyHalService.getPropertyList()</code> 用于从 <code>PropertyHalService</code> 获取车辆属性的列表。该列表包含了每个车辆属性的配置信息，比如属性 ID 和相关配置。</li>
<li>设置回调监听器：调用 <code>mPropertyHalService.setPropertyHalListener(this)</code>，将当前的 <code>CarPropertyService</code> 实例作为监听器（回调）。这样，<code>PropertyHalService</code> 在有更新的车辆属性时，可以通知 <code>CarPropertyService</code>，从而实现监听车辆属性的变化。</li>
</ul>
<h5 id="propertyhalservicegetpropertylist">PropertyHalService.getPropertyList()<a class="headerlink" href="#propertyhalservicegetpropertylist" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/PropertyHalService.java</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PropertyHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="cm">     * 获取所有车辆属性的配置信息。</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="cm">     *</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="cm">     * @return SparseArray&lt;CarPropertyConfig&gt; 车辆属性配置列表，其中每个条目是一个车辆属性 ID 和对应的配置。</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="cm">     */</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SparseArray</span><span class="o">&lt;</span><span class="n">CarPropertyConfig</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="nf">getPropertyList</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">        </span><span class="c1">// 如果调试模式开启，打印日志信息，表明正在调用 getPropertyList 方法</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">            </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;getPropertyList&quot;</span><span class="p">);</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">        </span><span class="c1">// 使用同步块，确保线程安全，避免并发访问共享资源出现问题</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="w">            </span><span class="c1">// 创建一个 SparseArray 存储转换后的车辆属性配置</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">            </span><span class="n">SparseArray</span><span class="o">&lt;</span><span class="n">CarPropertyConfig</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">mgrPropIdToCarPropConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SparseArray</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w">            </span><span class="c1">// 遍历所有 HAL 属性配置列表（mHalPropIdToPropConfig），将每个配置转换为车辆属性配置</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mHalPropIdToPropConfig</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="w">                </span><span class="c1">// 获取 HAL 属性配置对象</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="w">                </span><span class="n">HalPropConfig</span><span class="w"> </span><span class="n">halPropConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mHalPropIdToPropConfig</span><span class="p">.</span><span class="na">valueAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="w">                </span><span class="c1">// 将 HAL 属性的属性 ID 转换为管理器级别的属性 ID</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">mgrPropId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">halToManagerPropId</span><span class="p">(</span><span class="n">halPropConfig</span><span class="p">.</span><span class="na">getPropId</span><span class="p">());</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="w">                </span><span class="c1">// 使用 halPropConfig 对象来生成对应的车辆属性配置对象（CarPropertyConfig）</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="w">                </span><span class="n">CarPropertyConfig</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">carPropertyConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">halPropConfig</span><span class="p">.</span><span class="na">toCarPropertyConfig</span><span class="p">(</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="w">                        </span><span class="n">mgrPropId</span><span class="p">,</span><span class="w"> </span><span class="n">mPropertyHalServiceConfigs</span><span class="p">);</span>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a><span class="w">                </span><span class="c1">// 将转换后的车辆属性配置放入到 SparseArray 中，键是管理器级别的属性 ID，值是对应的车辆属性配置</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a><span class="w">                </span><span class="n">mgrPropIdToCarPropConfig</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">mgrPropId</span><span class="p">,</span><span class="w"> </span><span class="n">carPropertyConfig</span><span class="p">);</span>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a><span class="w">            </span><span class="c1">// 返回车辆属性配置列表</span>
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">mgrPropIdToCarPropConfig</span><span class="p">;</span>
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a><span class="p">}</span>
</span></code></pre></div>
<p>首先，这里的 <code>mHalPropIdToPropConfig</code> 就是前面 <code>PropertyHalService.takeProperties()</code> 存储的所有属性。</p>
<p><code>getPropertyList()</code> 方法主要作用是从 <code>PropertyHalService</code> 中获取所有的车辆属性配置，转换为适合 <code>Manager</code> 使用的配置格式，并将它们存储在一个 <code>SparseArray</code> 中返回。该方法通过遍历 HAL 属性配置列表，将每个属性配置转换为 <code>Manager</code> 所需的车辆属性配置对象，并以管理器级属性 ID 为键，将配置对象存储在 <code>SparseArray</code> 中，最后返回。为了保证线程安全，方法内部采用了 <code>synchronized</code> 锁。</p>
<h5 id="propertyhalservicesetpropertyhallistener">PropertyHalService.setPropertyHalListener()<a class="headerlink" href="#propertyhalservicesetpropertyhallistener" title="Permanent link">&para;</a></h5>
<p>调用<code>mPropertyHalService.setPropertyHalListener(this)</code>，将当前的 <code>CarPropertyService</code> 实例作为监听器（回调）。这样，<code>PropertyHalService</code> 在有更新的车辆属性时，可以通知 <code>CarPropertyService</code>，从而实现监听车辆属性的变化。这里不详细分析，后续在回调章节中再详细分析。</p>
<h4 id="carpropertyserviceoninitcomplete">CarPropertyService.onInitComplete()<a class="headerlink" href="#carpropertyserviceoninitcomplete" title="Permanent link">&para;</a></h4>
<p>这里的 <code>CarPropertyService</code> 不重写 <code>CarSystemService.onInitComplete()</code> 方法而直接使用默认实现。</p>
<h2 id="_3">属性事件回调<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>在 <a href="../carservice-call-vhal/">Android 15 CarService源码04-CarService与Vehicle HAL交互</a> 中，我们知道了 <code>CarService</code> 接收 <code>Vehicle HAL</code> 的回调，主要事件流如下：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>IVehicleCallback.onPropertyEvent<span class="o">()</span><span class="w"> </span>//<span class="w"> </span>AidlSubscriptionClient
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span>---&gt;<span class="w"> </span>AidlVehicleStub.onPropertyEvent<span class="o">()</span><span class="w">  </span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">        </span>---&gt;<span class="w"> </span>VehicleHal.onPropertyEvent<span class="o">()</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">            </span>---&gt;<span class="w"> </span>VehicleHal.handleOnPropertyEvent<span class="o">()</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">                </span>---&gt;<span class="w"> </span>PropertyHalService.onHalEvents<span class="o">()</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">                    </span>---&gt;<span class="w"> </span>CarPropertyService.onPropertyChange<span class="o">()</span>
</span></code></pre></div>
<p>现在我们就从 <code>CarPropertyService</code> 监听属性事件开始分析，并且从 <code>PropertyHalService.onHalEvents()</code> 倒序分析到 <code>VehicleHal.onPropertyEvent()</code> 。</p>
<h3 id="carpropertyservice_2">CarPropertyService 监听属性事件<a class="headerlink" href="#carpropertyservice_2" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/CarPropertyService.java</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CarPropertyService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ICarProperty</span><span class="p">.</span><span class="na">Stub</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">CarServiceBase</span><span class="p">,</span><span class="w"> </span><span class="n">PropertyHalService</span><span class="p">.</span><span class="na">PropertyHalListener</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">        </span><span class="c1">// 设置 PropertyHalService 的回调监听器为当前类（this），用于监听来自 PropertyHalService 的事件</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">        </span><span class="n">mPropertyHalService</span><span class="p">.</span><span class="na">setPropertyHalListener</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="propertyhalservicesetpropertyhallistener_1">PropertyHalService.setPropertyHalListener()<a class="headerlink" href="#propertyhalservicesetpropertyhallistener_1" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/PropertyHalService.java</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PropertyHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="c1">// 使用锁来保证线程安全，保护 mPropertyHalListener 的访问</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="nd">@GuardedBy</span><span class="p">(</span><span class="s">&quot;mLock&quot;</span><span class="p">)</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">PropertyHalListener</span><span class="w"> </span><span class="n">mPropertyHalListener</span><span class="p">;</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="cm">     * 设置 HAL 服务的监听器</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="cm">     * </span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="cm">     * @param propertyHalListener 用于监听属性变化和属性设置错误的监听器</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="cm">     */</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setPropertyHalListener</span><span class="p">(</span><span class="n">PropertyHalListener</span><span class="w"> </span><span class="n">propertyHalListener</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="w">        </span><span class="c1">// 使用同步锁来确保线程安全</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">            </span><span class="c1">// 设置监听器</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="w">            </span><span class="n">mPropertyHalListener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">propertyHalListener</span><span class="p">;</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>mPropertyHalListener</code> 是一个类型为 <code>PropertyHalListener</code> 的成员变量，用来存储监听器实例。这个监听器主要用于接收车辆属性的变化事件和属性设置错误事件（具体的事件由 <code>onPropertyChange</code> 和 <code>onPropertySetError</code> 方法处理）。</p>
<p>我们看下 <code>PropertyHalListener</code> ：</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/PropertyHalService.java</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PropertyHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="cm">     * PropertyHalListener 接口用于将事件发送给 CarPropertyService</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="cm">     */</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">PropertyHalListener</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">        </span><span class="cm">/**</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="cm">         * 当车辆属性值更新时，调用此方法通知 CarPropertyService</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="cm">         *</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="cm">         * @param events 车辆属性事件列表，包含了所有属性的更新事件</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="cm">         */</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">onPropertyChange</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">CarPropertyEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events</span><span class="p">);</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="w">        </span><span class="cm">/**</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="cm">         * 当设置车辆属性失败时，调用此方法进行错误通知</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="cm">         *</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="cm">         * @param property 失败的属性 ID，表示哪个属性的设置失败</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="cm">         * @param area 设置失败的区域，可能是车内外不同区域的区分</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="cm">         * @param errorCode 错误码，标识设置失败的原因</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="cm">         *                  使用 @CarSetPropertyErrorCode 标注，具体值由车载系统定义</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="cm">         */</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">onPropertySetError</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">property</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">area</span><span class="p">,</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="w">                                </span><span class="nd">@CarSetPropertyErrorCode</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">errorCode</span><span class="p">);</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><code>onPropertyChange()</code> ：车辆属性值更新时被调用。<code>events</code> 参数是一个 <code>List&lt;CarPropertyEvent&gt;</code> 类型的列表，包含多个属性事件，每个事件对应一个车辆属性的更新。</li>
<li><code>onPropertySetError()</code> ：设置车辆属性时发生错误时回调通知。<ul>
<li><code>property</code>：表示哪个属性的设置失败，比如设置车速、油量、温度等属性时可能会失败。</li>
<li><code>area</code>：表示失败的区域或作用范围，可能涉及车内外不同区域的控制，例如设置车窗的温度，可能涉及到前后不同区域的设置失败。</li>
<li><code>errorCode</code>：表示错误的具体码，使用 <code>@CarSetPropertyErrorCode</code> 注解，定义了错误的类型，例如权限不足、设备异常等。具体的错误码由车载系统定义。</li>
</ul>
</li>
</ul>
<h4 id="propertyhalserviceonhalevents">PropertyHalService.onHalEvents()<a class="headerlink" href="#propertyhalserviceonhalevents" title="Permanent link">&para;</a></h4>
<p>现在我们来看 <code>PropertyHalService.onHalEvents()</code> 都做了什么。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/PropertyHalService.java</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PropertyHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="cm">     * 处理 HAL 事件，并将其转换为对应的 CarPropertyEvent 事件</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="cm">     * 该方法用于处理从硬件抽象层 (HAL) 收到的属性更新事件。</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="cm">     *</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="cm">     * @param halPropValues 从 HAL 收到的属性值列表</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="cm">     */</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onHalEvents</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">HalPropValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">halPropValues</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">        </span><span class="c1">// 用于存储需要分发的 CarPropertyEvent 事件列表</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">CarPropertyEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">eventsToDispatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">        </span><span class="c1">// 存储成功设置值的结果，这些值是目标值更新所导致的。</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">VehicleStubCallback</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">GetSetValueResultWrapper</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">callbackToSetValueResults</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="w">        </span><span class="c1">// 对 mLock 加锁，保证线程安全</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">            </span><span class="c1">// 遍历从 HAL 收到的所有 HalPropValue 事件</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">HalPropValue</span><span class="w"> </span><span class="n">halPropValue</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">halPropValues</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">halPropValue</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span><span class="w"> </span><span class="c1">// 如果事件为空，跳过</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a><span class="w">                </span><span class="c1">// 获取该属性的 ID</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">halPropId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">halPropValue</span><span class="p">.</span><span class="na">getPropId</span><span class="p">();</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a><span class="w">                </span><span class="c1">// 从配置中获取对应的 HalPropConfig</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a><span class="w">                </span><span class="n">HalPropConfig</span><span class="w"> </span><span class="n">halPropConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mHalPropIdToPropConfig</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">halPropId</span><span class="p">);</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">halPropConfig</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a><span class="w">                    </span><span class="c1">// 如果没有找到该属性的配置，说明该属性不被支持，忽略此事件</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a><span class="w">                    </span><span class="n">Slogf</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;onHalEvents - received HalPropValue for unsupported property: %s&quot;</span><span class="p">,</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a><span class="w">                            </span><span class="n">halPropIdToName</span><span class="p">(</span><span class="n">halPropId</span><span class="p">));</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a><span class="w">                </span><span class="c1">// 如果是 debug 版本，检查传递的 payload 是否有效</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BuildHelper</span><span class="p">.</span><span class="na">isDebuggableBuild</span><span class="p">()</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a><span class="w">                        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mPropertyHalServiceConfigs</span><span class="p">.</span><span class="na">checkPayload</span><span class="p">(</span><span class="n">halPropValue</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a><span class="w">                    </span><span class="c1">// 如果 payload 无效，丢弃此事件</span>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a><span class="w">                    </span><span class="n">Slogf</span><span class="p">.</span><span class="na">wtf</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a><span class="w">                            </span><span class="s">&quot;Drop event for property: %s because it is failed &quot;</span>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a><span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;in payload checking.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">halPropValue</span><span class="p">);</span>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>
</span><span id="__span-15-50"><a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a><span class="w">                </span><span class="c1">// 将 HAL 属性 ID 转换为Manager的属性 ID</span>
</span><span id="__span-15-51"><a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">mgrPropId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">halToManagerPropId</span><span class="p">(</span><span class="n">halPropId</span><span class="p">);</span>
</span><span id="__span-15-52"><a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a>
</span><span id="__span-15-53"><a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a><span class="w">                </span><span class="c1">// 如果日志级别为 DBG 且事件状态不是 &quot;AVAILABLE&quot; 状态，则输出日志</span>
</span><span id="__span-15-54"><a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">halPropValue</span><span class="p">.</span><span class="na">getStatus</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">VehiclePropertyStatus</span><span class="p">.</span><span class="na">AVAILABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-55"><a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a><span class="w">                    </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Received event %s with status that is not AVAILABLE&quot;</span><span class="p">,</span>
</span><span id="__span-15-56"><a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a><span class="w">                            </span><span class="n">halPropValue</span><span class="p">);</span>
</span><span id="__span-15-57"><a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-15-58"><a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a>
</span><span id="__span-15-59"><a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-60"><a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a><span class="w">                    </span><span class="c1">// 将 HalPropValue 转换为 CarPropertyValue，进行属性值封装</span>
</span><span id="__span-15-61"><a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a><span class="w">                    </span><span class="n">CarPropertyValue</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">carPropertyValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">halPropValue</span><span class="p">.</span><span class="na">toCarPropertyValue</span><span class="p">(</span>
</span><span id="__span-15-62"><a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a><span class="w">                            </span><span class="n">mgrPropId</span><span class="p">,</span><span class="w"> </span><span class="n">halPropConfig</span><span class="p">);</span>
</span><span id="__span-15-63"><a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a>
</span><span id="__span-15-64"><a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a><span class="w">                    </span><span class="c1">// 创建对应的 CarPropertyEvent 事件</span>
</span><span id="__span-15-65"><a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a><span class="w">                    </span><span class="n">CarPropertyEvent</span><span class="w"> </span><span class="n">carPropertyEvent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CarPropertyEvent</span><span class="p">(</span>
</span><span id="__span-15-66"><a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a><span class="w">                            </span><span class="n">CarPropertyEvent</span><span class="p">.</span><span class="na">PROPERTY_EVENT_PROPERTY_CHANGE</span><span class="p">,</span><span class="w"> </span><span class="n">carPropertyValue</span><span class="p">);</span>
</span><span id="__span-15-67"><a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a>
</span><span id="__span-15-68"><a id="__codelineno-15-68" name="__codelineno-15-68" href="#__codelineno-15-68"></a><span class="w">                    </span><span class="c1">// 将事件添加到待分发的事件列表中</span>
</span><span id="__span-15-69"><a id="__codelineno-15-69" name="__codelineno-15-69" href="#__codelineno-15-69"></a><span class="w">                    </span><span class="n">eventsToDispatch</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">carPropertyEvent</span><span class="p">);</span>
</span><span id="__span-15-70"><a id="__codelineno-15-70" name="__codelineno-15-70" href="#__codelineno-15-70"></a>
</span><span id="__span-15-71"><a id="__codelineno-15-71" name="__codelineno-15-71" href="#__codelineno-15-71"></a><span class="w">                    </span><span class="c1">// 检查是否有挂起的等待更新请求，更新它们</span>
</span><span id="__span-15-72"><a id="__codelineno-15-72" name="__codelineno-15-72" href="#__codelineno-15-72"></a><span class="w">                    </span><span class="n">checkPendingWaitForUpdateRequestsLocked</span><span class="p">(</span><span class="n">halPropId</span><span class="p">,</span><span class="w"> </span><span class="n">carPropertyValue</span><span class="p">,</span>
</span><span id="__span-15-73"><a id="__codelineno-15-73" name="__codelineno-15-73" href="#__codelineno-15-73"></a><span class="w">                            </span><span class="n">callbackToSetValueResults</span><span class="p">);</span>
</span><span id="__span-15-74"><a id="__codelineno-15-74" name="__codelineno-15-74" href="#__codelineno-15-74"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalStateException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-75"><a id="__codelineno-15-75" name="__codelineno-15-75" href="#__codelineno-15-75"></a><span class="w">                    </span><span class="c1">// 如果属性值无效，丢弃该事件</span>
</span><span id="__span-15-76"><a id="__codelineno-15-76" name="__codelineno-15-76" href="#__codelineno-15-76"></a><span class="w">                    </span><span class="n">Slogf</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Drop event %s that does not have valid value&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">halPropValue</span><span class="p">);</span>
</span><span id="__span-15-77"><a id="__codelineno-15-77" name="__codelineno-15-77" href="#__codelineno-15-77"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-15-78"><a id="__codelineno-15-78" name="__codelineno-15-78" href="#__codelineno-15-78"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-15-79"><a id="__codelineno-15-79" name="__codelineno-15-79" href="#__codelineno-15-79"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-15-80"><a id="__codelineno-15-80" name="__codelineno-15-80" href="#__codelineno-15-80"></a>
</span><span id="__span-15-81"><a id="__codelineno-15-81" name="__codelineno-15-81" href="#__codelineno-15-81"></a><span class="w">            </span><span class="c1">// 更新异步设置请求的订阅率</span>
</span><span id="__span-15-82"><a id="__codelineno-15-82" name="__codelineno-15-82" href="#__codelineno-15-82"></a><span class="w">            </span><span class="n">updateSubscriptionRateForAsyncSetRequestLocked</span><span class="p">();</span>
</span><span id="__span-15-83"><a id="__codelineno-15-83" name="__codelineno-15-83" href="#__codelineno-15-83"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-84"><a id="__codelineno-15-84" name="__codelineno-15-84" href="#__codelineno-15-84"></a>
</span><span id="__span-15-85"><a id="__codelineno-15-85" name="__codelineno-15-85" href="#__codelineno-15-85"></a><span class="w">        </span><span class="c1">// 获取 PropertyHalListener，以便分发事件</span>
</span><span id="__span-15-86"><a id="__codelineno-15-86" name="__codelineno-15-86" href="#__codelineno-15-86"></a><span class="w">        </span><span class="n">PropertyHalListener</span><span class="w"> </span><span class="n">propertyHalListener</span><span class="p">;</span>
</span><span id="__span-15-87"><a id="__codelineno-15-87" name="__codelineno-15-87" href="#__codelineno-15-87"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-88"><a id="__codelineno-15-88" name="__codelineno-15-88" href="#__codelineno-15-88"></a><span class="w">            </span><span class="n">propertyHalListener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPropertyHalListener</span><span class="p">;</span>
</span><span id="__span-15-89"><a id="__codelineno-15-89" name="__codelineno-15-89" href="#__codelineno-15-89"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-90"><a id="__codelineno-15-90" name="__codelineno-15-90" href="#__codelineno-15-90"></a>
</span><span id="__span-15-91"><a id="__codelineno-15-91" name="__codelineno-15-91" href="#__codelineno-15-91"></a><span class="w">        </span><span class="c1">// 如果有监听器，则调用其 onPropertyChange 方法分发事件</span>
</span><span id="__span-15-92"><a id="__codelineno-15-92" name="__codelineno-15-92" href="#__codelineno-15-92"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">propertyHalListener</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-93"><a id="__codelineno-15-93" name="__codelineno-15-93" href="#__codelineno-15-93"></a><span class="w">            </span><span class="n">propertyHalListener</span><span class="p">.</span><span class="na">onPropertyChange</span><span class="p">(</span><span class="n">eventsToDispatch</span><span class="p">);</span>
</span><span id="__span-15-94"><a id="__codelineno-15-94" name="__codelineno-15-94" href="#__codelineno-15-94"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-95"><a id="__codelineno-15-95" name="__codelineno-15-95" href="#__codelineno-15-95"></a>
</span><span id="__span-15-96"><a id="__codelineno-15-96" name="__codelineno-15-96" href="#__codelineno-15-96"></a><span class="w">        </span><span class="c1">// 分发设置值的结果给相应的回调</span>
</span><span id="__span-15-97"><a id="__codelineno-15-97" name="__codelineno-15-97" href="#__codelineno-15-97"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VehicleStubCallback</span><span class="w"> </span><span class="n">callback</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">callbackToSetValueResults</span><span class="p">.</span><span class="na">keySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-98"><a id="__codelineno-15-98" name="__codelineno-15-98" href="#__codelineno-15-98"></a><span class="w">            </span><span class="n">callback</span><span class="p">.</span><span class="na">sendSetValueResults</span><span class="p">(</span><span class="n">callbackToSetValueResults</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">callback</span><span class="p">));</span>
</span><span id="__span-15-99"><a id="__codelineno-15-99" name="__codelineno-15-99" href="#__codelineno-15-99"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-100"><a id="__codelineno-15-100" name="__codelineno-15-100" href="#__codelineno-15-100"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-101"><a id="__codelineno-15-101" name="__codelineno-15-101" href="#__codelineno-15-101"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><code>eventsToDispatch</code>：用来存储需要分发的 <code>CarPropertyEvent</code> 事件。</li>
<li>将 HAL 属性值 (<code>HalPropValue</code>) 转换为 <code>CarPropertyValue</code>，并将其封装为 <code>CarPropertyEvent</code>。</li>
<li><code>CarPropertyEvent</code> 表示一个属性的更新事件，并被添加到待分发的事件列表 <code>eventsToDispatch</code> 中。</li>
<li>通过 <code>checkPendingWaitForUpdateRequestsLocked()</code> 检查并更新任何挂起的等待更新的请求，确保所有的设置操作都得到正确的结果。</li>
<li>如果有设置监听器 (<code>PropertyHalListener</code>)，则通过该监听器分发处理好的事件。</li>
<li>对于每个 <code>VehicleStubCallback</code> 回调，发送相应的设置值结果。</li>
</ul>
<p>也就是说这里的 <code>mPropertyHalListener</code> 就是前面 <code>CarPropertyService.init()</code> 时调用 <code>mPropertyHalService.setPropertyHalListener(this)</code> 注册进来的。</p>
<p>如果细心的同学会发现，在前面的 <a href="../car-input-service/">Android 15 CarService源码06-CarInputService</a> 分析中我们知道，<code>InputHalService.setInputListener()</code> 方法中调用 <code>VehicleHal.subscribePropertySafe()</code> 方法来订阅属性后，事件回调到 <code>InputHalService.onHalEvents()</code> 方法中。并且是根据传进去的属性ID来关联。</p>
<p>但是我们在 <code>PropertyHalService</code> 中并没有看到主动调用 <code>VehicleHal.subscribePropertySafe()</code> 方法来订阅属性。这是怎么回事呢？我们回顾 <a href="../carservice-call-vhal/">Android 15 CarService源码04-CarService与Vehicle HAL交互</a> 中的分析，当新的车辆属性事件发生时调用 <code>VehicleHal.onPropertyEvent()</code> 方法。</p>
<p>根据前面我们提到属性事件从 <code>Vehicle</code> 到 <code>PropertyHalService</code> 的流程，我们先看下其跟 <code>InputHalService</code> 有何不同之处。</p>
<h4 id="vehiclehalhandleonpropertyevent">VehicleHal.handleOnPropertyEvent()<a class="headerlink" href="#vehiclehalhandleonpropertyevent" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/VehicleHal.java  </span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="cm">/**  </span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="cm"> * VehicleHal 类是车辆硬件抽象层（HAL）的抽象。该类负责处理与本地 HAL 的接口，并对接收到的数据进行基本解析（类型检查）。  </span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="cm"> * 每个事件会被发送到相应的 {@link HalServiceBase} 实现，由 {@link HalServiceBase} 负责将数据转换为对应的 Car*Service，  </span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="cm"> * 以便通过 Car*Manager API 提供给上层应用使用。  </span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="cm"> */</span><span class="w">  </span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VehicleHal</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">VehicleHalCallback</span><span class="p">,</span><span class="w"> </span><span class="n">CarSystemService</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="cm">/**  </span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="cm">     * 处理车辆属性事件。  </span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="cm">     * @param propValues 包含车辆属性事件的列表。  </span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="cm">     */</span><span class="w">  </span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleOnPropertyEvent</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">HalPropValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">propValues</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 确保线程安全，防止并发修改共享数据。  </span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">propValues</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="w">                </span><span class="n">HalPropValue</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">propValues</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"> </span><span class="c1">// 获取当前事件。  </span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">propId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="na">getPropId</span><span class="p">();</span><span class="w"> </span><span class="c1">// 获取事件的属性 ID。  </span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="w">                </span><span class="c1">// 根据属性 ID 查找对应的 HalServiceBase 实例。  </span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="w">                </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPropertyHandlers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">propId</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">service</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="w">                    </span><span class="c1">// 如果找不到对应的服务，记录错误日志并跳过该事件。  </span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="w">                    </span><span class="n">Slogf</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">CarLog</span><span class="p">.</span><span class="na">TAG_HAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;handleOnPropertyEvent: HalService not found for %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span><span class="w">  </span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="w">                </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="w">                </span><span class="c1">// 将事件添加到服务的分发列表中。  </span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="w">                </span><span class="n">service</span><span class="p">.</span><span class="na">getDispatchList</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">v</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="w">                </span><span class="c1">// 将服务添加到待分发的服务列表中。  </span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a><span class="w">                </span><span class="n">mServicesToDispatch</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">service</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="w">                </span><span class="c1">// 更新事件日志，用于记录该属性的事件信息。  </span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="w">                </span><span class="n">VehiclePropertyEventInfo</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mEventLog</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">propId</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a><span class="w">                    </span><span class="c1">// 如果该属性的事件信息不存在，则创建新的事件信息并存储。  </span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a><span class="w">                    </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VehiclePropertyEventInfo</span><span class="p">(</span><span class="n">v</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a><span class="w">                    </span><span class="n">mEventLog</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a><span class="w">                    </span><span class="c1">// 如果事件信息已存在，则添加新的事件。  </span>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a><span class="w">                    </span><span class="n">info</span><span class="p">.</span><span class="na">addNewEvent</span><span class="p">(</span><span class="n">v</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a><span class="w">                </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-16-42"><a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a><span class="w">            </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-16-43"><a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a><span class="w">        </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a>
</span><span id="__span-16-45"><a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a><span class="w">        </span><span class="c1">// 遍历所有待分发的服务，调用其 onHalEvents 方法处理事件。  </span>
</span><span id="__span-16-46"><a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">HalServiceBase</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">mServicesToDispatch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-16-47"><a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a><span class="w">            </span><span class="n">s</span><span class="p">.</span><span class="na">onHalEvents</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">getDispatchList</span><span class="p">());</span><span class="w"> </span><span class="c1">// 处理事件。  </span>
</span><span id="__span-16-48"><a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a><span class="w">            </span><span class="n">s</span><span class="p">.</span><span class="na">getDispatchList</span><span class="p">().</span><span class="na">clear</span><span class="p">();</span><span class="w"> </span><span class="c1">// 清空服务的分发列表。  </span>
</span><span id="__span-16-49"><a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a><span class="w">        </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-16-50"><a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a><span class="w">        </span><span class="c1">// 清空待分发的服务列表。  </span>
</span><span id="__span-16-51"><a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a><span class="w">        </span><span class="n">mServicesToDispatch</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span><span class="w">  </span>
</span><span id="__span-16-52"><a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a><span class="w">    </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-16-53"><a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a>
</span><span id="__span-16-54"><a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的注释很明白了，我们直接看 <code>mPropertyHandlers</code> ，也就是在 <a href="../init-service/">Android 15 CarService源码02-服务初始化</a> 中 <code>VehicleHal.priorityInit()</code> 有解释。</p>
<h4 id="vehiclehalpriorityinit">VehicleHal.priorityInit()<a class="headerlink" href="#vehiclehalpriorityinit" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/VehicleHal.java  </span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="cm">/**  </span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="cm"> * VehicleHal 类是车辆硬件抽象层（HAL）的抽象。该类处理与本地 HAL 的接口，并对接收到的数据进行基本解析（类型检查）。  </span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="cm"> * 然后，每个事件被发送到相应的 {@link HalServiceBase} 实现。  </span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="cm"> * {@link HalServiceBase} 的责任是将数据转换为对应的 Car*Service，以便通过 Car*Manager API 使用。  </span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="cm"> */</span><span class="w">  </span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VehicleHal</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">VehicleHalCallback</span><span class="p">,</span><span class="w"> </span><span class="n">CarSystemService</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">    </span><span class="cm">/**  </span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="cm">     * 为 VHAL 配置进行优先初始化。  </span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="cm">     */</span><span class="w">  </span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">priorityInit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="w">        </span><span class="c1">// 获取所有属性配置。  </span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="w">        </span><span class="n">fetchAllPropConfigs</span><span class="p">();</span><span class="w">  </span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="w">        </span><span class="c1">// PropertyHalService 将处理大多数属性，因此需要足够大。  </span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="w">        </span><span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">HalServiceBase</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">HalPropConfig</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">configsForAllServices</span><span class="p">;</span><span class="w">  </span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="w">            </span><span class="c1">// 初始化存储每个服务的属性配置的映射。  </span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="w">            </span><span class="n">configsForAllServices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">mAllServices</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w">  </span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mAllServices</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="w">                </span><span class="c1">// 为每个服务创建一个属性配置列表。  </span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="w">                </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">HalPropConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">configsForService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">  </span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a><span class="w">                </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mAllServices</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a><span class="w">                </span><span class="c1">// 将服务和其属性配置列表添加到映射中。  </span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a><span class="w">                </span><span class="n">configsForAllServices</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">service</span><span class="p">,</span><span class="w"> </span><span class="n">configsForService</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a><span class="w">                </span><span class="c1">// 获取服务支持的所有属性。  </span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a><span class="w">                </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">supportedProps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">service</span><span class="p">.</span><span class="na">getAllSupportedProperties</span><span class="p">();</span><span class="w">  </span>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">supportedProps</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a><span class="w">                    </span><span class="c1">// 如果服务没有明确支持的属性，检查所有属性。  </span>
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mAllProperties</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a><span class="w">                        </span><span class="n">Integer</span><span class="w"> </span><span class="n">propId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mAllProperties</span><span class="p">.</span><span class="na">keyAt</span><span class="p">(</span><span class="n">j</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">service</span><span class="p">.</span><span class="na">isSupportedProperty</span><span class="p">(</span><span class="n">propId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a><span class="w">                            </span><span class="n">HalPropConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mAllProperties</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">propId</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a><span class="w">                            </span><span class="c1">// 将属性处理程序与服务关联。  </span>
</span><span id="__span-17-38"><a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a><span class="w">                            </span><span class="n">mPropertyHandlers</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">);</span>
</span><span id="__span-17-39"><a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a><span class="w">                            </span><span class="c1">// 将属性配置添加到服务的配置列表中。  </span>
</span><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a><span class="w">                            </span><span class="n">configsForService</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">config</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-17-41"><a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a><span class="w">                        </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-17-42"><a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a><span class="w">                    </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-17-43"><a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-17-44"><a id="__codelineno-17-44" name="__codelineno-17-44" href="#__codelineno-17-44"></a><span class="w">                    </span><span class="c1">// 如果服务有明确支持的属性，只处理这些属性。  </span>
</span><span id="__span-17-45"><a id="__codelineno-17-45" name="__codelineno-17-45" href="#__codelineno-17-45"></a><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">prop</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">supportedProps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-17-46"><a id="__codelineno-17-46" name="__codelineno-17-46" href="#__codelineno-17-46"></a><span class="w">                        </span><span class="n">HalPropConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mAllProperties</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-17-47"><a id="__codelineno-17-47" name="__codelineno-17-47" href="#__codelineno-17-47"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-17-48"><a id="__codelineno-17-48" name="__codelineno-17-48" href="#__codelineno-17-48"></a><span class="w">                            </span><span class="k">continue</span><span class="p">;</span><span class="w">  </span>
</span><span id="__span-17-49"><a id="__codelineno-17-49" name="__codelineno-17-49" href="#__codelineno-17-49"></a><span class="w">                        </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-17-50"><a id="__codelineno-17-50" name="__codelineno-17-50" href="#__codelineno-17-50"></a><span class="w">                        </span><span class="c1">// 将属性处理程序与服务关联。  </span>
</span><span id="__span-17-51"><a id="__codelineno-17-51" name="__codelineno-17-51" href="#__codelineno-17-51"></a><span class="w">                        </span><span class="n">mPropertyHandlers</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-17-52"><a id="__codelineno-17-52" name="__codelineno-17-52" href="#__codelineno-17-52"></a><span class="w">                        </span><span class="c1">// 将属性配置添加到服务的配置列表中。  </span>
</span><span id="__span-17-53"><a id="__codelineno-17-53" name="__codelineno-17-53" href="#__codelineno-17-53"></a><span class="w">                        </span><span class="n">configsForService</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">config</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-17-54"><a id="__codelineno-17-54" name="__codelineno-17-54" href="#__codelineno-17-54"></a><span class="w">                    </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-17-55"><a id="__codelineno-17-55" name="__codelineno-17-55" href="#__codelineno-17-55"></a><span class="w">                </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-17-56"><a id="__codelineno-17-56" name="__codelineno-17-56" href="#__codelineno-17-56"></a><span class="w">            </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-17-57"><a id="__codelineno-17-57" name="__codelineno-17-57" href="#__codelineno-17-57"></a><span class="w">        </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-17-58"><a id="__codelineno-17-58" name="__codelineno-17-58" href="#__codelineno-17-58"></a>
</span><span id="__span-17-59"><a id="__codelineno-17-59" name="__codelineno-17-59" href="#__codelineno-17-59"></a><span class="w">        </span><span class="c1">// 初始化每个服务并传递其属性配置。  </span>
</span><span id="__span-17-60"><a id="__codelineno-17-60" name="__codelineno-17-60" href="#__codelineno-17-60"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">HalServiceBase</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">HalPropConfig</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">entry</span><span class="w">  </span>
</span><span id="__span-17-61"><a id="__codelineno-17-61" name="__codelineno-17-61" href="#__codelineno-17-61"></a><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="n">configsForAllServices</span><span class="p">.</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-17-62"><a id="__codelineno-17-62" name="__codelineno-17-62" href="#__codelineno-17-62"></a><span class="w">            </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">();</span><span class="w">  </span>
</span><span id="__span-17-63"><a id="__codelineno-17-63" name="__codelineno-17-63" href="#__codelineno-17-63"></a><span class="w">            </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">HalPropConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">configsForService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">();</span><span class="w">  </span>
</span><span id="__span-17-64"><a id="__codelineno-17-64" name="__codelineno-17-64" href="#__codelineno-17-64"></a><span class="w">            </span><span class="c1">// 让服务接管其属性配置。  </span>
</span><span id="__span-17-65"><a id="__codelineno-17-65" name="__codelineno-17-65" href="#__codelineno-17-65"></a><span class="w">            </span><span class="n">service</span><span class="p">.</span><span class="na">takeProperties</span><span class="p">(</span><span class="n">configsForService</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-17-66"><a id="__codelineno-17-66" name="__codelineno-17-66" href="#__codelineno-17-66"></a><span class="w">            </span><span class="c1">// 初始化服务。  </span>
</span><span id="__span-17-67"><a id="__codelineno-17-67" name="__codelineno-17-67" href="#__codelineno-17-67"></a><span class="w">            </span><span class="n">service</span><span class="p">.</span><span class="na">init</span><span class="p">();</span><span class="w">  </span>
</span><span id="__span-17-68"><a id="__codelineno-17-68" name="__codelineno-17-68" href="#__codelineno-17-68"></a><span class="w">        </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-17-69"><a id="__codelineno-17-69" name="__codelineno-17-69" href="#__codelineno-17-69"></a><span class="w">    </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-17-70"><a id="__codelineno-17-70" name="__codelineno-17-70" href="#__codelineno-17-70"></a>
</span><span id="__span-17-71"><a id="__codelineno-17-71" name="__codelineno-17-71" href="#__codelineno-17-71"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的注释也很明白了，而且我们之前在 <code>PropertyHalService.takeProperties()</code> 也提到过 <code>getAllSupportedProperties()</code> 获取到的是空。使用这里走到 <code>if (supportedProps.length == 0)</code> 流程里，也就是所有支持的属性都跟 <code>CarPropertyService</code> 关联起来。</p>
<p>再回到 <code>VehicleHal.handleOnPropertyEvent()</code> 中，就很清晰了。也就是说只要是支持的属性有变化，最终都会回调到 <code>PropertyHalService.onHalEvents()</code> 里。</p>
<p><code>PropertyHalService.onPropertySetError()</code> 跟 <code>PropertyHalService.onHalEvents()</code> 的流程是类似的，我们就不再详细分析其过长了。调用链路为：</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">VehicleHal</span><span class="p">.</span><span class="na">onPropertySetError</span><span class="p">()</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="o">---&gt;</span><span class="w"> </span><span class="n">VehicleHal</span><span class="p">.</span><span class="na">handleOnPropertySetError</span><span class="p">()</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">        </span><span class="o">---&gt;</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="p">.</span><span class="na">onPropertySetError</span><span class="p">()</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">            </span><span class="o">---&gt;</span><span class="w"> </span><span class="n">PropertyHalService</span><span class="p">.</span><span class="na">onPropertySetError</span><span class="p">()</span>
</span></code></pre></div>
<h4 id="carpropertyserviceonpropertychange">CarPropertyService.onPropertyChange()<a class="headerlink" href="#carpropertyserviceonpropertychange" title="Permanent link">&para;</a></h4>
<p>前面提到了在 <code>CarPropertyService.init()</code> 时调用 <code>mPropertyHalService.setPropertyHalListener(this)</code> ，所以事件最终会回调到 <code>CarPropertyService.onPropertyChange()</code> 中。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/CarPropertyService.java</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CarPropertyService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ICarProperty</span><span class="p">.</span><span class="na">Stub</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">CarServiceBase</span><span class="p">,</span><span class="w"> </span><span class="n">PropertyHalService</span><span class="p">.</span><span class="na">PropertyHalListener</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="cm">     * 处理从 PropertyHalService 收到的属性变化事件，并将事件分发到相应的客户端。</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="cm">     *</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="cm">     * @param events 从 PropertyHalService 接收到的属性变化事件列表</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="cm">     */</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onPropertyChange</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">CarPropertyEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">        </span><span class="c1">// 用于存储将要分发到各个客户端的事件</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">CarPropertyServiceClient</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">CarPropertyEvent</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">eventsToDispatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">        </span><span class="c1">// 对 mLock 加锁，确保线程安全</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">            </span><span class="c1">// 遍历所有的属性变化事件</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">events</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">                </span><span class="n">CarPropertyEvent</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">events</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="w">                </span><span class="c1">// 获取事件中的属性 ID 和区域 ID</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">propId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getCarPropertyValue</span><span class="p">().</span><span class="na">getPropertyId</span><span class="p">();</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getCarPropertyValue</span><span class="p">().</span><span class="na">getAreaId</span><span class="p">();</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="w">                </span><span class="c1">// 获取所有订阅了该属性和区域的客户端</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="w">                </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">CarPropertyServiceClient</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mSubscriptionManager</span><span class="p">.</span><span class="na">getClients</span><span class="p">(</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="w">                        </span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">);</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="w">                </span><span class="c1">// 如果没有客户端订阅该属性，输出错误日志并跳过此事件</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clients</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="w">                    </span><span class="n">Slogf</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a><span class="w">                            </span><span class="s">&quot;onPropertyChange: no listener registered for propId=%s, areaId=%d&quot;</span><span class="p">,</span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a><span class="w">                            </span><span class="n">VehiclePropertyIds</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">propId</span><span class="p">),</span><span class="w"> </span><span class="n">areaId</span><span class="p">);</span>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a><span class="w">                </span><span class="c1">// 遍历所有订阅该属性的客户端，将事件添加到该客户端的事件列表中</span>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">CarPropertyServiceClient</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">clients</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-40"><a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a><span class="w">                    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">CarPropertyEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">eventsForClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eventsToDispatch</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span id="__span-19-41"><a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eventsForClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-42"><a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a><span class="w">                        </span><span class="c1">// 如果该客户端还没有事件列表，创建一个新的列表</span>
</span><span id="__span-19-43"><a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a><span class="w">                        </span><span class="n">eventsToDispatch</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">CarPropertyEvent</span><span class="o">&gt;</span><span class="p">());</span>
</span><span id="__span-19-44"><a id="__codelineno-19-44" name="__codelineno-19-44" href="#__codelineno-19-44"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-19-45"><a id="__codelineno-19-45" name="__codelineno-19-45" href="#__codelineno-19-45"></a><span class="w">                    </span><span class="c1">// 将当前事件添加到该客户端的事件列表中</span>
</span><span id="__span-19-46"><a id="__codelineno-19-46" name="__codelineno-19-46" href="#__codelineno-19-46"></a><span class="w">                    </span><span class="n">eventsToDispatch</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">client</span><span class="p">).</span><span class="na">add</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span><span id="__span-19-47"><a id="__codelineno-19-47" name="__codelineno-19-47" href="#__codelineno-19-47"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-19-48"><a id="__codelineno-19-48" name="__codelineno-19-48" href="#__codelineno-19-48"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-19-49"><a id="__codelineno-19-49" name="__codelineno-19-49" href="#__codelineno-19-49"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-19-50"><a id="__codelineno-19-50" name="__codelineno-19-50" href="#__codelineno-19-50"></a>
</span><span id="__span-19-51"><a id="__codelineno-19-51" name="__codelineno-19-51" href="#__codelineno-19-51"></a><span class="w">        </span><span class="c1">// 释放锁后，开始将事件分发给各个客户端</span>
</span><span id="__span-19-52"><a id="__codelineno-19-52" name="__codelineno-19-52" href="#__codelineno-19-52"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">CarPropertyServiceClient</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">eventsToDispatch</span><span class="p">.</span><span class="na">keySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-53"><a id="__codelineno-19-53" name="__codelineno-19-53" href="#__codelineno-19-53"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-54"><a id="__codelineno-19-54" name="__codelineno-19-54" href="#__codelineno-19-54"></a><span class="w">                </span><span class="c1">// 调用客户端的 onEvent 方法，将事件发送给客户端</span>
</span><span id="__span-19-55"><a id="__codelineno-19-55" name="__codelineno-19-55" href="#__codelineno-19-55"></a><span class="w">                </span><span class="n">client</span><span class="p">.</span><span class="na">onEvent</span><span class="p">(</span><span class="n">eventsToDispatch</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>
</span><span id="__span-19-56"><a id="__codelineno-19-56" name="__codelineno-19-56" href="#__codelineno-19-56"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-57"><a id="__codelineno-19-57" name="__codelineno-19-57" href="#__codelineno-19-57"></a><span class="w">                </span><span class="c1">// 如果在调用过程中发生异常（例如连接中断），记录错误日志</span>
</span><span id="__span-19-58"><a id="__codelineno-19-58" name="__codelineno-19-58" href="#__codelineno-19-58"></a><span class="w">                </span><span class="n">Slogf</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;onEvent calling failed: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span>
</span><span id="__span-19-59"><a id="__codelineno-19-59" name="__codelineno-19-59" href="#__codelineno-19-59"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-19-60"><a id="__codelineno-19-60" name="__codelineno-19-60" href="#__codelineno-19-60"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-19-61"><a id="__codelineno-19-61" name="__codelineno-19-61" href="#__codelineno-19-61"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-62"><a id="__codelineno-19-62" name="__codelineno-19-62" href="#__codelineno-19-62"></a><span class="p">}</span>
</span></code></pre></div>
<p>主要功能是将这些变化事件传递给所有订阅了相关属性的客户端。</p>
<ul>
<li><code>eventsToDispatch</code> 是一个映射表，用于存储将要发送给各个客户端的事件。为什么要用这个而不是直接查询到就发过客户端的原因是用 <code>SubscriptionManager.getClients()</code> 查询必须加锁，但是有不想调用客户端 <code>onEvent()</code> 方法时被阻塞，所以先查询到所有的客户端，再发送。</li>
<li>调用 <code>SubscriptionManager.getClients()</code> 查询客户端，根据 <code>propId</code> 和 <code>areaId</code> 查询哪些客户端订阅了该属性。</li>
<li>将事件添加到对应客户端的事件列表 <code>eventsToDispatch</code> 中。</li>
<li>释放锁后分发事件，调用 <code>CarPropertyServiceClient</code> 的 <code>onEvent</code> 方法，将事件发送给客户端。</li>
</ul>
<p>从这里我们也知道了，<code>CarPropertyService</code> 接收到 <code>PropertyHalService</code> 的回调事件后，最终是会通过 <code>binder</code> 把事件回调给客户端。所以接下来我们继续从分析客户端是如何注册的。</p>
<h3 id="carpropertymanager">CarPropertyManager 监听属性事件<a class="headerlink" href="#carpropertymanager" title="Permanent link">&para;</a></h3>
<p>在前面的 <a href="../car-property-manager/">Android 15 CarService源码08-CarPropertyService之接口</a> 分析中，我们知道客户端通过调用 <code>CarPropertyManager.subscribePropertyEvents()</code> 监听属性事件的变化，其最终是调到了 <code>CarPropertyService.registerListener()</code> 中。</p>
<h4 id="carpropertyserviceregisterlistener">CarPropertyService.registerListener()<a class="headerlink" href="#carpropertyserviceregisterlistener" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/CarPropertyService.java</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CarPropertyService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ICarProperty</span><span class="p">.</span><span class="na">Stub</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">CarServiceBase</span><span class="p">,</span><span class="w"> </span><span class="n">PropertyHalService</span><span class="p">.</span><span class="na">PropertyHalListener</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="cm">     * 注册一个监听器，用于监听指定的车辆属性变化事件。</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="cm">     * </span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="cm">     * @param carSubscriptions 需要订阅的属性列表</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="cm">     * @param carPropertyEventListener 监听属性变化事件的回调接口</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="cm">     * @throws IllegalArgumentException 如果传入的参数无效</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="cm">     * @throws ServiceSpecificException 如果在服务中发生特定的错误</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="cm">     */</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">registerListener</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">CarSubscription</span><span class="o">&gt;</span><span class="w"> </span><span class="n">carSubscriptions</span><span class="p">,</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">                                 </span><span class="n">ICarPropertyEventListener</span><span class="w"> </span><span class="n">carPropertyEventListener</span><span class="p">)</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="w">        </span><span class="c1">// 确保传入的 carSubscriptions 和 carPropertyEventListener 非空</span>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">        </span><span class="n">requireNonNull</span><span class="p">(</span><span class="n">carSubscriptions</span><span class="p">);</span>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="w">        </span><span class="n">requireNonNull</span><span class="p">(</span><span class="n">carPropertyEventListener</span><span class="p">);</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="w">        </span><span class="c1">// 验证并清理订阅选项，确保所有订阅的属性设置合法</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">CarSubscription</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sanitizedOptions</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="w">                </span><span class="n">validateAndSanitizeSubscriptions</span><span class="p">(</span><span class="n">carSubscriptions</span><span class="p">);</span>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a><span class="w">        </span><span class="n">CarPropertyServiceClient</span><span class="w"> </span><span class="n">finalClient</span><span class="p">;</span>
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a><span class="w">        </span><span class="c1">// 加锁，确保线程安全</span>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a><span class="w">            </span><span class="c1">// 创建客户端，确保在注册时 Binder 没有死亡</span>
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a><span class="w">            </span><span class="n">CarPropertyServiceClient</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOrCreateClientForBinderLocked</span><span class="p">(</span>
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a><span class="w">                    </span><span class="n">carPropertyEventListener</span><span class="p">);</span>
</span><span id="__span-20-34"><a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>
</span><span id="__span-20-35"><a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a><span class="w">            </span><span class="c1">// 如果客户端为 null，表示客户端已经死亡，不进行订阅操作</span>
</span><span id="__span-20-36"><a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-37"><a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a><span class="w">                </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-20-38"><a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-20-39"><a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a>
</span><span id="__span-20-40"><a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a><span class="w">            </span><span class="c1">// 遍历 sanitizedOptions，记录更新频率，并打印调试信息</span>
</span><span id="__span-20-41"><a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sanitizedOptions</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-42"><a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a><span class="w">                </span><span class="n">CarSubscription</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sanitizedOptions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-20-43"><a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a><span class="w">                </span><span class="n">mSubscriptionUpdateRateHistogram</span><span class="p">.</span><span class="na">logSample</span><span class="p">(</span><span class="n">option</span><span class="p">.</span><span class="na">updateRateHz</span><span class="p">);</span>
</span><span id="__span-20-44"><a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-45"><a id="__codelineno-20-45" name="__codelineno-20-45" href="#__codelineno-20-45"></a><span class="w">                    </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;registerListener after update rate sanitization, options: &quot;</span>
</span><span id="__span-20-46"><a id="__codelineno-20-46" name="__codelineno-20-46" href="#__codelineno-20-46"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">sanitizedOptions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
</span><span id="__span-20-47"><a id="__codelineno-20-47" name="__codelineno-20-47" href="#__codelineno-20-47"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-20-48"><a id="__codelineno-20-48" name="__codelineno-20-48" href="#__codelineno-20-48"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-20-49"><a id="__codelineno-20-49" name="__codelineno-20-49" href="#__codelineno-20-49"></a>
</span><span id="__span-20-50"><a id="__codelineno-20-50" name="__codelineno-20-50" href="#__codelineno-20-50"></a><span class="w">            </span><span class="c1">// 将新的订阅选项存储到暂存区，这不会影响当前的订阅状态</span>
</span><span id="__span-20-51"><a id="__codelineno-20-51" name="__codelineno-20-51" href="#__codelineno-20-51"></a><span class="w">            </span><span class="n">mSubscriptionManager</span><span class="p">.</span><span class="na">stageNewOptions</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">sanitizedOptions</span><span class="p">);</span>
</span><span id="__span-20-52"><a id="__codelineno-20-52" name="__codelineno-20-52" href="#__codelineno-20-52"></a>
</span><span id="__span-20-53"><a id="__codelineno-20-53" name="__codelineno-20-53" href="#__codelineno-20-53"></a><span class="w">            </span><span class="c1">// 尝试应用暂存的订阅更改</span>
</span><span id="__span-20-54"><a id="__codelineno-20-54" name="__codelineno-20-54" href="#__codelineno-20-54"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-55"><a id="__codelineno-20-55" name="__codelineno-20-55" href="#__codelineno-20-55"></a><span class="w">                </span><span class="n">applyStagedChangesLocked</span><span class="p">();</span>
</span><span id="__span-20-56"><a id="__codelineno-20-56" name="__codelineno-20-56" href="#__codelineno-20-56"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-57"><a id="__codelineno-20-57" name="__codelineno-20-57" href="#__codelineno-20-57"></a><span class="w">                </span><span class="c1">// 如果应用更改失败，丢弃暂存的更改</span>
</span><span id="__span-20-58"><a id="__codelineno-20-58" name="__codelineno-20-58" href="#__codelineno-20-58"></a><span class="w">                </span><span class="n">mSubscriptionManager</span><span class="p">.</span><span class="na">dropCommit</span><span class="p">();</span>
</span><span id="__span-20-59"><a id="__codelineno-20-59" name="__codelineno-20-59" href="#__codelineno-20-59"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
</span><span id="__span-20-60"><a id="__codelineno-20-60" name="__codelineno-20-60" href="#__codelineno-20-60"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-20-61"><a id="__codelineno-20-61" name="__codelineno-20-61" href="#__codelineno-20-61"></a>
</span><span id="__span-20-62"><a id="__codelineno-20-62" name="__codelineno-20-62" href="#__codelineno-20-62"></a><span class="w">            </span><span class="c1">// 提交更改，并将客户端添加到订阅列表中</span>
</span><span id="__span-20-63"><a id="__codelineno-20-63" name="__codelineno-20-63" href="#__codelineno-20-63"></a><span class="w">            </span><span class="n">mSubscriptionManager</span><span class="p">.</span><span class="na">commit</span><span class="p">();</span>
</span><span id="__span-20-64"><a id="__codelineno-20-64" name="__codelineno-20-64" href="#__codelineno-20-64"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sanitizedOptions</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-65"><a id="__codelineno-20-65" name="__codelineno-20-65" href="#__codelineno-20-65"></a><span class="w">                </span><span class="n">CarSubscription</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sanitizedOptions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-20-66"><a id="__codelineno-20-66" name="__codelineno-20-66" href="#__codelineno-20-66"></a><span class="w">                </span><span class="c1">// 根据订阅选项的更新频率，添加不同类型的属性</span>
</span><span id="__span-20-67"><a id="__codelineno-20-67" name="__codelineno-20-67" href="#__codelineno-20-67"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">option</span><span class="p">.</span><span class="na">updateRateHz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-68"><a id="__codelineno-20-68" name="__codelineno-20-68" href="#__codelineno-20-68"></a><span class="w">                    </span><span class="c1">// 如果更新频率非零，则为连续属性</span>
</span><span id="__span-20-69"><a id="__codelineno-20-69" name="__codelineno-20-69" href="#__codelineno-20-69"></a><span class="w">                    </span><span class="n">client</span><span class="p">.</span><span class="na">addContinuousProperty</span><span class="p">(</span>
</span><span id="__span-20-70"><a id="__codelineno-20-70" name="__codelineno-20-70" href="#__codelineno-20-70"></a><span class="w">                            </span><span class="n">option</span><span class="p">.</span><span class="na">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">option</span><span class="p">.</span><span class="na">areaIds</span><span class="p">,</span><span class="w"> </span><span class="n">option</span><span class="p">.</span><span class="na">updateRateHz</span><span class="p">,</span>
</span><span id="__span-20-71"><a id="__codelineno-20-71" name="__codelineno-20-71" href="#__codelineno-20-71"></a><span class="w">                            </span><span class="n">option</span><span class="p">.</span><span class="na">enableVariableUpdateRate</span><span class="p">,</span><span class="w"> </span><span class="n">option</span><span class="p">.</span><span class="na">resolution</span><span class="p">);</span>
</span><span id="__span-20-72"><a id="__codelineno-20-72" name="__codelineno-20-72" href="#__codelineno-20-72"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-73"><a id="__codelineno-20-73" name="__codelineno-20-73" href="#__codelineno-20-73"></a><span class="w">                    </span><span class="c1">// 如果更新频率为零，则为变化属性</span>
</span><span id="__span-20-74"><a id="__codelineno-20-74" name="__codelineno-20-74" href="#__codelineno-20-74"></a><span class="w">                    </span><span class="n">client</span><span class="p">.</span><span class="na">addOnChangeProperty</span><span class="p">(</span><span class="n">option</span><span class="p">.</span><span class="na">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">option</span><span class="p">.</span><span class="na">areaIds</span><span class="p">);</span>
</span><span id="__span-20-75"><a id="__codelineno-20-75" name="__codelineno-20-75" href="#__codelineno-20-75"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-20-76"><a id="__codelineno-20-76" name="__codelineno-20-76" href="#__codelineno-20-76"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-20-77"><a id="__codelineno-20-77" name="__codelineno-20-77" href="#__codelineno-20-77"></a>
</span><span id="__span-20-78"><a id="__codelineno-20-78" name="__codelineno-20-78" href="#__codelineno-20-78"></a><span class="w">            </span><span class="c1">// 将最终创建的客户端赋值给 finalClient</span>
</span><span id="__span-20-79"><a id="__codelineno-20-79" name="__codelineno-20-79" href="#__codelineno-20-79"></a><span class="w">            </span><span class="n">finalClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>
</span><span id="__span-20-80"><a id="__codelineno-20-80" name="__codelineno-20-80" href="#__codelineno-20-80"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-20-81"><a id="__codelineno-20-81" name="__codelineno-20-81" href="#__codelineno-20-81"></a>
</span><span id="__span-20-82"><a id="__codelineno-20-82" name="__codelineno-20-82" href="#__codelineno-20-82"></a><span class="w">        </span><span class="c1">// 在后台线程中，获取并分发属性的初始化值</span>
</span><span id="__span-20-83"><a id="__codelineno-20-83" name="__codelineno-20-83" href="#__codelineno-20-83"></a><span class="w">        </span><span class="n">mHandler</span><span class="p">.</span><span class="na">post</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-20-84"><a id="__codelineno-20-84" name="__codelineno-20-84" href="#__codelineno-20-84"></a><span class="w">                </span><span class="n">getAndDispatchPropertyInitValue</span><span class="p">(</span><span class="n">sanitizedOptions</span><span class="p">,</span><span class="w"> </span><span class="n">finalClient</span><span class="p">));</span>
</span><span id="__span-20-85"><a id="__codelineno-20-85" name="__codelineno-20-85" href="#__codelineno-20-85"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-20-86"><a id="__codelineno-20-86" name="__codelineno-20-86" href="#__codelineno-20-86"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><code>getOrCreateClientForBinderLocked()</code> 创建客户端，这个比较简单，就不再深入分析了。</li>
<li><code>SubscriptionManager.stageNewOptions()</code> 存储新的订阅选项，这个会重点分析。</li>
<li><code>applyStagedChangesLocked()</code> 尝试应用之前存储的订阅更改，如果失败则调用 <code>SubscriptionManager.commit()</code> 丢弃这些暂存的更改。这个会重点分析。</li>
<li><code>SubscriptionManager.commit()</code> 提交所有的订阅更改，实际将订阅选项应用到系统中，这个会重点分析。</li>
<li><code>getAndDispatchPropertyInitValue()</code> 后台线程中获取并分发初始化值。</li>
</ul>
<h4 id="subscriptionmanager">SubscriptionManager<a class="headerlink" href="#subscriptionmanager" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1">// packages/services/Car/car-lib/src/com/android/car/internal/property/SubscriptionManager.java</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="cm">/**</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="cm"> * 该类管理 [{propertyId, areaId} -&gt; RateInfoForClients] 映射，并维护两种状态：</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="cm"> * 当前状态和暂存状态。暂存状态表示提议的更改。在将更改应用到底层系统后，调用者可以</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="cm"> * 使用 {@link #commit} 方法将当前状态替换为暂存状态，或者使用 {@link #dropCommit}</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="cm"> * 丢弃暂存状态。</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="cm"> *</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="cm"> * 一个常见的使用模式是：</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="cm"> * </span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="cm"> * synchronized (mLock) {</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="cm"> *   mSubscriptionManager.stageNewOptions(...);</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="cm"> *   // 可以选择暂存其他选项。</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="cm"> *   mSubscriptionManager.stageNewOptions(...);</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="cm"> *   // 可以选择暂存取消注册。</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="cm"> *   mSubscriptionManager.stageUnregister(...);</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="cm"> * </span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="cm"> *   mSubscriptionManager.diffBetweenCurrentAndStage(...);</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="cm"> *   try {</span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="cm"> *     // 应用差异。</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="cm"> *   } catch (Exception e) {</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a><span class="cm"> *     mSubscriptionManager.dropCommit();</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a><span class="cm"> *     throw e;</span>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a><span class="cm"> *   }</span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="cm"> *   mSubscriptionManager.commit();</span>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="cm"> * }</span>
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a><span class="cm"> * </span>
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a><span class="cm"> * 该类本身不是线程安全的。</span>
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a><span class="cm"> *</span>
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a><span class="cm"> * @param &lt;ClientType&gt; 客户端类的表示。</span>
</span><span id="__span-21-31"><a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a><span class="cm"> */</span>
</span><span id="__span-21-32"><a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SubscriptionManager</span><span class="o">&lt;</span><span class="n">ClientType</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-33"><a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a>
</span><span id="__span-21-34"><a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-21-35"><a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a><span class="cm">     * 用于表示单个客户端的更新率、可变更新率标志和分辨率的类。</span>
</span><span id="__span-21-36"><a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a><span class="cm">     */</span>
</span><span id="__span-21-37"><a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RateInfo</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-38"><a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">updateRateHz</span><span class="p">;</span><span class="w">  </span><span class="c1">// 更新频率（Hz）</span>
</span><span id="__span-21-39"><a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">enableVariableUpdateRate</span><span class="p">;</span><span class="w">  </span><span class="c1">// 是否启用可变更新率</span>
</span><span id="__span-21-40"><a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">resolution</span><span class="p">;</span><span class="w">  </span><span class="c1">// 分辨率</span>
</span><span id="__span-21-41"><a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a>
</span><span id="__span-21-42"><a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a><span class="w">        </span><span class="c1">// 构造函数</span>
</span><span id="__span-21-43"><a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a><span class="w">        </span><span class="n">RateInfo</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">updateRateHz</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">enableVariableUpdateRate</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">resolution</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-44"><a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">updateRateHz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateRateHz</span><span class="p">;</span>
</span><span id="__span-21-45"><a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">enableVariableUpdateRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enableVariableUpdateRate</span><span class="p">;</span>
</span><span id="__span-21-46"><a id="__codelineno-21-46" name="__codelineno-21-46" href="#__codelineno-21-46"></a><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resolution</span><span class="p">;</span>
</span><span id="__span-21-47"><a id="__codelineno-21-47" name="__codelineno-21-47" href="#__codelineno-21-47"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-48"><a id="__codelineno-21-48" name="__codelineno-21-48" href="#__codelineno-21-48"></a>
</span><span id="__span-21-49"><a id="__codelineno-21-49" name="__codelineno-21-49" href="#__codelineno-21-49"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-21-50"><a id="__codelineno-21-50" name="__codelineno-21-50" href="#__codelineno-21-50"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-21-51"><a id="__codelineno-21-51" name="__codelineno-21-51" href="#__codelineno-21-51"></a>
</span><span id="__span-21-52"><a id="__codelineno-21-52" name="__codelineno-21-52" href="#__codelineno-21-52"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-21-53"><a id="__codelineno-21-53" name="__codelineno-21-53" href="#__codelineno-21-53"></a><span class="cm">     * 该类为每个 {propertyId, areaId} 键提供一个抽象，用于存储所有客户端的订阅信息。</span>
</span><span id="__span-21-54"><a id="__codelineno-21-54" name="__codelineno-21-54" href="#__codelineno-21-54"></a><span class="cm">     * 包含各个客户端的更新频率、分辨率等信息。</span>
</span><span id="__span-21-55"><a id="__codelineno-21-55" name="__codelineno-21-55" href="#__codelineno-21-55"></a><span class="cm">     */</span>
</span><span id="__span-21-56"><a id="__codelineno-21-56" name="__codelineno-21-56" href="#__codelineno-21-56"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RateInfoForClients</span><span class="o">&lt;</span><span class="n">ClientType</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-57"><a id="__codelineno-21-57" name="__codelineno-21-57" href="#__codelineno-21-57"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">ClientType</span><span class="p">,</span><span class="w"> </span><span class="n">RateInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mRateInfoByClient</span><span class="p">;</span><span class="w">  </span><span class="c1">// 存储每个客户端的更新信息</span>
</span><span id="__span-21-58"><a id="__codelineno-21-58" name="__codelineno-21-58" href="#__codelineno-21-58"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mUpdateRatesHz</span><span class="p">;</span><span class="w">  </span><span class="c1">// 有序集合，存储所有更新频率</span>
</span><span id="__span-21-59"><a id="__codelineno-21-59" name="__codelineno-21-59" href="#__codelineno-21-59"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">Float</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mClientCountByUpdateRateHz</span><span class="p">;</span><span class="w">  </span><span class="c1">// 存储每个更新频率对应的客户端数</span>
</span><span id="__span-21-60"><a id="__codelineno-21-60" name="__codelineno-21-60" href="#__codelineno-21-60"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mResolutions</span><span class="p">;</span><span class="w">  </span><span class="c1">// 有序集合，存储所有分辨率</span>
</span><span id="__span-21-61"><a id="__codelineno-21-61" name="__codelineno-21-61" href="#__codelineno-21-61"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">Float</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mClientCountByResolution</span><span class="p">;</span><span class="w">  </span><span class="c1">// 存储每个分辨率对应的客户端数</span>
</span><span id="__span-21-62"><a id="__codelineno-21-62" name="__codelineno-21-62" href="#__codelineno-21-62"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mEnableVariableUpdateRateCount</span><span class="p">;</span><span class="w">  </span><span class="c1">// 启用可变更新率的客户端数</span>
</span><span id="__span-21-63"><a id="__codelineno-21-63" name="__codelineno-21-63" href="#__codelineno-21-63"></a>
</span><span id="__span-21-64"><a id="__codelineno-21-64" name="__codelineno-21-64" href="#__codelineno-21-64"></a><span class="w">        </span><span class="c1">// 构造函数，初始化各种数据结构</span>
</span><span id="__span-21-65"><a id="__codelineno-21-65" name="__codelineno-21-65" href="#__codelineno-21-65"></a><span class="w">        </span><span class="n">RateInfoForClients</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-66"><a id="__codelineno-21-66" name="__codelineno-21-66" href="#__codelineno-21-66"></a><span class="w">            </span><span class="n">mRateInfoByClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-21-67"><a id="__codelineno-21-67" name="__codelineno-21-67" href="#__codelineno-21-67"></a><span class="w">            </span><span class="n">mUpdateRatesHz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-21-68"><a id="__codelineno-21-68" name="__codelineno-21-68" href="#__codelineno-21-68"></a><span class="w">            </span><span class="n">mClientCountByUpdateRateHz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-21-69"><a id="__codelineno-21-69" name="__codelineno-21-69" href="#__codelineno-21-69"></a><span class="w">            </span><span class="n">mResolutions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-21-70"><a id="__codelineno-21-70" name="__codelineno-21-70" href="#__codelineno-21-70"></a><span class="w">            </span><span class="n">mClientCountByResolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-21-71"><a id="__codelineno-21-71" name="__codelineno-21-71" href="#__codelineno-21-71"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-72"><a id="__codelineno-21-72" name="__codelineno-21-72" href="#__codelineno-21-72"></a>
</span><span id="__span-21-73"><a id="__codelineno-21-73" name="__codelineno-21-73" href="#__codelineno-21-73"></a><span class="w">        </span><span class="c1">// 拷贝构造函数，创建一个副本</span>
</span><span id="__span-21-74"><a id="__codelineno-21-74" name="__codelineno-21-74" href="#__codelineno-21-74"></a><span class="w">        </span><span class="n">RateInfoForClients</span><span class="p">(</span><span class="n">RateInfoForClients</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-75"><a id="__codelineno-21-75" name="__codelineno-21-75" href="#__codelineno-21-75"></a><span class="w">            </span><span class="n">mRateInfoByClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="na">mRateInfoByClient</span><span class="p">);</span>
</span><span id="__span-21-76"><a id="__codelineno-21-76" name="__codelineno-21-76" href="#__codelineno-21-76"></a><span class="w">            </span><span class="n">mUpdateRatesHz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="na">mUpdateRatesHz</span><span class="p">);</span>
</span><span id="__span-21-77"><a id="__codelineno-21-77" name="__codelineno-21-77" href="#__codelineno-21-77"></a><span class="w">            </span><span class="n">mClientCountByUpdateRateHz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="na">mClientCountByUpdateRateHz</span><span class="p">);</span>
</span><span id="__span-21-78"><a id="__codelineno-21-78" name="__codelineno-21-78" href="#__codelineno-21-78"></a><span class="w">            </span><span class="n">mResolutions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="na">mResolutions</span><span class="p">);</span>
</span><span id="__span-21-79"><a id="__codelineno-21-79" name="__codelineno-21-79" href="#__codelineno-21-79"></a><span class="w">            </span><span class="n">mClientCountByResolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="na">mClientCountByResolution</span><span class="p">);</span>
</span><span id="__span-21-80"><a id="__codelineno-21-80" name="__codelineno-21-80" href="#__codelineno-21-80"></a><span class="w">            </span><span class="n">mEnableVariableUpdateRateCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="na">mEnableVariableUpdateRateCount</span><span class="p">;</span>
</span><span id="__span-21-81"><a id="__codelineno-21-81" name="__codelineno-21-81" href="#__codelineno-21-81"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-82"><a id="__codelineno-21-82" name="__codelineno-21-82" href="#__codelineno-21-82"></a>
</span><span id="__span-21-83"><a id="__codelineno-21-83" name="__codelineno-21-83" href="#__codelineno-21-83"></a><span class="w">        </span><span class="cm">/**</span>
</span><span id="__span-21-84"><a id="__codelineno-21-84" name="__codelineno-21-84" href="#__codelineno-21-84"></a><span class="cm">         * 获取该 {propertyId, areaId} 对应的最大更新频率。</span>
</span><span id="__span-21-85"><a id="__codelineno-21-85" name="__codelineno-21-85" href="#__codelineno-21-85"></a><span class="cm">         */</span>
</span><span id="__span-21-86"><a id="__codelineno-21-86" name="__codelineno-21-86" href="#__codelineno-21-86"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getMaxUpdateRateHz</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-87"><a id="__codelineno-21-87" name="__codelineno-21-87" href="#__codelineno-21-87"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">mUpdateRatesHz</span><span class="p">.</span><span class="na">last</span><span class="p">();</span>
</span><span id="__span-21-88"><a id="__codelineno-21-88" name="__codelineno-21-88" href="#__codelineno-21-88"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-89"><a id="__codelineno-21-89" name="__codelineno-21-89" href="#__codelineno-21-89"></a>
</span><span id="__span-21-90"><a id="__codelineno-21-90" name="__codelineno-21-90" href="#__codelineno-21-90"></a><span class="w">        </span><span class="cm">/**</span>
</span><span id="__span-21-91"><a id="__codelineno-21-91" name="__codelineno-21-91" href="#__codelineno-21-91"></a><span class="cm">         * 获取该 {propertyId, areaId} 对应的最小所需分辨率。</span>
</span><span id="__span-21-92"><a id="__codelineno-21-92" name="__codelineno-21-92" href="#__codelineno-21-92"></a><span class="cm">         */</span>
</span><span id="__span-21-93"><a id="__codelineno-21-93" name="__codelineno-21-93" href="#__codelineno-21-93"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getMinRequiredResolution</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-94"><a id="__codelineno-21-94" name="__codelineno-21-94" href="#__codelineno-21-94"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">mResolutions</span><span class="p">.</span><span class="na">first</span><span class="p">();</span>
</span><span id="__span-21-95"><a id="__codelineno-21-95" name="__codelineno-21-95" href="#__codelineno-21-95"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-96"><a id="__codelineno-21-96" name="__codelineno-21-96" href="#__codelineno-21-96"></a>
</span><span id="__span-21-97"><a id="__codelineno-21-97" name="__codelineno-21-97" href="#__codelineno-21-97"></a><span class="w">        </span><span class="c1">// 判断是否所有客户端都启用了可变更新率</span>
</span><span id="__span-21-98"><a id="__codelineno-21-98" name="__codelineno-21-98" href="#__codelineno-21-98"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isVariableUpdateRateEnabledForAllClients</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-99"><a id="__codelineno-21-99" name="__codelineno-21-99" href="#__codelineno-21-99"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">mEnableVariableUpdateRateCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">mRateInfoByClient</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
</span><span id="__span-21-100"><a id="__codelineno-21-100" name="__codelineno-21-100" href="#__codelineno-21-100"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-101"><a id="__codelineno-21-101" name="__codelineno-21-101" href="#__codelineno-21-101"></a>
</span><span id="__span-21-102"><a id="__codelineno-21-102" name="__codelineno-21-102" href="#__codelineno-21-102"></a><span class="w">        </span><span class="cm">/**</span>
</span><span id="__span-21-103"><a id="__codelineno-21-103" name="__codelineno-21-103" href="#__codelineno-21-103"></a><span class="cm">         * 获取所有客户端的合并更新信息。</span>
</span><span id="__span-21-104"><a id="__codelineno-21-104" name="__codelineno-21-104" href="#__codelineno-21-104"></a><span class="cm">         * 使用最大更新频率，最小分辨率，并且只有当所有客户端都启用可变更新率时才启用该功能。</span>
</span><span id="__span-21-105"><a id="__codelineno-21-105" name="__codelineno-21-105" href="#__codelineno-21-105"></a><span class="cm">         */</span>
</span><span id="__span-21-106"><a id="__codelineno-21-106" name="__codelineno-21-106" href="#__codelineno-21-106"></a><span class="w">        </span><span class="n">RateInfo</span><span class="w"> </span><span class="nf">getCombinedRateInfo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-107"><a id="__codelineno-21-107" name="__codelineno-21-107" href="#__codelineno-21-107"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RateInfo</span><span class="p">(</span><span class="n">getMaxUpdateRateHz</span><span class="p">(),</span><span class="w"> </span><span class="n">isVariableUpdateRateEnabledForAllClients</span><span class="p">(),</span>
</span><span id="__span-21-108"><a id="__codelineno-21-108" name="__codelineno-21-108" href="#__codelineno-21-108"></a><span class="w">                    </span><span class="n">getMinRequiredResolution</span><span class="p">());</span>
</span><span id="__span-21-109"><a id="__codelineno-21-109" name="__codelineno-21-109" href="#__codelineno-21-109"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-110"><a id="__codelineno-21-110" name="__codelineno-21-110" href="#__codelineno-21-110"></a>
</span><span id="__span-21-111"><a id="__codelineno-21-111" name="__codelineno-21-111" href="#__codelineno-21-111"></a><span class="w">        </span><span class="c1">// 获取所有客户端集合</span>
</span><span id="__span-21-112"><a id="__codelineno-21-112" name="__codelineno-21-112" href="#__codelineno-21-112"></a><span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">ClientType</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getClients</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-113"><a id="__codelineno-21-113" name="__codelineno-21-113" href="#__codelineno-21-113"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">mRateInfoByClient</span><span class="p">.</span><span class="na">keySet</span><span class="p">();</span>
</span><span id="__span-21-114"><a id="__codelineno-21-114" name="__codelineno-21-114" href="#__codelineno-21-114"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-115"><a id="__codelineno-21-115" name="__codelineno-21-115" href="#__codelineno-21-115"></a>
</span><span id="__span-21-116"><a id="__codelineno-21-116" name="__codelineno-21-116" href="#__codelineno-21-116"></a><span class="w">        </span><span class="c1">// 获取某个客户端的更新频率</span>
</span><span id="__span-21-117"><a id="__codelineno-21-117" name="__codelineno-21-117" href="#__codelineno-21-117"></a><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="nf">getUpdateRateHz</span><span class="p">(</span><span class="n">ClientType</span><span class="w"> </span><span class="n">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-118"><a id="__codelineno-21-118" name="__codelineno-21-118" href="#__codelineno-21-118"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">mRateInfoByClient</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">client</span><span class="p">).</span><span class="na">updateRateHz</span><span class="p">;</span>
</span><span id="__span-21-119"><a id="__codelineno-21-119" name="__codelineno-21-119" href="#__codelineno-21-119"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-120"><a id="__codelineno-21-120" name="__codelineno-21-120" href="#__codelineno-21-120"></a>
</span><span id="__span-21-121"><a id="__codelineno-21-121" name="__codelineno-21-121" href="#__codelineno-21-121"></a><span class="w">        </span><span class="c1">// 获取某个客户端是否启用了可变更新率</span>
</span><span id="__span-21-122"><a id="__codelineno-21-122" name="__codelineno-21-122" href="#__codelineno-21-122"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isVariableUpdateRateEnabled</span><span class="p">(</span><span class="n">ClientType</span><span class="w"> </span><span class="n">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-123"><a id="__codelineno-21-123" name="__codelineno-21-123" href="#__codelineno-21-123"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">mRateInfoByClient</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">client</span><span class="p">).</span><span class="na">enableVariableUpdateRate</span><span class="p">;</span>
</span><span id="__span-21-124"><a id="__codelineno-21-124" name="__codelineno-21-124" href="#__codelineno-21-124"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-125"><a id="__codelineno-21-125" name="__codelineno-21-125" href="#__codelineno-21-125"></a>
</span><span id="__span-21-126"><a id="__codelineno-21-126" name="__codelineno-21-126" href="#__codelineno-21-126"></a><span class="w">        </span><span class="c1">// 获取某个客户端的分辨率</span>
</span><span id="__span-21-127"><a id="__codelineno-21-127" name="__codelineno-21-127" href="#__codelineno-21-127"></a><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="nf">getResolution</span><span class="p">(</span><span class="n">ClientType</span><span class="w"> </span><span class="n">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-128"><a id="__codelineno-21-128" name="__codelineno-21-128" href="#__codelineno-21-128"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">mRateInfoByClient</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">client</span><span class="p">).</span><span class="na">resolution</span><span class="p">;</span>
</span><span id="__span-21-129"><a id="__codelineno-21-129" name="__codelineno-21-129" href="#__codelineno-21-129"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-130"><a id="__codelineno-21-130" name="__codelineno-21-130" href="#__codelineno-21-130"></a>
</span><span id="__span-21-131"><a id="__codelineno-21-131" name="__codelineno-21-131" href="#__codelineno-21-131"></a><span class="w">        </span><span class="cm">/**</span>
</span><span id="__span-21-132"><a id="__codelineno-21-132" name="__codelineno-21-132" href="#__codelineno-21-132"></a><span class="cm">         * 添加一个客户端的订阅信息。</span>
</span><span id="__span-21-133"><a id="__codelineno-21-133" name="__codelineno-21-133" href="#__codelineno-21-133"></a><span class="cm">         */</span>
</span><span id="__span-21-134"><a id="__codelineno-21-134" name="__codelineno-21-134" href="#__codelineno-21-134"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">ClientType</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">updateRateHz</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">enableVariableUpdateRate</span><span class="p">,</span>
</span><span id="__span-21-135"><a id="__codelineno-21-135" name="__codelineno-21-135" href="#__codelineno-21-135"></a><span class="w">                 </span><span class="kt">float</span><span class="w"> </span><span class="n">resolution</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-136"><a id="__codelineno-21-136" name="__codelineno-21-136" href="#__codelineno-21-136"></a><span class="w">            </span><span class="c1">// 如果客户端已存在，先移除旧的订阅信息</span>
</span><span id="__span-21-137"><a id="__codelineno-21-137" name="__codelineno-21-137" href="#__codelineno-21-137"></a><span class="w">            </span><span class="n">remove</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span id="__span-21-138"><a id="__codelineno-21-138" name="__codelineno-21-138" href="#__codelineno-21-138"></a><span class="w">            </span><span class="c1">// 将新的订阅信息存入</span>
</span><span id="__span-21-139"><a id="__codelineno-21-139" name="__codelineno-21-139" href="#__codelineno-21-139"></a><span class="w">            </span><span class="n">mRateInfoByClient</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
</span><span id="__span-21-140"><a id="__codelineno-21-140" name="__codelineno-21-140" href="#__codelineno-21-140"></a><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">RateInfo</span><span class="p">(</span><span class="n">updateRateHz</span><span class="p">,</span><span class="w"> </span><span class="n">enableVariableUpdateRate</span><span class="p">,</span><span class="w"> </span><span class="n">resolution</span><span class="p">));</span>
</span><span id="__span-21-141"><a id="__codelineno-21-141" name="__codelineno-21-141" href="#__codelineno-21-141"></a>
</span><span id="__span-21-142"><a id="__codelineno-21-142" name="__codelineno-21-142" href="#__codelineno-21-142"></a><span class="w">            </span><span class="c1">// 如果启用了可变更新率，增加计数</span>
</span><span id="__span-21-143"><a id="__codelineno-21-143" name="__codelineno-21-143" href="#__codelineno-21-143"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">enableVariableUpdateRate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-144"><a id="__codelineno-21-144" name="__codelineno-21-144" href="#__codelineno-21-144"></a><span class="w">                </span><span class="n">mEnableVariableUpdateRateCount</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-21-145"><a id="__codelineno-21-145" name="__codelineno-21-145" href="#__codelineno-21-145"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-21-146"><a id="__codelineno-21-146" name="__codelineno-21-146" href="#__codelineno-21-146"></a>
</span><span id="__span-21-147"><a id="__codelineno-21-147" name="__codelineno-21-147" href="#__codelineno-21-147"></a><span class="w">            </span><span class="c1">// 更新更新频率的相关数据</span>
</span><span id="__span-21-148"><a id="__codelineno-21-148" name="__codelineno-21-148" href="#__codelineno-21-148"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mClientCountByUpdateRateHz</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">updateRateHz</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-149"><a id="__codelineno-21-149" name="__codelineno-21-149" href="#__codelineno-21-149"></a><span class="w">                </span><span class="n">mUpdateRatesHz</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">updateRateHz</span><span class="p">);</span>
</span><span id="__span-21-150"><a id="__codelineno-21-150" name="__codelineno-21-150" href="#__codelineno-21-150"></a><span class="w">                </span><span class="n">mClientCountByUpdateRateHz</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">updateRateHz</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-21-151"><a id="__codelineno-21-151" name="__codelineno-21-151" href="#__codelineno-21-151"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-152"><a id="__codelineno-21-152" name="__codelineno-21-152" href="#__codelineno-21-152"></a><span class="w">                </span><span class="n">mClientCountByUpdateRateHz</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">updateRateHz</span><span class="p">,</span>
</span><span id="__span-21-153"><a id="__codelineno-21-153" name="__codelineno-21-153" href="#__codelineno-21-153"></a><span class="w">                        </span><span class="n">mClientCountByUpdateRateHz</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">updateRateHz</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-21-154"><a id="__codelineno-21-154" name="__codelineno-21-154" href="#__codelineno-21-154"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-21-155"><a id="__codelineno-21-155" name="__codelineno-21-155" href="#__codelineno-21-155"></a>
</span><span id="__span-21-156"><a id="__codelineno-21-156" name="__codelineno-21-156" href="#__codelineno-21-156"></a><span class="w">            </span><span class="c1">// 更新分辨率的相关数据</span>
</span><span id="__span-21-157"><a id="__codelineno-21-157" name="__codelineno-21-157" href="#__codelineno-21-157"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mClientCountByResolution</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">resolution</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-158"><a id="__codelineno-21-158" name="__codelineno-21-158" href="#__codelineno-21-158"></a><span class="w">                </span><span class="n">mResolutions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">resolution</span><span class="p">);</span>
</span><span id="__span-21-159"><a id="__codelineno-21-159" name="__codelineno-21-159" href="#__codelineno-21-159"></a><span class="w">                </span><span class="n">mClientCountByResolution</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-21-160"><a id="__codelineno-21-160" name="__codelineno-21-160" href="#__codelineno-21-160"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-161"><a id="__codelineno-21-161" name="__codelineno-21-161" href="#__codelineno-21-161"></a><span class="w">                </span><span class="n">mClientCountByResolution</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span>
</span><span id="__span-21-162"><a id="__codelineno-21-162" name="__codelineno-21-162" href="#__codelineno-21-162"></a><span class="w">                        </span><span class="n">mClientCountByResolution</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-21-163"><a id="__codelineno-21-163" name="__codelineno-21-163" href="#__codelineno-21-163"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-21-164"><a id="__codelineno-21-164" name="__codelineno-21-164" href="#__codelineno-21-164"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-165"><a id="__codelineno-21-165" name="__codelineno-21-165" href="#__codelineno-21-165"></a>
</span><span id="__span-21-166"><a id="__codelineno-21-166" name="__codelineno-21-166" href="#__codelineno-21-166"></a><span class="w">        </span><span class="cm">/**</span>
</span><span id="__span-21-167"><a id="__codelineno-21-167" name="__codelineno-21-167" href="#__codelineno-21-167"></a><span class="cm">         * 移除一个客户端的订阅信息。</span>
</span><span id="__span-21-168"><a id="__codelineno-21-168" name="__codelineno-21-168" href="#__codelineno-21-168"></a><span class="cm">         */</span>
</span><span id="__span-21-169"><a id="__codelineno-21-169" name="__codelineno-21-169" href="#__codelineno-21-169"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="n">ClientType</span><span class="w"> </span><span class="n">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-170"><a id="__codelineno-21-170" name="__codelineno-21-170" href="#__codelineno-21-170"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mRateInfoByClient</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">client</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-171"><a id="__codelineno-21-171" name="__codelineno-21-171" href="#__codelineno-21-171"></a><span class="w">                </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-21-172"><a id="__codelineno-21-172" name="__codelineno-21-172" href="#__codelineno-21-172"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-21-173"><a id="__codelineno-21-173" name="__codelineno-21-173" href="#__codelineno-21-173"></a><span class="w">            </span><span class="n">RateInfo</span><span class="w"> </span><span class="n">rateInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mRateInfoByClient</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span id="__span-21-174"><a id="__codelineno-21-174" name="__codelineno-21-174" href="#__codelineno-21-174"></a><span class="w">            </span><span class="c1">// 如果该客户端启用了可变更新率，减少计数</span>
</span><span id="__span-21-175"><a id="__codelineno-21-175" name="__codelineno-21-175" href="#__codelineno-21-175"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rateInfo</span><span class="p">.</span><span class="na">enableVariableUpdateRate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-176"><a id="__codelineno-21-176" name="__codelineno-21-176" href="#__codelineno-21-176"></a><span class="w">                </span><span class="n">mEnableVariableUpdateRateCount</span><span class="o">--</span><span class="p">;</span>
</span><span id="__span-21-177"><a id="__codelineno-21-177" name="__codelineno-21-177" href="#__codelineno-21-177"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-21-178"><a id="__codelineno-21-178" name="__codelineno-21-178" href="#__codelineno-21-178"></a><span class="w">            </span><span class="c1">// 更新更新频率的相关数据</span>
</span><span id="__span-21-179"><a id="__codelineno-21-179" name="__codelineno-21-179" href="#__codelineno-21-179"></a><span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">updateRateHz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rateInfo</span><span class="p">.</span><span class="na">updateRateHz</span><span class="p">;</span>
</span><span id="__span-21-180"><a id="__codelineno-21-180" name="__codelineno-21-180" href="#__codelineno-21-180"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mClientCountByUpdateRateHz</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">updateRateHz</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-181"><a id="__codelineno-21-181" name="__codelineno-21-181" href="#__codelineno-21-181"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">newCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mClientCountByUpdateRateHz</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">updateRateHz</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-21-182"><a id="__codelineno-21-182" name="__codelineno-21-182" href="#__codelineno-21-182"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-183"><a id="__codelineno-21-183" name="__codelineno-21-183" href="#__codelineno-21-183"></a><span class="w">                    </span><span class="n">mClientCountByUpdateRateHz</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">updateRateHz</span><span class="p">);</span>
</span><span id="__span-21-184"><a id="__codelineno-21-184" name="__codelineno-21-184" href="#__codelineno-21-184"></a><span class="w">                    </span><span class="n">mUpdateRatesHz</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">updateRateHz</span><span class="p">);</span>
</span><span id="__span-21-185"><a id="__codelineno-21-185" name="__codelineno-21-185" href="#__codelineno-21-185"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-186"><a id="__codelineno-21-186" name="__codelineno-21-186" href="#__codelineno-21-186"></a><span class="w">                    </span><span class="n">mClientCountByUpdateRateHz</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">updateRateHz</span><span class="p">,</span><span class="w"> </span><span class="n">newCount</span><span class="p">);</span>
</span><span id="__span-21-187"><a id="__codelineno-21-187" name="__codelineno-21-187" href="#__codelineno-21-187"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-21-188"><a id="__codelineno-21-188" name="__codelineno-21-188" href="#__codelineno-21-188"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-21-189"><a id="__codelineno-21-189" name="__codelineno-21-189" href="#__codelineno-21-189"></a><span class="w">            </span><span class="c1">// 更新分辨率的相关数据</span>
</span><span id="__span-21-190"><a id="__codelineno-21-190" name="__codelineno-21-190" href="#__codelineno-21-190"></a><span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rateInfo</span><span class="p">.</span><span class="na">resolution</span><span class="p">;</span>
</span><span id="__span-21-191"><a id="__codelineno-21-191" name="__codelineno-21-191" href="#__codelineno-21-191"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mClientCountByResolution</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">resolution</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-192"><a id="__codelineno-21-192" name="__codelineno-21-192" href="#__codelineno-21-192"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">newCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mClientCountByResolution</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-21-193"><a id="__codelineno-21-193" name="__codelineno-21-193" href="#__codelineno-21-193"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-194"><a id="__codelineno-21-194" name="__codelineno-21-194" href="#__codelineno-21-194"></a><span class="w">                    </span><span class="n">mClientCountByResolution</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">resolution</span><span class="p">);</span>
</span><span id="__span-21-195"><a id="__codelineno-21-195" name="__codelineno-21-195" href="#__codelineno-21-195"></a><span class="w">                    </span><span class="n">mResolutions</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">resolution</span><span class="p">);</span>
</span><span id="__span-21-196"><a id="__codelineno-21-196" name="__codelineno-21-196" href="#__codelineno-21-196"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-197"><a id="__codelineno-21-197" name="__codelineno-21-197" href="#__codelineno-21-197"></a><span class="w">                    </span><span class="n">mClientCountByResolution</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span><span class="w"> </span><span class="n">newCount</span><span class="p">);</span>
</span><span id="__span-21-198"><a id="__codelineno-21-198" name="__codelineno-21-198" href="#__codelineno-21-198"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-21-199"><a id="__codelineno-21-199" name="__codelineno-21-199" href="#__codelineno-21-199"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-21-200"><a id="__codelineno-21-200" name="__codelineno-21-200" href="#__codelineno-21-200"></a>
</span><span id="__span-21-201"><a id="__codelineno-21-201" name="__codelineno-21-201" href="#__codelineno-21-201"></a><span class="w">            </span><span class="c1">// 移除该客户端的订阅信息</span>
</span><span id="__span-21-202"><a id="__codelineno-21-202" name="__codelineno-21-202" href="#__codelineno-21-202"></a><span class="w">            </span><span class="n">mRateInfoByClient</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span id="__span-21-203"><a id="__codelineno-21-203" name="__codelineno-21-203" href="#__codelineno-21-203"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-204"><a id="__codelineno-21-204" name="__codelineno-21-204" href="#__codelineno-21-204"></a>
</span><span id="__span-21-205"><a id="__codelineno-21-205" name="__codelineno-21-205" href="#__codelineno-21-205"></a><span class="w">        </span><span class="cm">/**</span>
</span><span id="__span-21-206"><a id="__codelineno-21-206" name="__codelineno-21-206" href="#__codelineno-21-206"></a><span class="cm">         * 判断是否没有任何客户端订阅。</span>
</span><span id="__span-21-207"><a id="__codelineno-21-207" name="__codelineno-21-207" href="#__codelineno-21-207"></a><span class="cm">         */</span>
</span><span id="__span-21-208"><a id="__codelineno-21-208" name="__codelineno-21-208" href="#__codelineno-21-208"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isEmpty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-209"><a id="__codelineno-21-209" name="__codelineno-21-209" href="#__codelineno-21-209"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">mRateInfoByClient</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">();</span>
</span><span id="__span-21-210"><a id="__codelineno-21-210" name="__codelineno-21-210" href="#__codelineno-21-210"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-211"><a id="__codelineno-21-211" name="__codelineno-21-211" href="#__codelineno-21-211"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-21-212"><a id="__codelineno-21-212" name="__codelineno-21-212" href="#__codelineno-21-212"></a>
</span><span id="__span-21-213"><a id="__codelineno-21-213" name="__codelineno-21-213" href="#__codelineno-21-213"></a><span class="w">    </span><span class="c1">// 当前订阅状态：存储每个 {propertyId, areaId} 对应的所有客户端信息</span>
</span><span id="__span-21-214"><a id="__codelineno-21-214" name="__codelineno-21-214" href="#__codelineno-21-214"></a><span class="w">    </span><span class="n">PairSparseArray</span><span class="o">&lt;</span><span class="n">RateInfoForClients</span><span class="o">&lt;</span><span class="n">ClientType</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">mCurrentRateInfoByClientByPropIdAreaId</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-21-215"><a id="__codelineno-21-215" name="__codelineno-21-215" href="#__codelineno-21-215"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">PairSparseArray</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-21-216"><a id="__codelineno-21-216" name="__codelineno-21-216" href="#__codelineno-21-216"></a>
</span><span id="__span-21-217"><a id="__codelineno-21-217" name="__codelineno-21-217" href="#__codelineno-21-217"></a><span class="w">    </span><span class="c1">// 暂存订阅状态：存储待应用的更改</span>
</span><span id="__span-21-218"><a id="__codelineno-21-218" name="__codelineno-21-218" href="#__codelineno-21-218"></a><span class="w">    </span><span class="n">PairSparseArray</span><span class="o">&lt;</span><span class="n">RateInfoForClients</span><span class="o">&lt;</span><span class="n">ClientType</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">mStagedRateInfoByClientByPropIdAreaId</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-21-219"><a id="__codelineno-21-219" name="__codelineno-21-219" href="#__codelineno-21-219"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">PairSparseArray</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-21-220"><a id="__codelineno-21-220" name="__codelineno-21-220" href="#__codelineno-21-220"></a>
</span><span id="__span-21-221"><a id="__codelineno-21-221" name="__codelineno-21-221" href="#__codelineno-21-221"></a><span class="w">    </span><span class="c1">// 暂存的受影响的属性 ID 和区域 ID</span>
</span><span id="__span-21-222"><a id="__codelineno-21-222" name="__codelineno-21-222" href="#__codelineno-21-222"></a><span class="w">    </span><span class="n">ArraySet</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">mStagedAffectedPropIdAreaIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArraySet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-21-223"><a id="__codelineno-21-223" name="__codelineno-21-223" href="#__codelineno-21-223"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>SubscriptionManager</code> 类用于管理订阅系统的两个状态：当前状态和暂存状态。通过提供的 <code>add</code> 和 <code>remove</code> 方法，管理每个客户端对指定 <code>{propertyId, areaId}</code> 对应的订阅信息，同时支持暂存变更、计算合并后的更新信息、以及提交或丢弃暂存的操作。</p>
<ul>
<li><code>RateInfo</code> 类：用于表示单个客户端的订阅信息，包括更新频率 (<code>updateRateHz</code>)、是否启用可变更新率 (<code>enableVariableUpdateRate</code>)、以及分辨率 (<code>resolution</code>)。</li>
<li><code>RateInfoForClients</code> 类：用于存储某个 <code>{propertyId, areaId}</code> 对应的所有客户端的订阅信息。该类通过 <code>mRateInfoByClient</code> 存储每个客户端的订阅信息，此外，还维护了更新频率和分辨率的有序集合 (<code>TreeSet</code>) 和 <code>ArrayMap</code> 来高效地管理更新频率和分辨率。</li>
</ul>
<h4 id="subscriptionmanagerstagenewoptions">SubscriptionManager.stageNewOptions()<a class="headerlink" href="#subscriptionmanagerstagenewoptions" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1">// packages/services/Car/car-lib/src/com/android/car/internal/property/SubscriptionManager.java</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="cm">/**</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="cm"> * 准备新的订阅选项。</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="cm"> *</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="cm"> * 这个方法将新的订阅选项应用到暂存区，但不会立即提交它们。</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="cm"> * 客户端应该调用 {@link #diffBetweenCurrentAndStage} 获取当前状态和暂存状态之间的差异。</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="cm"> * 然后将差异应用到底层系统，在操作成功后提交更改，或者在操作失败时丢弃更改。</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="cm"> *</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="cm"> * @param client 客户端对象</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="cm"> * @param options 新的订阅选项列表</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="cm"> */</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stageNewOptions</span><span class="p">(</span><span class="n">ClientType</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">CarSubscription</span><span class="o">&gt;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="w">    </span><span class="c1">// 调试模式下打印日志，显示即将应用的订阅选项</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stageNewOptions: options: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="w">    </span><span class="c1">// 如果当前状态是干净的（即没有待提交的更改），则克隆当前状态到暂存区</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="w">    </span><span class="n">cloneCurrentToStageIfClean</span><span class="p">();</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="w">    </span><span class="c1">// 遍历每一个订阅选项</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="w">        </span><span class="n">CarSubscription</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">propertyId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">option</span><span class="p">.</span><span class="na">propertyId</span><span class="p">;</span><span class="w"> </span><span class="c1">// 获取订阅的属性 ID</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="w">        </span><span class="c1">// 遍历每个区域 ID</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">option</span><span class="p">.</span><span class="na">areaIds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a><span class="w">            </span><span class="c1">// 将该 {propertyId, areaId} 对应的订阅信息添加到暂存区</span>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="w">            </span><span class="n">mStagedAffectedPropIdAreaIds</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">});</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a><span class="w">            </span><span class="c1">// 检查该 {propertyId, areaId} 是否已经在暂存区中存在，如果不存在则创建新的 `RateInfoForClients` 对象</span>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mStagedRateInfoByClientByPropIdAreaId</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a><span class="w">                </span><span class="n">mStagedRateInfoByClientByPropIdAreaId</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">,</span>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a><span class="w">                        </span><span class="k">new</span><span class="w"> </span><span class="n">RateInfoForClients</span><span class="o">&lt;&gt;</span><span class="p">());</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>
</span><span id="__span-22-38"><a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a><span class="w">            </span><span class="c1">// 将当前客户端的订阅信息添加到暂存区的相应位置</span>
</span><span id="__span-22-39"><a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a><span class="w">            </span><span class="n">mStagedRateInfoByClientByPropIdAreaId</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">).</span><span class="na">add</span><span class="p">(</span>
</span><span id="__span-22-40"><a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a><span class="w">                    </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">option</span><span class="p">.</span><span class="na">updateRateHz</span><span class="p">,</span><span class="w"> </span><span class="n">option</span><span class="p">.</span><span class="na">enableVariableUpdateRate</span><span class="p">,</span>
</span><span id="__span-22-41"><a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a><span class="w">                    </span><span class="n">option</span><span class="p">.</span><span class="na">resolution</span><span class="p">);</span>
</span><span id="__span-22-42"><a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-43"><a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-22-44"><a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>stageNewOptions</code> 的目的是准备新的订阅选项，将它们放入“暂存区”，但并不直接提交。这样，客户端可以检查当前订阅状态和暂存状态之间的差异，确认是否成功后再决定提交（<code>commit</code>）或者丢弃（<code>dropCommit</code>）这些变更。
- <code>client</code>：表示正在提交订阅请求的客户端对象，也就是 <code>CarPropertyServiceClient</code> 。
- <code>options</code>：一个 <code>CarSubscription</code> 对象的列表，包含了客户端希望订阅的属性信息。每个 <code>CarSubscription</code> 对象中包括：
    - - <code>propertyId</code>：属性的 ID。
    - <code>areaIds</code>：该属性所在的区域 ID 列表。
    - <code>updateRateHz</code>：更新频率（Hz）。
    - <code>enableVariableUpdateRate</code>：是否启用可变更新率。
    - <code>resolution</code>：订阅的分辨率。</p>
<h4 id="carpropertyserviceapplystagedchangeslocked">CarPropertyService.applyStagedChangesLocked()<a class="headerlink" href="#carpropertyserviceapplystagedchangeslocked" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/CarPropertyService.java</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="cm">/**</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="cm"> * 应用暂存的订阅变更。</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="cm"> *</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="cm"> * 这个方法在同步锁保护下应用暂存区中待处理的订阅更改。</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="cm"> * 它首先通过比较当前状态与暂存区状态之间的差异，来确定哪些订阅需要被添加、修改或移除。</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="cm"> * 然后，它会将变化应用到底层的 `PropertyHalService` 中，以更新车辆属性服务的订阅状态。</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="cm"> *</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="cm"> * @throws ServiceSpecificException 如果在操作过程中发生服务特定的异常，会抛出此异常</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="cm"> */</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="nd">@GuardedBy</span><span class="p">(</span><span class="s">&quot;mLock&quot;</span><span class="p">)</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="kt">void</span><span class="w"> </span><span class="nf">applyStagedChangesLocked</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="w">    </span><span class="c1">// 创建两个列表来存储需要处理的订阅信息</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">CarSubscription</span><span class="o">&gt;</span><span class="w"> </span><span class="n">filteredSubscriptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">  </span><span class="c1">// 存储需要订阅的属性</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">propertyIdsToUnsubscribe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">       </span><span class="c1">// 存储需要取消订阅的属性 ID</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="w">    </span><span class="c1">// 获取当前和暂存区之间的差异，分别填充 `filteredSubscriptions` 和 `propertyIdsToUnsubscribe` 两个列表</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="w">    </span><span class="n">mSubscriptionManager</span><span class="p">.</span><span class="na">diffBetweenCurrentAndStage</span><span class="p">(</span><span class="cm">/* out */</span><span class="w"> </span><span class="n">filteredSubscriptions</span><span class="p">,</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="w">                </span><span class="cm">/* out */</span><span class="w"> </span><span class="n">propertyIdsToUnsubscribe</span><span class="p">);</span>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="w">    </span><span class="c1">// 在调试模式下，打印经过过滤的订阅信息</span>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="w">        </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Subscriptions after filtering out options that are already&quot;</span>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; subscribed at the same or a higher rate: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filteredSubscriptions</span><span class="p">);</span>
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>
</span><span id="__span-23-28"><a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a><span class="w">    </span><span class="c1">// 如果需要订阅的属性列表不为空，则执行订阅操作</span>
</span><span id="__span-23-29"><a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">filteredSubscriptions</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-30"><a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-31"><a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a><span class="w">            </span><span class="c1">// 调用 PropertyHalService 的 subscribeProperty 方法，实际进行订阅</span>
</span><span id="__span-23-32"><a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a><span class="w">            </span><span class="n">mPropertyHalService</span><span class="p">.</span><span class="na">subscribeProperty</span><span class="p">(</span><span class="n">filteredSubscriptions</span><span class="p">);</span>
</span><span id="__span-23-33"><a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-34"><a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a><span class="w">            </span><span class="c1">// 如果订阅失败，打印错误日志并抛出异常</span>
</span><span id="__span-23-35"><a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a><span class="w">            </span><span class="n">Slogf</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PropertyHalService.subscribeProperty failed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-23-36"><a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
</span><span id="__span-23-37"><a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-23-38"><a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-39"><a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>
</span><span id="__span-23-40"><a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a><span class="w">    </span><span class="c1">// 遍历需要取消订阅的属性 ID 列表</span>
</span><span id="__span-23-41"><a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">propertyIdsToUnsubscribe</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-42"><a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a><span class="w">        </span><span class="c1">// 打印取消订阅的属性信息</span>
</span><span id="__span-23-43"><a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a><span class="w">        </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Property: %s is no longer subscribed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">propertyIdsToUnsubscribe</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
</span><span id="__span-23-44"><a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>
</span><span id="__span-23-45"><a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-46"><a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a><span class="w">            </span><span class="c1">// 调用 PropertyHalService 的 unsubscribeProperty 方法，实际进行取消订阅</span>
</span><span id="__span-23-47"><a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a><span class="w">            </span><span class="n">mPropertyHalService</span><span class="p">.</span><span class="na">unsubscribeProperty</span><span class="p">(</span><span class="n">propertyIdsToUnsubscribe</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
</span><span id="__span-23-48"><a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-49"><a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a><span class="w">            </span><span class="c1">// 如果取消订阅失败，打印错误日志并抛出异常</span>
</span><span id="__span-23-50"><a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a><span class="w">            </span><span class="n">Slogf</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;failed to call PropertyHalService.unsubscribeProperty&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-23-51"><a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
</span><span id="__span-23-52"><a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-23-53"><a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-54"><a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>applyStagedChangesLocked()</code> 方法的主要目的是在底层 <code>PropertyHalService</code> 中应用暂存的订阅变更。具体来说，它会根据当前订阅状态与暂存区之间的差异，执行以下操作：</p>
<ul>
<li>订阅新的属性，即那些暂存区中有变更且尚未订阅的属性。</li>
<li>取消订阅属性，即那些当前已订阅，但暂存区中已不再需要订阅的属性。</li>
</ul>
<p>具体步骤如下：</p>
<ul>
<li>获取订阅差异：<code>SubscriptionManager.diffBetweenCurrentAndStage()</code> 方法用于计算当前订阅状态和暂存区之间的差异。具体来说，它会填充两个列表：<ul>
<li><code>filteredSubscriptions</code>：包含所有需要新增或更新订阅的属性。</li>
<li><code>propertyIdsToUnsubscribe</code>：包含所有需要取消订阅的属性 ID。</li>
</ul>
</li>
<li>订阅操作：如果 <code>filteredSubscriptions</code> 列表不为空，表示有属性需要订阅。调用 <code>PropertyHalService.subscribeProperty()</code> 方法将这些属性提交给 <code>PropertyHalService</code> 进行订阅。</li>
<li>取消订阅操作：遍历 <code>propertyIdsToUnsubscribe</code> 列表，逐个取消这些属性的订阅。通过调用 <code>PropertyHalService.unsubscribeProperty()</code> 方法来取消订阅。</li>
</ul>
<blockquote>
<p>看到这里就迷惑了，因为前面分析 <code>PropertyHalService.onHalEvents()</code> 我们提到过在 <code>PropertyHalService</code> 中并没有看到主动调用 <code>VehicleHal.subscribePropertySafe()</code> 方法来订阅属性。而是所有支持的属性有变化，默认都会回调到 <code>PropertyHalService.onHalEvents()</code> 里。那这里又调用 <code>PropertyHalService.subscribeProperty()</code> 方法进行订阅。这到底是怎么回事呢？</p>
</blockquote>
<h4 id="subscriptionmanagerdiffbetweencurrentandstage">SubscriptionManager.diffBetweenCurrentAndStage()<a class="headerlink" href="#subscriptionmanagerdiffbetweencurrentandstage" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1">// packages/services/Car/car-lib/src/com/android/car/internal/property/SubscriptionManager.java</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="cm">/**</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="cm"> * 计算暂存区和当前状态之间的差异。</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="cm"> *</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="cm"> * 该方法通过比较当前状态和暂存区的差异，确定哪些订阅需要添加（新订阅或更新订阅），</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="cm"> * 哪些订阅需要取消（不再订阅的属性）。结果会通过输出参数返回。</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="cm"> *</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="cm"> * @param outDiffSubscriptions 输出参数，包含所有发生变化的订阅，既包括新的订阅，也包括更新了更新频率的订阅。</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="cm"> * @param outPropertyIdsToUnsubscribe 输出参数，包含所有需要取消订阅的属性 ID。</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="cm"> */</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">diffBetweenCurrentAndStage</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">CarSubscription</span><span class="o">&gt;</span><span class="w"> </span><span class="n">outDiffSubscriptions</span><span class="p">,</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="w">                                       </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">outPropertyIdsToUnsubscribe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">    </span><span class="c1">// 如果暂存区没有任何变化，直接返回，避免进行不必要的计算</span>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mStagedAffectedPropIdAreaIds</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;No changes has been staged, no diff&quot;</span><span class="p">);</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="w">    </span><span class="c1">// 记录可能需要取消订阅的属性 ID</span>
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="w">    </span><span class="n">ArraySet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">possiblePropIdsToUnsubscribe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArraySet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a>
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="w">    </span><span class="c1">// 存储当前差异的属性和更新信息</span>
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a><span class="w">    </span><span class="n">PairSparseArray</span><span class="o">&lt;</span><span class="n">RateInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">diffRateInfoByPropIdAreaId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PairSparseArray</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a>
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a><span class="w">    </span><span class="c1">// 遍历所有暂存区中受影响的属性 ID 和区域 ID</span>
</span><span id="__span-24-29"><a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mStagedAffectedPropIdAreaIds</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-30"><a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a><span class="w">        </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">propIdAreaId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mStagedAffectedPropIdAreaIds</span><span class="p">.</span><span class="na">valueAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-24-31"><a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">propertyId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">propIdAreaId</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-24-32"><a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">propIdAreaId</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-24-33"><a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a>
</span><span id="__span-24-34"><a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a><span class="w">        </span><span class="c1">// 如果暂存区中没有该属性和区域的订阅，表示该属性不再被订阅</span>
</span><span id="__span-24-35"><a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mStagedRateInfoByClientByPropIdAreaId</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-36"><a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a><span class="w">            </span><span class="c1">// 在调试模式下，打印不再订阅的属性信息</span>
</span><span id="__span-24-37"><a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-38"><a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;The property: %s, areaId: %d is no longer &quot;</span>
</span><span id="__span-24-39"><a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;subscribed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">VehiclePropertyIds</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">propertyId</span><span class="p">),</span><span class="w"> </span><span class="n">areaId</span><span class="p">));</span>
</span><span id="__span-24-40"><a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-41"><a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a><span class="w">            </span><span class="c1">// 将该属性的 ID 添加到取消订阅的列表中</span>
</span><span id="__span-24-42"><a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a><span class="w">            </span><span class="n">possiblePropIdsToUnsubscribe</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">propertyId</span><span class="p">);</span>
</span><span id="__span-24-43"><a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-24-44"><a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-24-45"><a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a>
</span><span id="__span-24-46"><a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a><span class="w">        </span><span class="c1">// 获取暂存区中该属性和区域的新的订阅信息</span>
</span><span id="__span-24-47"><a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a><span class="w">        </span><span class="n">RateInfo</span><span class="w"> </span><span class="n">newCombinedRateInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mStagedRateInfoByClientByPropIdAreaId</span>
</span><span id="__span-24-48"><a id="__codelineno-24-48" name="__codelineno-24-48" href="#__codelineno-24-48"></a><span class="w">                </span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">).</span><span class="na">getCombinedRateInfo</span><span class="p">();</span>
</span><span id="__span-24-49"><a id="__codelineno-24-49" name="__codelineno-24-49" href="#__codelineno-24-49"></a>
</span><span id="__span-24-50"><a id="__codelineno-24-50" name="__codelineno-24-50" href="#__codelineno-24-50"></a><span class="w">        </span><span class="c1">// 比较当前状态与暂存状态，如果发生了变化，记录新的订阅信息</span>
</span><span id="__span-24-51"><a id="__codelineno-24-51" name="__codelineno-24-51" href="#__codelineno-24-51"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mCurrentRateInfoByClientByPropIdAreaId</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">)</span>
</span><span id="__span-24-52"><a id="__codelineno-24-52" name="__codelineno-24-52" href="#__codelineno-24-52"></a><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">mCurrentRateInfoByClientByPropIdAreaId</span>
</span><span id="__span-24-53"><a id="__codelineno-24-53" name="__codelineno-24-53" href="#__codelineno-24-53"></a><span class="w">                </span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">).</span><span class="na">getCombinedRateInfo</span><span class="p">()</span>
</span><span id="__span-24-54"><a id="__codelineno-24-54" name="__codelineno-24-54" href="#__codelineno-24-54"></a><span class="w">                </span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">newCombinedRateInfo</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-55"><a id="__codelineno-24-55" name="__codelineno-24-55" href="#__codelineno-24-55"></a><span class="w">            </span><span class="c1">// 在调试模式下，打印新的订阅信息</span>
</span><span id="__span-24-56"><a id="__codelineno-24-56" name="__codelineno-24-56" href="#__codelineno-24-56"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-57"><a id="__codelineno-24-57" name="__codelineno-24-57" href="#__codelineno-24-57"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span>
</span><span id="__span-24-58"><a id="__codelineno-24-58" name="__codelineno-24-58" href="#__codelineno-24-58"></a><span class="w">                        </span><span class="s">&quot;New combined subscription rate info for property: %s, areaId: %d, %s&quot;</span><span class="p">,</span>
</span><span id="__span-24-59"><a id="__codelineno-24-59" name="__codelineno-24-59" href="#__codelineno-24-59"></a><span class="w">                        </span><span class="n">VehiclePropertyIds</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">propertyId</span><span class="p">),</span><span class="w"> </span><span class="n">areaId</span><span class="p">,</span><span class="w"> </span><span class="n">newCombinedRateInfo</span><span class="p">));</span>
</span><span id="__span-24-60"><a id="__codelineno-24-60" name="__codelineno-24-60" href="#__codelineno-24-60"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-61"><a id="__codelineno-24-61" name="__codelineno-24-61" href="#__codelineno-24-61"></a><span class="w">            </span><span class="c1">// 记录该属性的订阅信息变化</span>
</span><span id="__span-24-62"><a id="__codelineno-24-62" name="__codelineno-24-62" href="#__codelineno-24-62"></a><span class="w">            </span><span class="n">diffRateInfoByPropIdAreaId</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">,</span><span class="w"> </span><span class="n">newCombinedRateInfo</span><span class="p">);</span>
</span><span id="__span-24-63"><a id="__codelineno-24-63" name="__codelineno-24-63" href="#__codelineno-24-63"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-24-64"><a id="__codelineno-24-64" name="__codelineno-24-64" href="#__codelineno-24-64"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-24-65"><a id="__codelineno-24-65" name="__codelineno-24-65" href="#__codelineno-24-65"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-24-66"><a id="__codelineno-24-66" name="__codelineno-24-66" href="#__codelineno-24-66"></a>
</span><span id="__span-24-67"><a id="__codelineno-24-67" name="__codelineno-24-67" href="#__codelineno-24-67"></a><span class="w">    </span><span class="c1">// 将计算出的差异转换为实际的订阅信息，添加到输出参数 `outDiffSubscriptions` 中</span>
</span><span id="__span-24-68"><a id="__codelineno-24-68" name="__codelineno-24-68" href="#__codelineno-24-68"></a><span class="w">    </span><span class="n">outDiffSubscriptions</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">getCarSubscription</span><span class="p">(</span><span class="n">diffRateInfoByPropIdAreaId</span><span class="p">));</span>
</span><span id="__span-24-69"><a id="__codelineno-24-69" name="__codelineno-24-69" href="#__codelineno-24-69"></a>
</span><span id="__span-24-70"><a id="__codelineno-24-70" name="__codelineno-24-70" href="#__codelineno-24-70"></a><span class="w">    </span><span class="c1">// 遍历可能需要取消订阅的属性 ID，检查是否所有区域都已取消订阅</span>
</span><span id="__span-24-71"><a id="__codelineno-24-71" name="__codelineno-24-71" href="#__codelineno-24-71"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">possiblePropIdsToUnsubscribe</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-72"><a id="__codelineno-24-72" name="__codelineno-24-72" href="#__codelineno-24-72"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">possiblePropIdToUnsubscribe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">possiblePropIdsToUnsubscribe</span><span class="p">.</span><span class="na">valueAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-24-73"><a id="__codelineno-24-73" name="__codelineno-24-73" href="#__codelineno-24-73"></a><span class="w">        </span><span class="c1">// 如果该属性的所有区域都不再订阅，则可以取消该属性的订阅</span>
</span><span id="__span-24-74"><a id="__codelineno-24-74" name="__codelineno-24-74" href="#__codelineno-24-74"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mStagedRateInfoByClientByPropIdAreaId</span><span class="p">.</span><span class="na">getSecondKeysForFirstKey</span><span class="p">(</span>
</span><span id="__span-24-75"><a id="__codelineno-24-75" name="__codelineno-24-75" href="#__codelineno-24-75"></a><span class="w">                </span><span class="n">possiblePropIdToUnsubscribe</span><span class="p">).</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-76"><a id="__codelineno-24-76" name="__codelineno-24-76" href="#__codelineno-24-76"></a><span class="w">            </span><span class="c1">// 在调试模式下，打印需要取消订阅的属性信息</span>
</span><span id="__span-24-77"><a id="__codelineno-24-77" name="__codelineno-24-77" href="#__codelineno-24-77"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-78"><a id="__codelineno-24-78" name="__codelineno-24-78" href="#__codelineno-24-78"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span>
</span><span id="__span-24-79"><a id="__codelineno-24-79" name="__codelineno-24-79" href="#__codelineno-24-79"></a><span class="w">                        </span><span class="s">&quot;All areas for the property: %s are no longer subscribed, &quot;</span>
</span><span id="__span-24-80"><a id="__codelineno-24-80" name="__codelineno-24-80" href="#__codelineno-24-80"></a><span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;unsubscribe it&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">VehiclePropertyIds</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span>
</span><span id="__span-24-81"><a id="__codelineno-24-81" name="__codelineno-24-81" href="#__codelineno-24-81"></a><span class="w">                                </span><span class="n">possiblePropIdToUnsubscribe</span><span class="p">)));</span>
</span><span id="__span-24-82"><a id="__codelineno-24-82" name="__codelineno-24-82" href="#__codelineno-24-82"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-83"><a id="__codelineno-24-83" name="__codelineno-24-83" href="#__codelineno-24-83"></a><span class="w">            </span><span class="c1">// 将该属性 ID 添加到需要取消订阅的列表中</span>
</span><span id="__span-24-84"><a id="__codelineno-24-84" name="__codelineno-24-84" href="#__codelineno-24-84"></a><span class="w">            </span><span class="n">outPropertyIdsToUnsubscribe</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">possiblePropIdToUnsubscribe</span><span class="p">);</span>
</span><span id="__span-24-85"><a id="__codelineno-24-85" name="__codelineno-24-85" href="#__codelineno-24-85"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-24-86"><a id="__codelineno-24-86" name="__codelineno-24-86" href="#__codelineno-24-86"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-24-87"><a id="__codelineno-24-87" name="__codelineno-24-87" href="#__codelineno-24-87"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>diffBetweenCurrentAndStage()</code> 方法通过比较当前订阅状态（<code>mCurrentRateInfoByClientByPropIdAreaId</code>）和暂存状态（<code>mStagedRateInfoByClientByPropIdAreaId</code>）的差异，来生成变更列表。
- <code>outDiffSubscriptions</code>：输出参数，包含需要新增或更新的订阅信息。
- <code>outPropertyIdsToUnsubscribe</code>：输出参数，包含需要取消订阅的属性 ID。</p>
<h4 id="propertyhalservicesubscribeproperty">PropertyHalService.subscribeProperty()<a class="headerlink" href="#propertyhalservicesubscribeproperty" title="Permanent link">&para;</a></h4>
<p>回到 <code>CarPropertyService.applyStagedChangesLocked()</code> 中，如果 <code>filteredSubscriptions</code> 列表不为空，表示有属性需要订阅。调用 <code>PropertyHalService.subscribeProperty()</code> 方法将这些属性提交给 <code>PropertyHalService</code> 进行订阅。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/PropertyHalService.java</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PropertyHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">    </span><span class="cm">/**  </span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="cm">     * 订阅指定属性，并设置更新频率（以 Hz 为单位）和区域 ID。  </span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="cm">     *  </span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="cm">     * @param carSubscriptions 包含需要订阅的车辆属性订阅列表。该列表不能为空，已经在 CarPropertyService 中进行了检查。  </span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="cm">     * @throws ServiceSpecificException 如果 VHAL 返回错误，将抛出该异常。  </span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="cm">     */</span><span class="w">  </span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">subscribeProperty</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">CarSubscription</span><span class="o">&gt;</span><span class="w"> </span><span class="n">carSubscriptions</span><span class="p">)</span><span class="w">  </span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="w">        </span><span class="c1">// 锁定共享资源，保证线程安全，确保在执行此操作时订阅管理器的状态与 VHAL 中的状态一致。  </span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="w">            </span><span class="c1">// 遍历所有传入的订阅项，逐个处理  </span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">carSubscriptions</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="w">                </span><span class="c1">// 获取每个订阅项  </span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="w">                </span><span class="n">CarSubscription</span><span class="w"> </span><span class="n">carSubscription</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carSubscriptions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="w">                </span><span class="c1">// 获取订阅的属性 ID                int mgrPropId = carSubscription.propertyId;  </span>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="w">                </span><span class="c1">// 获取对应的区域 ID                int[] areaIds = carSubscription.areaIds;  </span>
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="w">                </span><span class="c1">// 获取更新频率（单位：Hz）  </span>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">updateRateHz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carSubscription</span><span class="p">.</span><span class="na">updateRateHz</span><span class="p">;</span><span class="w">  </span>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a>
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="w">                </span><span class="c1">// 如果开启了调试日志输出，则打印相关信息  </span>
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="w">                    </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;subscribeProperty propertyId: %s, updateRateHz=%f&quot;</span><span class="p">,</span><span class="w">  </span>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="w">                            </span><span class="n">VehiclePropertyIds</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">mgrPropId</span><span class="p">),</span><span class="w"> </span><span class="n">updateRateHz</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="w">                </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a>
</span><span id="__span-25-29"><a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a><span class="w">                </span><span class="c1">// 将 manager 中的属性 ID 转换为 HAL 层使用的属性 ID                int halPropId = managerToHalPropId(mgrPropId);  </span>
</span><span id="__span-25-30"><a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a>
</span><span id="__span-25-31"><a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a><span class="w">                </span><span class="c1">// 需要注意的是，实际在订阅管理器中使用的是 halPropId，而不是 mgrPropId                // 使用 halPropId 进行订阅请求  </span>
</span><span id="__span-25-32"><a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a><span class="w">                </span><span class="n">mSubManager</span><span class="p">.</span><span class="na">stageNewOptions</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ClientType</span><span class="p">(</span><span class="n">CAR_PROP_SVC_REQUEST_ID</span><span class="p">),</span><span class="w">  </span>
</span><span id="__span-25-33"><a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a><span class="w">                        </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">newCarSubscription</span><span class="p">(</span><span class="n">halPropId</span><span class="p">,</span><span class="w"> </span><span class="n">areaIds</span><span class="p">,</span><span class="w"> </span><span class="n">updateRateHz</span><span class="p">,</span><span class="w">  </span>
</span><span id="__span-25-34"><a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a><span class="w">                                </span><span class="n">carSubscription</span><span class="p">.</span><span class="na">enableVariableUpdateRate</span><span class="p">,</span><span class="w"> </span><span class="n">carSubscription</span><span class="p">.</span><span class="na">resolution</span><span class="p">)));</span><span class="w">  </span>
</span><span id="__span-25-35"><a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a><span class="w">            </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-25-36"><a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a>
</span><span id="__span-25-37"><a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a><span class="w">            </span><span class="c1">// 尝试更新订阅频率  </span>
</span><span id="__span-25-38"><a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-25-39"><a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a><span class="w">                </span><span class="n">updateSubscriptionRateLocked</span><span class="p">();</span><span class="w">  </span>
</span><span id="__span-25-40"><a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-25-41"><a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a><span class="w">                </span><span class="c1">// 如果更新订阅频率失败，记录错误并抛出异常  </span>
</span><span id="__span-25-42"><a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a><span class="w">                </span><span class="n">Slogf</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to update subscription rate for subscribe&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-25-43"><a id="__codelineno-25-43" name="__codelineno-25-43" href="#__codelineno-25-43"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w">  </span>
</span><span id="__span-25-44"><a id="__codelineno-25-44" name="__codelineno-25-44" href="#__codelineno-25-44"></a><span class="w">            </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-25-45"><a id="__codelineno-25-45" name="__codelineno-25-45" href="#__codelineno-25-45"></a><span class="w">        </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-25-46"><a id="__codelineno-25-46" name="__codelineno-25-46" href="#__codelineno-25-46"></a><span class="w">    </span><span class="p">}</span><span class="w">  </span>
</span><span id="__span-25-47"><a id="__codelineno-25-47" name="__codelineno-25-47" href="#__codelineno-25-47"></a><span class="p">}</span>
</span></code></pre></div>
<p>在这里又看到再次调用 <code>SubscriptionManager.stageNewOptions()</code> 了，在前面的 <code>CarPropertyService.registerListener()</code> 里就调用一次了，但是这里有一个很明显的区别是给了 <strong>假的请求 ID</strong> <code>CAR_PROP_SVC_REQUEST_ID</code> ，主要的作用是帮助区分 <strong>车属性服务的订阅</strong> 和 <strong>其他异步请求的订阅</strong>。</p>
<p>但是这样也有疑问：那什么是 <strong>车属性服务的订阅</strong> 和 <strong>其他异步请求的订阅</strong> ？</p>
<h5 id="propertyhalserviceupdatesubscriptionratelocked">PropertyHalService.updateSubscriptionRateLocked()<a class="headerlink" href="#propertyhalserviceupdatesubscriptionratelocked" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/PropertyHalService.java</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PropertyHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="cm">     * 将 {@code mSubManager} 中的暂存订阅更新率应用到 VHAL。</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="cm">     *</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="cm">     * 使用 {@code subscribeProperty} 更新订阅率，或者如果不再订阅，则使用 {@code unsubscribeProperty} 取消订阅。</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="cm">     *</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="cm">     * 这个函数涉及到 VHAL 的 Binder 调用，但我们有意将其保持在锁内部，因为我们需要保持订阅状态的一致性。</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="cm">     * 如果不在这里使用锁，可能会发生以下情况：</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="cm">     *</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="cm">     * &lt;ol&gt;</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="cm">     * &lt;li&gt;线程1获取锁。&lt;/li&gt;</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="cm">     * &lt;li&gt;线程1将 mSubManager 更新为状态1。&lt;/li&gt;</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="cm">     * &lt;li&gt;根据状态1计算新的更新频率（局部变量）。&lt;/li&gt;</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="cm">     * &lt;li&gt;线程1释放锁。&lt;/li&gt;</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="cm">     * &lt;li&gt;线程2获取锁。&lt;/li&gt;</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="cm">     * &lt;li&gt;线程2将 mSubManager 更新为状态2。&lt;/li&gt;</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="cm">     * &lt;li&gt;根据状态2计算新的更新频率（局部变量）。&lt;/li&gt;</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="cm">     * &lt;li&gt;线程2释放锁。&lt;/li&gt;</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="cm">     * &lt;li&gt;线程2基于状态2调用 subscribeProperty 到 VHAL。&lt;/li&gt;</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="cm">     * &lt;li&gt;线程1基于状态1调用 subscribeProperty 到 VHAL。&lt;/li&gt;</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="cm">     * &lt;li&gt;现在内部状态是状态2，但 VHAL 中是状态1。&lt;/li&gt;</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="cm">     * &lt;/ol&gt;</span>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="cm">     */</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="w">    </span><span class="nd">@GuardedBy</span><span class="p">(</span><span class="s">&quot;mLock&quot;</span><span class="p">)</span>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateSubscriptionRateLocked</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a><span class="w">        </span><span class="c1">// 用于存储差异化的订阅选项</span>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">CarSubscription</span><span class="o">&gt;</span><span class="w"> </span><span class="n">diffSubscribeOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a><span class="w">        </span><span class="c1">// 用于存储需要取消订阅的属性 ID</span>
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">propIdsToUnsubscribe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-26-32"><a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a>
</span><span id="__span-26-33"><a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a><span class="w">        </span><span class="c1">// 获取当前状态与暂存状态之间的差异</span>
</span><span id="__span-26-34"><a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a><span class="w">        </span><span class="n">mSubManager</span><span class="p">.</span><span class="na">diffBetweenCurrentAndStage</span><span class="p">(</span><span class="n">diffSubscribeOptions</span><span class="p">,</span><span class="w"> </span><span class="n">propIdsToUnsubscribe</span><span class="p">);</span>
</span><span id="__span-26-35"><a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a>
</span><span id="__span-26-36"><a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-37"><a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a><span class="w">            </span><span class="c1">// 如果有新的订阅选项（即差异化的订阅选项），则进行订阅操作</span>
</span><span id="__span-26-38"><a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">diffSubscribeOptions</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-39"><a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-40"><a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a><span class="w">                    </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;subscribeProperty, options: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">diffSubscribeOptions</span><span class="p">);</span>
</span><span id="__span-26-41"><a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-26-42"><a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a><span class="w">                </span><span class="c1">// 可能会抛出 ServiceSpecificException</span>
</span><span id="__span-26-43"><a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a><span class="w">                </span><span class="n">mVehicleHal</span><span class="p">.</span><span class="na">subscribeProperty</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">toHalSubscribeOptions</span><span class="p">(</span><span class="n">diffSubscribeOptions</span><span class="p">));</span>
</span><span id="__span-26-44"><a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-26-45"><a id="__codelineno-26-45" name="__codelineno-26-45" href="#__codelineno-26-45"></a>
</span><span id="__span-26-46"><a id="__codelineno-26-46" name="__codelineno-26-46" href="#__codelineno-26-46"></a><span class="w">            </span><span class="c1">// 对于需要取消订阅的属性 ID，调用取消订阅接口</span>
</span><span id="__span-26-47"><a id="__codelineno-26-47" name="__codelineno-26-47" href="#__codelineno-26-47"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">halPropId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">propIdsToUnsubscribe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-48"><a id="__codelineno-26-48" name="__codelineno-26-48" href="#__codelineno-26-48"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-49"><a id="__codelineno-26-49" name="__codelineno-26-49" href="#__codelineno-26-49"></a><span class="w">                    </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;unsubscribeProperty for property ID: %s&quot;</span><span class="p">,</span>
</span><span id="__span-26-50"><a id="__codelineno-26-50" name="__codelineno-26-50" href="#__codelineno-26-50"></a><span class="w">                            </span><span class="n">halPropIdToName</span><span class="p">(</span><span class="n">halPropId</span><span class="p">));</span>
</span><span id="__span-26-51"><a id="__codelineno-26-51" name="__codelineno-26-51" href="#__codelineno-26-51"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-26-52"><a id="__codelineno-26-52" name="__codelineno-26-52" href="#__codelineno-26-52"></a><span class="w">                </span><span class="c1">// 可能会抛出 ServiceSpecificException</span>
</span><span id="__span-26-53"><a id="__codelineno-26-53" name="__codelineno-26-53" href="#__codelineno-26-53"></a><span class="w">                </span><span class="n">mVehicleHal</span><span class="p">.</span><span class="na">unsubscribeProperty</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">halPropId</span><span class="p">);</span>
</span><span id="__span-26-54"><a id="__codelineno-26-54" name="__codelineno-26-54" href="#__codelineno-26-54"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-26-55"><a id="__codelineno-26-55" name="__codelineno-26-55" href="#__codelineno-26-55"></a>
</span><span id="__span-26-56"><a id="__codelineno-26-56" name="__codelineno-26-56" href="#__codelineno-26-56"></a><span class="w">            </span><span class="c1">// 提交订阅更改</span>
</span><span id="__span-26-57"><a id="__codelineno-26-57" name="__codelineno-26-57" href="#__codelineno-26-57"></a><span class="w">            </span><span class="n">mSubManager</span><span class="p">.</span><span class="na">commit</span><span class="p">();</span>
</span><span id="__span-26-58"><a id="__codelineno-26-58" name="__codelineno-26-58" href="#__codelineno-26-58"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-59"><a id="__codelineno-26-59" name="__codelineno-26-59" href="#__codelineno-26-59"></a><span class="w">            </span><span class="c1">// 如果发生参数异常，说明某个属性不支持，应该由调用者确保属性是受支持的</span>
</span><span id="__span-26-60"><a id="__codelineno-26-60" name="__codelineno-26-60" href="#__codelineno-26-60"></a><span class="w">            </span><span class="n">Slogf</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to subscribe/unsubscribe, property is not supported, this should &quot;</span>
</span><span id="__span-26-61"><a id="__codelineno-26-61" name="__codelineno-26-61" href="#__codelineno-26-61"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;not happen, caller must make sure the property is supported&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-26-62"><a id="__codelineno-26-62" name="__codelineno-26-62" href="#__codelineno-26-62"></a><span class="w">            </span><span class="c1">// 丢弃暂存的更改</span>
</span><span id="__span-26-63"><a id="__codelineno-26-63" name="__codelineno-26-63" href="#__codelineno-26-63"></a><span class="w">            </span><span class="n">mSubManager</span><span class="p">.</span><span class="na">dropCommit</span><span class="p">();</span>
</span><span id="__span-26-64"><a id="__codelineno-26-64" name="__codelineno-26-64" href="#__codelineno-26-64"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-26-65"><a id="__codelineno-26-65" name="__codelineno-26-65" href="#__codelineno-26-65"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-66"><a id="__codelineno-26-66" name="__codelineno-26-66" href="#__codelineno-26-66"></a><span class="w">            </span><span class="c1">// 如果发生其他异常，丢弃暂存的更改，并重新抛出异常</span>
</span><span id="__span-26-67"><a id="__codelineno-26-67" name="__codelineno-26-67" href="#__codelineno-26-67"></a><span class="w">            </span><span class="n">mSubManager</span><span class="p">.</span><span class="na">dropCommit</span><span class="p">();</span>
</span><span id="__span-26-68"><a id="__codelineno-26-68" name="__codelineno-26-68" href="#__codelineno-26-68"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
</span><span id="__span-26-69"><a id="__codelineno-26-69" name="__codelineno-26-69" href="#__codelineno-26-69"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-70"><a id="__codelineno-26-70" name="__codelineno-26-70" href="#__codelineno-26-70"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-71"><a id="__codelineno-26-71" name="__codelineno-26-71" href="#__codelineno-26-71"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>updateSubscriptionRateLocked()</code> 方法通过计算当前和暂存状态的差异，向 VHAL 发送订阅或取消订阅请求。</p>
<blockquote>
<p>更加迷惑了，刚才 <code>CarPropertyService.applyStagedChangesLocked()</code> 里调用过 <code>SubscriptionManager.diffBetweenCurrentAndStage()</code> 获取当前状态与暂存状态之间的差异了，为什么这里又再次调用？
其实最大的疑问就是为什么在 <code>CarPropertyService</code> 和 <code>PropertyHalService</code> 里分别持有 <code>SubscriptionManager</code> ，在同一个注册流程里，让  <code>CarPropertyService</code> 持有 <code>SubscriptionManager</code> 做相应的任务不就行了吗？</p>
</blockquote>
<p>调用 <code>VehicleHal.subscribeProperty()</code> 方法将新的订阅请求发送给 VHAL 的这个流程可参考：<a href="../carservice-call-vhal/">Android 15 CarService源码04-CarService与Vehicle HAL交互</a> 中的分析。</p>
<h4 id="propertyhalserviceunsubscribeproperty">PropertyHalService.unsubscribeProperty()<a class="headerlink" href="#propertyhalserviceunsubscribeproperty" title="Permanent link">&para;</a></h4>
<p>回到 <code>CarPropertyService.applyStagedChangesLocked()</code> 中，如果 <code>propertyIdsToUnsubscribe</code> 不为空，遍历 <code>propertyIdsToUnsubscribe</code> 列表，逐个取消这些属性的订阅。通过调用 <code>PropertyHalService.unsubscribeProperty()</code> 方法来取消订阅。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/PropertyHalService.java</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PropertyHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="cm">     * 取消订阅属性并关闭该属性的更新事件。</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="cm">     *</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="cm">     * @throws ServiceSpecificException 如果VHAL返回错误。</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="cm">     */</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">unsubscribeProperty</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">mgrPropId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w">        </span><span class="c1">// 如果调试标志DBG为真，则输出日志，打印取消订阅的属性ID</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="w">            </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;unsubscribeProperty mgrPropId=%s&quot;</span><span class="p">,</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="w">                    </span><span class="n">VehiclePropertyIds</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">mgrPropId</span><span class="p">));</span><span class="w"> </span><span class="c1">// 打印属性ID的字符串表示</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="w">        </span><span class="c1">// 将管理层的属性ID转换为硬件抽象层（VHAL）所需的属性ID</span>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">halPropId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">managerToHalPropId</span><span class="p">(</span><span class="n">mgrPropId</span><span class="p">);</span>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="w">        </span><span class="c1">// 使用锁确保多线程情况下的线程安全</span>
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="w">            </span><span class="c1">// 即使涉及到binder调用，仍然需要在锁内执行该操作，确保mSubManager的状态与VHAL的状态一致</span>
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="w">            </span><span class="c1">// mSubManager在此处处理取消订阅的请求</span>
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="w">            </span><span class="n">mSubManager</span><span class="p">.</span><span class="na">stageUnregister</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ClientType</span><span class="p">(</span><span class="n">CAR_PROP_SVC_REQUEST_ID</span><span class="p">),</span>
</span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">ArraySet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Set</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">halPropId</span><span class="p">)));</span><span class="w">  </span><span class="c1">// 将待取消订阅的属性ID添加到待处理集合中</span>
</span><span id="__span-27-26"><a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>
</span><span id="__span-27-27"><a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-28"><a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a><span class="w">                </span><span class="c1">// 更新订阅率，确保VHAL和mSubManager之间的订阅状态保持一致</span>
</span><span id="__span-27-29"><a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a><span class="w">                </span><span class="n">updateSubscriptionRateLocked</span><span class="p">();</span>
</span><span id="__span-27-30"><a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-31"><a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a><span class="w">                </span><span class="c1">// 如果更新订阅率时发生异常，输出错误日志并恢复到先前的状态</span>
</span><span id="__span-27-32"><a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a><span class="w">                </span><span class="n">Slogf</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to update subscription rate for unsubscribe, &quot;</span>
</span><span id="__span-27-33"><a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;restoring previous state&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-27-34"><a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w">  </span><span class="c1">// 抛出异常，返回错误状态</span>
</span><span id="__span-27-35"><a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-27-36"><a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-27-37"><a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-38"><a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>unsubscribeProperty()</code> 方法的目的是取消订阅一个车载属性，并关闭对该属性的更新事件。<code>mgrPropId</code> 是管理层属性的ID，表示需要取消订阅的车载属性。</p>
<p>先是调用 <code>SubscriptionManager.stageUnregister()</code> 处理取消订阅的请求；最后调用 <code>PropertyHalService.updateSubscriptionRateLocked()</code> 更新订阅率， <code>PropertyHalService.updateSubscriptionRateLocked()</code> 前面分析过了。</p>
<h5 id="subscriptionmanagerstageunregister">SubscriptionManager.stageUnregister()<a class="headerlink" href="#subscriptionmanagerstageunregister" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1">// packages/services/Car/car-lib/src/com/android/car/internal/property/SubscriptionManager.java</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SubscriptionManager</span><span class="o">&lt;</span><span class="n">ClientType</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="cm">     * 准备取消注册属性ID列表。</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="cm">     *</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="cm">     * 该方法将取消注册操作应用于暂存区域，但不会实际提交它们。</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="cm">     */</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stageUnregister</span><span class="p">(</span><span class="n">ClientType</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">ArraySet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">propertyIdsToUnregister</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">        </span><span class="c1">// 如果调试标志DBG为真，则输出日志，打印需要取消注册的属性ID列表</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stageUnregister: propertyIdsToUnregister: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">propertyIdsToString</span><span class="p">(</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="w">                    </span><span class="n">propertyIdsToUnregister</span><span class="p">));</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="w">        </span><span class="c1">// 如果暂存区没有被清空，则将当前状态克隆到暂存区</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="w">        </span><span class="n">cloneCurrentToStageIfClean</span><span class="p">();</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="w">        </span><span class="c1">// 遍历所有需要取消注册的属性ID</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">propertyIdsToUnregister</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">propertyId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">propertyIdsToUnregister</span><span class="p">.</span><span class="na">valueAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a>
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="w">            </span><span class="c1">// 获取指定属性ID的所有区域ID</span>
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="w">            </span><span class="n">ArraySet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">areaIds</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a><span class="w">                    </span><span class="n">mStagedRateInfoByClientByPropIdAreaId</span><span class="p">.</span><span class="na">getSecondKeysForFirstKey</span><span class="p">(</span><span class="n">propertyId</span><span class="p">);</span>
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a>
</span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="w">            </span><span class="c1">// 遍历每个区域ID</span>
</span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">areaIds</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">areaIds</span><span class="p">.</span><span class="na">valueAt</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
</span><span id="__span-28-31"><a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a>
</span><span id="__span-28-32"><a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a><span class="w">                </span><span class="c1">// 将当前属性ID和区域ID标记为受影响，添加到暂存列表</span>
</span><span id="__span-28-33"><a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a><span class="w">                </span><span class="n">mStagedAffectedPropIdAreaIds</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">});</span>
</span><span id="__span-28-34"><a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a>
</span><span id="__span-28-35"><a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a><span class="w">                </span><span class="c1">// 获取该属性ID和区域ID对应的客户端订阅信息</span>
</span><span id="__span-28-36"><a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a><span class="w">                </span><span class="n">RateInfoForClients</span><span class="o">&lt;</span><span class="n">ClientType</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rateInfoForClients</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-28-37"><a id="__codelineno-28-37" name="__codelineno-28-37" href="#__codelineno-28-37"></a><span class="w">                        </span><span class="n">mStagedRateInfoByClientByPropIdAreaId</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">);</span>
</span><span id="__span-28-38"><a id="__codelineno-28-38" name="__codelineno-28-38" href="#__codelineno-28-38"></a>
</span><span id="__span-28-39"><a id="__codelineno-28-39" name="__codelineno-28-39" href="#__codelineno-28-39"></a><span class="w">                </span><span class="c1">// 如果没有找到该属性和区域的订阅信息，输出错误日志并跳过</span>
</span><span id="__span-28-40"><a id="__codelineno-28-40" name="__codelineno-28-40" href="#__codelineno-28-40"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rateInfoForClients</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-41"><a id="__codelineno-28-41" name="__codelineno-28-41" href="#__codelineno-28-41"></a><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The property: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">VehiclePropertyIds</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">propertyId</span><span class="p">)</span>
</span><span id="__span-28-42"><a id="__codelineno-28-42" name="__codelineno-28-42" href="#__codelineno-28-42"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, area ID: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">areaId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; was not registered, do nothing&quot;</span><span class="p">);</span>
</span><span id="__span-28-43"><a id="__codelineno-28-43" name="__codelineno-28-43" href="#__codelineno-28-43"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-28-44"><a id="__codelineno-28-44" name="__codelineno-28-44" href="#__codelineno-28-44"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-28-45"><a id="__codelineno-28-45" name="__codelineno-28-45" href="#__codelineno-28-45"></a>
</span><span id="__span-28-46"><a id="__codelineno-28-46" name="__codelineno-28-46" href="#__codelineno-28-46"></a><span class="w">                </span><span class="c1">// 从客户端订阅信息中移除当前客户端的订阅</span>
</span><span id="__span-28-47"><a id="__codelineno-28-47" name="__codelineno-28-47" href="#__codelineno-28-47"></a><span class="w">                </span><span class="n">rateInfoForClients</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span id="__span-28-48"><a id="__codelineno-28-48" name="__codelineno-28-48" href="#__codelineno-28-48"></a>
</span><span id="__span-28-49"><a id="__codelineno-28-49" name="__codelineno-28-49" href="#__codelineno-28-49"></a><span class="w">                </span><span class="c1">// 如果该区域的所有客户端订阅都被移除，则删除该区域的订阅信息</span>
</span><span id="__span-28-50"><a id="__codelineno-28-50" name="__codelineno-28-50" href="#__codelineno-28-50"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rateInfoForClients</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-51"><a id="__codelineno-28-51" name="__codelineno-28-51" href="#__codelineno-28-51"></a><span class="w">                    </span><span class="n">mStagedRateInfoByClientByPropIdAreaId</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">);</span>
</span><span id="__span-28-52"><a id="__codelineno-28-52" name="__codelineno-28-52" href="#__codelineno-28-52"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-28-53"><a id="__codelineno-28-53" name="__codelineno-28-53" href="#__codelineno-28-53"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-28-54"><a id="__codelineno-28-54" name="__codelineno-28-54" href="#__codelineno-28-54"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-28-55"><a id="__codelineno-28-55" name="__codelineno-28-55" href="#__codelineno-28-55"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-28-56"><a id="__codelineno-28-56" name="__codelineno-28-56" href="#__codelineno-28-56"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>stageUnregister()</code> 方法用于准备取消对指定属性ID的订阅。它将取消注册操作应用到暂存区，但不会立即提交这些更改。</p>
<h4 id="subscriptionmanagercommit">SubscriptionManager.commit()<a class="headerlink" href="#subscriptionmanagercommit" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c1">// packages/services/Car/car-lib/src/com/android/car/internal/property/SubscriptionManager.java</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SubscriptionManager</span><span class="o">&lt;</span><span class="n">ClientType</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="cm">     * 提交暂存的更改。</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="cm">     *</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="cm">     * 这将用暂存区的状态替换当前状态。此方法应在更改成功应用到底层之后调用。</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="cm">     */</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">commit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="w">        </span><span class="c1">// 如果暂存区没有被修改（即没有更改需要提交），则直接返回</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mStagedAffectedPropIdAreaIds</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="w">                </span><span class="c1">// 如果调试标志DBG为真，则输出日志，表示没有更改需要提交</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;No changes has been staged, nothing to commit&quot;</span><span class="p">);</span>
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-29-18"><a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-29-19"><a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a>
</span><span id="__span-29-20"><a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a><span class="w">        </span><span class="c1">// 丢弃当前状态，并用暂存区的状态替换当前状态</span>
</span><span id="__span-29-21"><a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a><span class="w">        </span><span class="n">mCurrentRateInfoByClientByPropIdAreaId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mStagedRateInfoByClientByPropIdAreaId</span><span class="p">;</span>
</span><span id="__span-29-22"><a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a>
</span><span id="__span-29-23"><a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a><span class="w">        </span><span class="c1">// 清空暂存的受影响的属性ID和区域ID列表</span>
</span><span id="__span-29-24"><a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a><span class="w">        </span><span class="n">mStagedAffectedPropIdAreaIds</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
</span><span id="__span-29-25"><a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-29-26"><a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>commit()</code> 方法的作用是提交暂存的更改，将暂存区的状态应用到当前状态，并清空暂存区。</p>
<h2 id="_4">设置属性<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>在前面 <a href="../car-property-manager/">Android 15 CarService源码08-CarPropertyService之接口</a> 分析中，我们知道了 <code>CarPropertyManager.setProperty()</code> 最终是会调到 <code>CarPropertyService.setProperty()</code></p>
<h3 id="carpropertyservicesetproperty">CarPropertyService.setProperty()<a class="headerlink" href="#carpropertyservicesetproperty" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/CarPropertyService.java</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CarPropertyService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ICarProperty</span><span class="p">.</span><span class="na">Stub</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">CarServiceBase</span><span class="p">,</span><span class="w"> </span><span class="n">PropertyHalService</span><span class="p">.</span><span class="na">PropertyHalListener</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setProperty</span><span class="p">(</span><span class="n">CarPropertyValue</span><span class="w"> </span><span class="n">carPropertyValue</span><span class="p">,</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="w">                            </span><span class="n">ICarPropertyEventListener</span><span class="w"> </span><span class="n">iCarPropertyEventListener</span><span class="p">)</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="w">        </span><span class="c1">// 确保 iCarPropertyEventListener 不为空</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="w">        </span><span class="n">requireNonNull</span><span class="p">(</span><span class="n">iCarPropertyEventListener</span><span class="p">);</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="w">        </span><span class="c1">// 验证传入的 carPropertyValue 参数是否合法</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="w">        </span><span class="n">validateSetParameters</span><span class="p">(</span><span class="n">carPropertyValue</span><span class="p">);</span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="w">        </span><span class="c1">// 获取当前时间，记录操作的开始时间</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">currentTimeMs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a><span class="w">        </span><span class="c1">// 执行同步操作，检查是否超出限制</span>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="w">        </span><span class="n">runSyncOperationCheckLimit</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="w">            </span><span class="c1">// 调用 PropertyHalService 的 setProperty 方法执行实际的属性设置操作</span>
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="w">            </span><span class="n">mPropertyHalService</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">carPropertyValue</span><span class="p">);</span>
</span><span id="__span-30-23"><a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-30-24"><a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a><span class="w">        </span><span class="p">});</span>
</span><span id="__span-30-25"><a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a>
</span><span id="__span-30-26"><a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a><span class="w">        </span><span class="c1">// 获取事件监听器的 Binder 对象</span>
</span><span id="__span-30-27"><a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a><span class="w">        </span><span class="n">IBinder</span><span class="w"> </span><span class="n">listenerBinder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iCarPropertyEventListener</span><span class="p">.</span><span class="na">asBinder</span><span class="p">();</span>
</span><span id="__span-30-28"><a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a>
</span><span id="__span-30-29"><a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a><span class="w">        </span><span class="c1">// 加锁，确保线程安全</span>
</span><span id="__span-30-30"><a id="__codelineno-30-30" name="__codelineno-30-30" href="#__codelineno-30-30"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-31"><a id="__codelineno-30-31" name="__codelineno-30-31" href="#__codelineno-30-31"></a><span class="w">            </span><span class="c1">// 尝试从客户端映射表中获取对应的客户端</span>
</span><span id="__span-30-32"><a id="__codelineno-30-32" name="__codelineno-30-32" href="#__codelineno-30-32"></a><span class="w">            </span><span class="n">CarPropertyServiceClient</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mClientMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">listenerBinder</span><span class="p">);</span>
</span><span id="__span-30-33"><a id="__codelineno-30-33" name="__codelineno-30-33" href="#__codelineno-30-33"></a>
</span><span id="__span-30-34"><a id="__codelineno-30-34" name="__codelineno-30-34" href="#__codelineno-30-34"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-35"><a id="__codelineno-30-35" name="__codelineno-30-35" href="#__codelineno-30-35"></a><span class="w">                </span><span class="c1">// 如果客户端不存在，创建新的客户端对象</span>
</span><span id="__span-30-36"><a id="__codelineno-30-36" name="__codelineno-30-36" href="#__codelineno-30-36"></a><span class="w">                </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CarPropertyServiceClient</span><span class="p">(</span><span class="n">iCarPropertyEventListener</span><span class="p">,</span>
</span><span id="__span-30-37"><a id="__codelineno-30-37" name="__codelineno-30-37" href="#__codelineno-30-37"></a><span class="w">                        </span><span class="k">this</span><span class="p">::</span><span class="n">unregisterListenerBinderForProps</span><span class="p">);</span>
</span><span id="__span-30-38"><a id="__codelineno-30-38" name="__codelineno-30-38" href="#__codelineno-30-38"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-30-39"><a id="__codelineno-30-39" name="__codelineno-30-39" href="#__codelineno-30-39"></a>
</span><span id="__span-30-40"><a id="__codelineno-30-40" name="__codelineno-30-40" href="#__codelineno-30-40"></a><span class="w">            </span><span class="c1">// 如果客户端已死，则打印警告信息并返回</span>
</span><span id="__span-30-41"><a id="__codelineno-30-41" name="__codelineno-30-41" href="#__codelineno-30-41"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="na">isDead</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-42"><a id="__codelineno-30-42" name="__codelineno-30-42" href="#__codelineno-30-42"></a><span class="w">                </span><span class="n">Slogf</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the ICarPropertyEventListener is already dead&quot;</span><span class="p">);</span>
</span><span id="__span-30-43"><a id="__codelineno-30-43" name="__codelineno-30-43" href="#__codelineno-30-43"></a><span class="w">                </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-30-44"><a id="__codelineno-30-44" name="__codelineno-30-44" href="#__codelineno-30-44"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-30-45"><a id="__codelineno-30-45" name="__codelineno-30-45" href="#__codelineno-30-45"></a>
</span><span id="__span-30-46"><a id="__codelineno-30-46" name="__codelineno-30-46" href="#__codelineno-30-46"></a><span class="w">            </span><span class="c1">// 这里不调用 addContinuousProperty 或 addOnChangeProperty，因为</span>
</span><span id="__span-30-47"><a id="__codelineno-30-47" name="__codelineno-30-47" href="#__codelineno-30-47"></a><span class="w">            </span><span class="c1">// 该客户端不会启用过滤，所以不需要记录这些过滤信息</span>
</span><span id="__span-30-48"><a id="__codelineno-30-48" name="__codelineno-30-48" href="#__codelineno-30-48"></a><span class="w">            </span><span class="n">mClientMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">listenerBinder</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p">);</span>
</span><span id="__span-30-49"><a id="__codelineno-30-49" name="__codelineno-30-49" href="#__codelineno-30-49"></a>
</span><span id="__span-30-50"><a id="__codelineno-30-50" name="__codelineno-30-50" href="#__codelineno-30-50"></a><span class="w">            </span><span class="c1">// 更新设置操作记录器，记录属性 ID 和区域 ID 以及对应的客户端</span>
</span><span id="__span-30-51"><a id="__codelineno-30-51" name="__codelineno-30-51" href="#__codelineno-30-51"></a><span class="w">            </span><span class="n">updateSetOperationRecorderLocked</span><span class="p">(</span><span class="n">carPropertyValue</span><span class="p">.</span><span class="na">getPropertyId</span><span class="p">(),</span>
</span><span id="__span-30-52"><a id="__codelineno-30-52" name="__codelineno-30-52" href="#__codelineno-30-52"></a><span class="w">                    </span><span class="n">carPropertyValue</span><span class="p">.</span><span class="na">getAreaId</span><span class="p">(),</span><span class="w"> </span><span class="n">client</span><span class="p">);</span>
</span><span id="__span-30-53"><a id="__codelineno-30-53" name="__codelineno-30-53" href="#__codelineno-30-53"></a>
</span><span id="__span-30-54"><a id="__codelineno-30-54" name="__codelineno-30-54" href="#__codelineno-30-54"></a><span class="w">            </span><span class="c1">// 如果调试标志 DBG 为真，则输出设置操作的延迟时间</span>
</span><span id="__span-30-55"><a id="__codelineno-30-55" name="__codelineno-30-55" href="#__codelineno-30-55"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-56"><a id="__codelineno-30-56" name="__codelineno-30-56" href="#__codelineno-30-56"></a><span class="w">                </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Latency of setPropertySync is: %f&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">System</span>
</span><span id="__span-30-57"><a id="__codelineno-30-57" name="__codelineno-30-57" href="#__codelineno-30-57"></a><span class="w">                        </span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">currentTimeMs</span><span class="p">));</span>
</span><span id="__span-30-58"><a id="__codelineno-30-58" name="__codelineno-30-58" href="#__codelineno-30-58"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-30-59"><a id="__codelineno-30-59" name="__codelineno-30-59" href="#__codelineno-30-59"></a>
</span><span id="__span-30-60"><a id="__codelineno-30-60" name="__codelineno-30-60" href="#__codelineno-30-60"></a><span class="w">            </span><span class="c1">// 记录同步设置操作的延迟时间到延迟直方图中</span>
</span><span id="__span-30-61"><a id="__codelineno-30-61" name="__codelineno-30-61" href="#__codelineno-30-61"></a><span class="w">            </span><span class="n">mSetPropertySyncLatencyHistogram</span><span class="p">.</span><span class="na">logSample</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span>
</span><span id="__span-30-62"><a id="__codelineno-30-62" name="__codelineno-30-62" href="#__codelineno-30-62"></a><span class="w">                    </span><span class="o">-</span><span class="w"> </span><span class="n">currentTimeMs</span><span class="p">));</span>
</span><span id="__span-30-63"><a id="__codelineno-30-63" name="__codelineno-30-63" href="#__codelineno-30-63"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-30-64"><a id="__codelineno-30-64" name="__codelineno-30-64" href="#__codelineno-30-64"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-30-65"><a id="__codelineno-30-65" name="__codelineno-30-65" href="#__codelineno-30-65"></a><span class="p">}</span>
</span></code></pre></div>
<p>最重要的就是在同步操作中调用 <code>mPropertyHalService.setProperty(carPropertyValue)</code> 来执行实际的属性设置操作。</p>
<p>但是这里有一个疑问点：调用 <code>mClientMap.put(listenerBinder, client)</code> 将客户端加入到 <code>mClientMap</code> 中。我们在前面分析过监听回调事件就是放到 <code>mClientMap</code> ，所有我当时认为 <code>mClientMap</code> 这个映射表，用于存储和管理监听“全局”的客户端。所以仅仅在一个函数里监听不应该放在这里才对，因为函数执行完了客户端的<code>Listener</code> 就不存在了，那这里又不烧毁。目前想不通，先保留疑问。</p>
<h3 id="propertyhalservicesetproperty">PropertyHalService.setProperty()<a class="headerlink" href="#propertyhalservicesetproperty" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/PropertyHalService.java</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PropertyHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">VehicleHal</span><span class="w"> </span><span class="n">mVehicleHal</span><span class="p">;</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="cm">     * 设置车辆属性的值。</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="cm">     *</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="cm">     * @throws IllegalArgumentException 如果参数无效。</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="cm">     * @throws ServiceSpecificException 如果在 HAL 层发生异常。</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="cm">     */</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setProperty</span><span class="p">(</span><span class="n">CarPropertyValue</span><span class="w"> </span><span class="n">carPropertyValue</span><span class="p">)</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="w">        </span><span class="c1">// 定义一个变量，用于存储转换后的 HAL 属性值</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="w">        </span><span class="n">HalPropValue</span><span class="w"> </span><span class="n">valueToSet</span><span class="p">;</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="w">        </span><span class="c1">// 使用锁进行同步，保证线程安全</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="w">            </span><span class="c1">// 将 CarPropertyValue 转换为 HalPropValue 对象</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="w">            </span><span class="n">valueToSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carPropertyValueToHalPropValueLocked</span><span class="p">(</span><span class="n">carPropertyValue</span><span class="p">);</span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="w">        </span><span class="c1">// 调用 mVehicleHal 的 set 方法来设置属性值</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a><span class="w">        </span><span class="c1">// CarPropertyManager 会捕获并重新抛出异常，所以在此处无需再处理异常。</span>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="w">        </span><span class="n">mVehicleHal</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">valueToSet</span><span class="p">);</span>
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>setProperty()</code> 方法的主要作用是将传入的 <code>CarPropertyValue</code> 设置到车辆硬件抽象层（HAL）中，涉及将车属性值从上层转换为 HAL 层能处理的格式，并通过 <code>mVehicleHal.set()</code> 实现与硬件的交互。</p>
<h3 id="vehiclehalset">VehicleHal.set()<a class="headerlink" href="#vehiclehalset" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/VehicleHal.java</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VehicleHal</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">VehicleHalCallback</span><span class="p">,</span><span class="w"> </span><span class="n">CarSystemService</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">VehicleStub</span><span class="w"> </span><span class="n">mVehicleStub</span><span class="p">;</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="cm">     * 设置车辆属性值。</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="cm">     *</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="cm">     * @throws IllegalArgumentException 如果传入的参数无效</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="cm">     * @throws ServiceSpecificException 如果 VHAL 层返回错误</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="cm">     */</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="n">HalPropValue</span><span class="w"> </span><span class="n">propValue</span><span class="p">)</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="w">        </span><span class="c1">// 调用带重试机制的 set 方法，尝试设置属性值</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="w">        </span><span class="n">setValueWithRetry</span><span class="p">(</span><span class="n">propValue</span><span class="p">);</span>
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-32-18"><a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a>
</span><span id="__span-32-19"><a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-32-20"><a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="cm">     * 带重试机制的设置属性值。</span>
</span><span id="__span-32-21"><a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a><span class="cm">     *</span>
</span><span id="__span-32-22"><a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a><span class="cm">     * @param value 要设置的属性值</span>
</span><span id="__span-32-23"><a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="cm">     */</span>
</span><span id="__span-32-24"><a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setValueWithRetry</span><span class="p">(</span><span class="n">HalPropValue</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w">  </span><span class="p">{</span>
</span><span id="__span-32-25"><a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a><span class="w">        </span><span class="c1">// 调用重试机制来执行设置操作</span>
</span><span id="__span-32-26"><a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a><span class="w">        </span><span class="n">invokeRetriable</span><span class="p">((</span><span class="n">requestValue</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-27"><a id="__codelineno-32-27" name="__codelineno-32-27" href="#__codelineno-32-27"></a><span class="w">            </span><span class="c1">// 启动 trace 跟踪，记录设置操作</span>
</span><span id="__span-32-28"><a id="__codelineno-32-28" name="__codelineno-32-28" href="#__codelineno-32-28"></a><span class="w">            </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">TRACE_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;VehicleStub#set&quot;</span><span class="p">);</span>
</span><span id="__span-32-29"><a id="__codelineno-32-29" name="__codelineno-32-29" href="#__codelineno-32-29"></a><span class="w">            </span><span class="c1">// 通过 VehicleStub 设置属性值</span>
</span><span id="__span-32-30"><a id="__codelineno-32-30" name="__codelineno-32-30" href="#__codelineno-32-30"></a><span class="w">            </span><span class="n">mVehicleStub</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">requestValue</span><span class="p">);</span>
</span><span id="__span-32-31"><a id="__codelineno-32-31" name="__codelineno-32-31" href="#__codelineno-32-31"></a><span class="w">            </span><span class="c1">// 结束 trace 跟踪</span>
</span><span id="__span-32-32"><a id="__codelineno-32-32" name="__codelineno-32-32" href="#__codelineno-32-32"></a><span class="w">            </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">TRACE_TAG</span><span class="p">);</span>
</span><span id="__span-32-33"><a id="__codelineno-32-33" name="__codelineno-32-33" href="#__codelineno-32-33"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-32-34"><a id="__codelineno-32-34" name="__codelineno-32-34" href="#__codelineno-32-34"></a><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="s">&quot;set&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">mMaxDurationForRetryMs</span><span class="p">,</span><span class="w"> </span><span class="n">mSleepBetweenRetryMs</span><span class="p">,</span><span class="w"> </span><span class="cm">/* maxRetries= */</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-32-35"><a id="__codelineno-32-35" name="__codelineno-32-35" href="#__codelineno-32-35"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-32-36"><a id="__codelineno-32-36" name="__codelineno-32-36" href="#__codelineno-32-36"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>VehicleStub</code> 是一个 <code>VehicleStub</code> 类型的成员变量，代表与车辆硬件抽象层（VHAL）的实际通信对象。通过它可以与底层车辆硬件交互，进行属性设置和获取操作。
根据 <a href="../init-service/">Android 15 CarService源码02-服务初始化</a> 我们知道这个 <code>mVehicleStub</code> 其实就是 <code>AidlVehicleStub</code> 。</p>
<h3 id="aidlvehiclestubset">AidlVehicleStub.set()<a class="headerlink" href="#aidlvehiclestubset" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/AidlVehicleStub.java</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AidlVehicleStub</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">VehicleStub</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="cm">     * 设置一个属性。</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="cm">     *</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="cm">     * @param requestedPropValue 要设置的属性值。</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="cm">     * @throws RemoteException 如果远程操作失败。</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="cm">     * @throws ServiceSpecificException 如果 VHAL 返回特定的服务错误。</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="cm">     */</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="n">HalPropValue</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="p">,</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="w">            </span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="w">        </span><span class="c1">// 记录当前时间，便于性能分析</span>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="w">        </span><span class="c1">// 获取或设置同步请求，将请求添加到等待池中，并通过异步处理器处理请求</span>
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="w">        </span><span class="n">getOrSetSync</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">,</span><span class="w"> </span><span class="n">mPendingSyncSetValueRequestPool</span><span class="p">,</span>
</span><span id="__span-33-19"><a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">AsyncSetRequestsHandler</span><span class="p">(),</span>
</span><span id="__span-33-20"><a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="w">                </span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-21"><a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="w">                    </span><span class="c1">// 如果请求的状态不为 OK，抛出 ServiceSpecificException 异常</span>
</span><span id="__span-33-22"><a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">StatusCode</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-23"><a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a><span class="w">                        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">status</span><span class="p">,</span>
</span><span id="__span-33-24"><a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a><span class="w">                                </span><span class="s">&quot;无法设置 &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">printPropIdAreaId</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; 的值&quot;</span><span class="p">);</span>
</span><span id="__span-33-25"><a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-33-26"><a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-33-27"><a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a><span class="w">                </span><span class="p">});</span>
</span><span id="__span-33-28"><a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a>
</span><span id="__span-33-29"><a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a><span class="w">        </span><span class="c1">// 记录设置操作的同步延迟</span>
</span><span id="__span-33-30"><a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a><span class="w">        </span><span class="n">sVehicleHalSetSyncLatencyHistogram</span><span class="p">.</span><span class="na">logSample</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span>
</span><span id="__span-33-31"><a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a><span class="w">                </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">currentTime</span><span class="p">));</span>
</span><span id="__span-33-32"><a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-33"><a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>set()</code> 方法通过同步请求处理机制完成设置操作。这个流程我们在 <a href="Android 15 CarService源码04-CarService 与Vehicle HAL交互.md">Android 15 CarService源码04-CarService与Vehicle HAL交互</a> 分析过了。</p>
<h2 id="_5">获取属性<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>在前面 <a href="../car-property-manager/">Android 15 CarService源码08-CarPropertyService之接口</a> 分析中，我们知道了 <code>CarPropertyManager.getProperty()</code> 最终是会调到 <code>CarPropertyService.getProperty()</code> ，或者 <code>CarPropertyManager.getPropertyList()</code> 最终是会调到 <code>CarPropertyService.getPropertyList()</code> 。</p>
<h3 id="carpropertyservicegetproperty">CarPropertyService.getProperty()<a class="headerlink" href="#carpropertyservicegetproperty" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/CarPropertyService.java</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CarPropertyService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ICarProperty</span><span class="p">.</span><span class="na">Stub</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">CarServiceBase</span><span class="p">,</span><span class="w"> </span><span class="n">PropertyHalService</span><span class="p">.</span><span class="na">PropertyHalListener</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CarPropertyValue</span><span class="w"> </span><span class="nf">getProperty</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="p">)</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="w">        </span><span class="c1">// 验证获取属性的参数是否合法</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="w">        </span><span class="n">validateGetParameters</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">);</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="w">        </span><span class="c1">// 开始性能追踪，用于记录方法的执行时间</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">TRACE_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;CarPropertyValue#getProperty&quot;</span><span class="p">);</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a><span class="w">        </span><span class="c1">// 记录当前时间，用于计算方法执行的延迟</span>
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">currentTimeMs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a>
</span><span id="__span-34-19"><a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-20"><a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a><span class="w">            </span><span class="c1">// 执行同步操作并检查操作限制，调用属性HAL服务获取指定属性</span>
</span><span id="__span-34-21"><a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">runSyncOperationCheckLimit</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-22"><a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">mPropertyHalService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">);</span>
</span><span id="__span-34-23"><a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a><span class="w">            </span><span class="p">});</span>
</span><span id="__span-34-24"><a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-25"><a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a><span class="w">            </span><span class="c1">// 计算并记录同步操作的延迟时间</span>
</span><span id="__span-34-26"><a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-27"><a id="__codelineno-34-27" name="__codelineno-34-27" href="#__codelineno-34-27"></a><span class="w">                </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;getPropertySync 的延迟是: %f&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">System</span>
</span><span id="__span-34-28"><a id="__codelineno-34-28" name="__codelineno-34-28" href="#__codelineno-34-28"></a><span class="w">                        </span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">currentTimeMs</span><span class="p">));</span>
</span><span id="__span-34-29"><a id="__codelineno-34-29" name="__codelineno-34-29" href="#__codelineno-34-29"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-34-30"><a id="__codelineno-34-30" name="__codelineno-34-30" href="#__codelineno-34-30"></a><span class="w">            </span><span class="c1">// 记录获取属性的同步延迟</span>
</span><span id="__span-34-31"><a id="__codelineno-34-31" name="__codelineno-34-31" href="#__codelineno-34-31"></a><span class="w">            </span><span class="n">mGetPropertySyncLatencyHistogram</span><span class="p">.</span><span class="na">logSample</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span>
</span><span id="__span-34-32"><a id="__codelineno-34-32" name="__codelineno-34-32" href="#__codelineno-34-32"></a><span class="w">                    </span><span class="o">-</span><span class="w"> </span><span class="n">currentTimeMs</span><span class="p">));</span>
</span><span id="__span-34-33"><a id="__codelineno-34-33" name="__codelineno-34-33" href="#__codelineno-34-33"></a>
</span><span id="__span-34-34"><a id="__codelineno-34-34" name="__codelineno-34-34" href="#__codelineno-34-34"></a><span class="w">            </span><span class="c1">// 结束性能追踪</span>
</span><span id="__span-34-35"><a id="__codelineno-34-35" name="__codelineno-34-35" href="#__codelineno-34-35"></a><span class="w">            </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">TRACE_TAG</span><span class="p">);</span>
</span><span id="__span-34-36"><a id="__codelineno-34-36" name="__codelineno-34-36" href="#__codelineno-34-36"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-34-37"><a id="__codelineno-34-37" name="__codelineno-34-37" href="#__codelineno-34-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-34-38"><a id="__codelineno-34-38" name="__codelineno-34-38" href="#__codelineno-34-38"></a><span class="p">}</span>
</span></code></pre></div>
<p>最重要的就是在同步操作中调用 <code>mPropertyHalService.getProperty(propertyId, areaId)</code> 来执行获取属性操作。</p>
<h3 id="propertyhalservicegetproperty">PropertyHalService.getProperty()<a class="headerlink" href="#propertyhalservicegetproperty" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/PropertyHalService.java</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PropertyHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="cm">     * 返回属性值。</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="cm">     *</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="cm">     * @param mgrPropId 在 {@link VehiclePropertyIds} 中的属性 ID</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="cm">     * @param areaId 属性的区域 ID</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="cm">     * @throws IllegalArgumentException 如果传入的参数无效</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="cm">     * @throws ServiceSpecificException 如果在 HAL 层发生异常，或者属性状态不可用</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="cm">     */</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CarPropertyValue</span><span class="w"> </span><span class="nf">getProperty</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">mgrPropId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="p">)</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="w">        </span><span class="c1">// 将管理端的属性 ID 转换为 HAL 层的属性 ID</span>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">halPropId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">managerToHalPropId</span><span class="p">(</span><span class="n">mgrPropId</span><span class="p">);</span>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a>
</span><span id="__span-35-18"><a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="w">        </span><span class="c1">// 定义两个对象来存储从 VHAL 获取的属性值和配置</span>
</span><span id="__span-35-19"><a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="w">        </span><span class="n">HalPropValue</span><span class="w"> </span><span class="n">halPropValue</span><span class="p">;</span>
</span><span id="__span-35-20"><a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a><span class="w">        </span><span class="n">HalPropConfig</span><span class="w"> </span><span class="n">halPropConfig</span><span class="p">;</span>
</span><span id="__span-35-21"><a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a>
</span><span id="__span-35-22"><a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a><span class="w">        </span><span class="c1">// 锁定块，确保线程安全，防止多线程访问时出现问题</span>
</span><span id="__span-35-23"><a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-24"><a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a><span class="w">            </span><span class="c1">// 获取与 halPropId 关联的属性配置</span>
</span><span id="__span-35-25"><a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a><span class="w">            </span><span class="n">halPropConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mHalPropIdToPropConfig</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">halPropId</span><span class="p">);</span>
</span><span id="__span-35-26"><a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a>
</span><span id="__span-35-27"><a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a><span class="w">            </span><span class="c1">// 如果是静态和系统属性，且该属性已经被锁定，则尝试从缓存中获取属性值</span>
</span><span id="__span-35-28"><a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isStaticAndSystemPropertyLocked</span><span class="p">(</span><span class="n">mgrPropId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-29"><a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a><span class="w">                </span><span class="c1">// 从缓存中获取对应的属性值</span>
</span><span id="__span-35-30"><a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a><span class="w">                </span><span class="n">CarPropertyValue</span><span class="w"> </span><span class="n">carPropertyValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mStaticPropertyIdAreaIdCache</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">mgrPropId</span><span class="p">,</span>
</span><span id="__span-35-31"><a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a><span class="w">                        </span><span class="n">areaId</span><span class="p">);</span>
</span><span id="__span-35-32"><a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a>
</span><span id="__span-35-33"><a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a><span class="w">                </span><span class="c1">// 如果缓存中存在该属性值，则直接返回</span>
</span><span id="__span-35-34"><a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">carPropertyValue</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-35"><a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-36"><a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a><span class="w">                        </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Get Sync Property: %s retrieved from cache&quot;</span><span class="p">,</span>
</span><span id="__span-35-37"><a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a><span class="w">                                </span><span class="n">VehiclePropertyIds</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">mgrPropId</span><span class="p">));</span>
</span><span id="__span-35-38"><a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-35-39"><a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">carPropertyValue</span><span class="p">;</span>
</span><span id="__span-35-40"><a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-35-41"><a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-35-42"><a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-43"><a id="__codelineno-35-43" name="__codelineno-35-43" href="#__codelineno-35-43"></a>
</span><span id="__span-35-44"><a id="__codelineno-35-44" name="__codelineno-35-44" href="#__codelineno-35-44"></a><span class="w">        </span><span class="c1">// 如果缓存中没有，则从 VHAL 获取该属性的值</span>
</span><span id="__span-35-45"><a id="__codelineno-35-45" name="__codelineno-35-45" href="#__codelineno-35-45"></a><span class="w">        </span><span class="n">halPropValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mVehicleHal</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">halPropId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">);</span>
</span><span id="__span-35-46"><a id="__codelineno-35-46" name="__codelineno-35-46" href="#__codelineno-35-46"></a>
</span><span id="__span-35-47"><a id="__codelineno-35-47" name="__codelineno-35-47" href="#__codelineno-35-47"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-48"><a id="__codelineno-35-48" name="__codelineno-35-48" href="#__codelineno-35-48"></a><span class="w">            </span><span class="c1">// 将从 VHAL 获取的 HalPropValue 转换为 CarPropertyValue</span>
</span><span id="__span-35-49"><a id="__codelineno-35-49" name="__codelineno-35-49" href="#__codelineno-35-49"></a><span class="w">            </span><span class="n">CarPropertyValue</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">halPropValue</span><span class="p">.</span><span class="na">toCarPropertyValue</span><span class="p">(</span><span class="n">mgrPropId</span><span class="p">,</span><span class="w"> </span><span class="n">halPropConfig</span><span class="p">);</span>
</span><span id="__span-35-50"><a id="__codelineno-35-50" name="__codelineno-35-50" href="#__codelineno-35-50"></a>
</span><span id="__span-35-51"><a id="__codelineno-35-51" name="__codelineno-35-51" href="#__codelineno-35-51"></a><span class="w">            </span><span class="c1">// 锁定块，确保线程安全，防止多线程访问时出现问题</span>
</span><span id="__span-35-52"><a id="__codelineno-35-52" name="__codelineno-35-52" href="#__codelineno-35-52"></a><span class="w">            </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-53"><a id="__codelineno-35-53" name="__codelineno-35-53" href="#__codelineno-35-53"></a><span class="w">                </span><span class="c1">// 如果该属性不是静态和系统属性锁定，则直接返回转换后的结果</span>
</span><span id="__span-35-54"><a id="__codelineno-35-54" name="__codelineno-35-54" href="#__codelineno-35-54"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isStaticAndSystemPropertyLocked</span><span class="p">(</span><span class="n">mgrPropId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-55"><a id="__codelineno-35-55" name="__codelineno-35-55" href="#__codelineno-35-55"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-35-56"><a id="__codelineno-35-56" name="__codelineno-35-56" href="#__codelineno-35-56"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-35-57"><a id="__codelineno-35-57" name="__codelineno-35-57" href="#__codelineno-35-57"></a>
</span><span id="__span-35-58"><a id="__codelineno-35-58" name="__codelineno-35-58" href="#__codelineno-35-58"></a><span class="w">                </span><span class="c1">// 如果是静态和系统属性锁定，则将结果缓存起来，以便下次使用</span>
</span><span id="__span-35-59"><a id="__codelineno-35-59" name="__codelineno-35-59" href="#__codelineno-35-59"></a><span class="w">                </span><span class="n">mStaticPropertyIdAreaIdCache</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">mgrPropId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
</span><span id="__span-35-60"><a id="__codelineno-35-60" name="__codelineno-35-60" href="#__codelineno-35-60"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-35-61"><a id="__codelineno-35-61" name="__codelineno-35-61" href="#__codelineno-35-61"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-35-62"><a id="__codelineno-35-62" name="__codelineno-35-62" href="#__codelineno-35-62"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalStateException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-63"><a id="__codelineno-35-63" name="__codelineno-35-63" href="#__codelineno-35-63"></a><span class="w">            </span><span class="c1">// 如果转换过程失败，则抛出 ServiceSpecificException 异常，并附带详细错误信息</span>
</span><span id="__span-35-64"><a id="__codelineno-35-64" name="__codelineno-35-64" href="#__codelineno-35-64"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="p">(</span><span class="n">STATUS_INTERNAL_ERROR</span><span class="p">,</span>
</span><span id="__span-35-65"><a id="__codelineno-35-65" name="__codelineno-35-65" href="#__codelineno-35-65"></a><span class="w">                    </span><span class="s">&quot;无法将 halPropValue 转换为 carPropertyValue，属性：&quot;</span>
</span><span id="__span-35-66"><a id="__codelineno-35-66" name="__codelineno-35-66" href="#__codelineno-35-66"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">VehiclePropertyIds</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">mgrPropId</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; 区域 ID: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">areaId</span>
</span><span id="__span-35-67"><a id="__codelineno-35-67" name="__codelineno-35-67" href="#__codelineno-35-67"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, 异常：&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-35-68"><a id="__codelineno-35-68" name="__codelineno-35-68" href="#__codelineno-35-68"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-69"><a id="__codelineno-35-69" name="__codelineno-35-69" href="#__codelineno-35-69"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-70"><a id="__codelineno-35-70" name="__codelineno-35-70" href="#__codelineno-35-70"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>将 <code>mgrPropId</code> 转换为 HAL 层使用的属性 ID，具体转换规则由 <code>managerToHalPropId</code> 方法实现。</li>
<li>获取与 <code>halPropId</code> 对应的属性配置。这是从属性配置映射 <code>mHalPropIdToPropConfig</code> 中获取的，主要用于转换和处理属性值。</li>
<li>如果是静态和系统属性且被锁定，则会首先尝试从 <code>mStaticPropertyIdAreaIdCache</code> 缓存中获取已存储的属性值。这样可以避免每次都从 VHAL 获取属性，提升性能。</li>
<li>通过 <code>mVehicleHal.get</code> 方法从 VHAL 层获取该属性的值。</li>
</ul>
<h3 id="vehiclehalget">VehicleHal.get()<a class="headerlink" href="#vehiclehalget" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/hal/VehicleHal.java</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VehicleHal</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">VehicleHalCallback</span><span class="p">,</span><span class="w"> </span><span class="n">CarSystemService</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="cm">     * 返回指定属性 ID 和区域 ID 对应的 {@link HalPropValue}。</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="cm">     *</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="cm">     * @throws IllegalArgumentException 如果传入的参数无效</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="cm">     * @throws ServiceSpecificException 如果 VHAL 返回错误</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="cm">     */</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">HalPropValue</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="p">)</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a><span class="w">        </span><span class="c1">// 如果启用了调试日志，打印获取属性和区域的信息</span>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a><span class="w">            </span><span class="n">Slogf</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">CarLog</span><span class="p">.</span><span class="na">TAG_HAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;get, &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">toPropertyIdString</span><span class="p">(</span><span class="n">propertyId</span><span class="p">)</span>
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">toAreaIdString</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">));</span>
</span><span id="__span-36-18"><a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-36-19"><a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a>
</span><span id="__span-36-20"><a id="__codelineno-36-20" name="__codelineno-36-20" href="#__codelineno-36-20"></a><span class="w">        </span><span class="c1">// 调用带有重试机制的 getValueWithRetry 方法来获取属性值</span>
</span><span id="__span-36-21"><a id="__codelineno-36-21" name="__codelineno-36-21" href="#__codelineno-36-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getValueWithRetry</span><span class="p">(</span><span class="n">mPropValueBuilder</span><span class="p">.</span><span class="na">build</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">));</span>
</span><span id="__span-36-22"><a id="__codelineno-36-22" name="__codelineno-36-22" href="#__codelineno-36-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-36-23"><a id="__codelineno-36-23" name="__codelineno-36-23" href="#__codelineno-36-23"></a>
</span><span id="__span-36-24"><a id="__codelineno-36-24" name="__codelineno-36-24" href="#__codelineno-36-24"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-36-25"><a id="__codelineno-36-25" name="__codelineno-36-25" href="#__codelineno-36-25"></a><span class="cm">     * 使用重试机制来获取属性值。</span>
</span><span id="__span-36-26"><a id="__codelineno-36-26" name="__codelineno-36-26" href="#__codelineno-36-26"></a><span class="cm">     *</span>
</span><span id="__span-36-27"><a id="__codelineno-36-27" name="__codelineno-36-27" href="#__codelineno-36-27"></a><span class="cm">     * @param value 要获取的属性值对象</span>
</span><span id="__span-36-28"><a id="__codelineno-36-28" name="__codelineno-36-28" href="#__codelineno-36-28"></a><span class="cm">     * @return 获取的 HalPropValue 对象</span>
</span><span id="__span-36-29"><a id="__codelineno-36-29" name="__codelineno-36-29" href="#__codelineno-36-29"></a><span class="cm">     */</span>
</span><span id="__span-36-30"><a id="__codelineno-36-30" name="__codelineno-36-30" href="#__codelineno-36-30"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">HalPropValue</span><span class="w"> </span><span class="nf">getValueWithRetry</span><span class="p">(</span><span class="n">HalPropValue</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-31"><a id="__codelineno-36-31" name="__codelineno-36-31" href="#__codelineno-36-31"></a><span class="w">        </span><span class="c1">// 默认重试次数为 0</span>
</span><span id="__span-36-32"><a id="__codelineno-36-32" name="__codelineno-36-32" href="#__codelineno-36-32"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getValueWithRetry</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="cm">/* maxRetries= */</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-36-33"><a id="__codelineno-36-33" name="__codelineno-36-33" href="#__codelineno-36-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-36-34"><a id="__codelineno-36-34" name="__codelineno-36-34" href="#__codelineno-36-34"></a>
</span><span id="__span-36-35"><a id="__codelineno-36-35" name="__codelineno-36-35" href="#__codelineno-36-35"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-36-36"><a id="__codelineno-36-36" name="__codelineno-36-36" href="#__codelineno-36-36"></a><span class="cm">     * 使用重试机制来获取属性值，允许设置最大重试次数。</span>
</span><span id="__span-36-37"><a id="__codelineno-36-37" name="__codelineno-36-37" href="#__codelineno-36-37"></a><span class="cm">     *</span>
</span><span id="__span-36-38"><a id="__codelineno-36-38" name="__codelineno-36-38" href="#__codelineno-36-38"></a><span class="cm">     * @param value 要获取的属性值对象</span>
</span><span id="__span-36-39"><a id="__codelineno-36-39" name="__codelineno-36-39" href="#__codelineno-36-39"></a><span class="cm">     * @param maxRetries 最大重试次数</span>
</span><span id="__span-36-40"><a id="__codelineno-36-40" name="__codelineno-36-40" href="#__codelineno-36-40"></a><span class="cm">     * @return 获取的 HalPropValue 对象</span>
</span><span id="__span-36-41"><a id="__codelineno-36-41" name="__codelineno-36-41" href="#__codelineno-36-41"></a><span class="cm">     */</span>
</span><span id="__span-36-42"><a id="__codelineno-36-42" name="__codelineno-36-42" href="#__codelineno-36-42"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">HalPropValue</span><span class="w"> </span><span class="nf">getValueWithRetry</span><span class="p">(</span><span class="n">HalPropValue</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxRetries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-43"><a id="__codelineno-36-43" name="__codelineno-36-43" href="#__codelineno-36-43"></a><span class="w">        </span><span class="n">HalPropValue</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-36-44"><a id="__codelineno-36-44" name="__codelineno-36-44" href="#__codelineno-36-44"></a><span class="w">        </span><span class="c1">// 记录获取属性值操作的开始时间</span>
</span><span id="__span-36-45"><a id="__codelineno-36-45" name="__codelineno-36-45" href="#__codelineno-36-45"></a><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">TRACE_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;VehicleStub#getValueWithRetry&quot;</span><span class="p">);</span>
</span><span id="__span-36-46"><a id="__codelineno-36-46" name="__codelineno-36-46" href="#__codelineno-36-46"></a>
</span><span id="__span-36-47"><a id="__codelineno-36-47" name="__codelineno-36-47" href="#__codelineno-36-47"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-48"><a id="__codelineno-36-48" name="__codelineno-36-48" href="#__codelineno-36-48"></a><span class="w">            </span><span class="c1">// 调用重试机制进行获取属性值的操作</span>
</span><span id="__span-36-49"><a id="__codelineno-36-49" name="__codelineno-36-49" href="#__codelineno-36-49"></a><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invokeRetriable</span><span class="p">((</span><span class="n">requestValue</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-50"><a id="__codelineno-36-50" name="__codelineno-36-50" href="#__codelineno-36-50"></a><span class="w">                </span><span class="c1">// 开始获取属性值的操作</span>
</span><span id="__span-36-51"><a id="__codelineno-36-51" name="__codelineno-36-51" href="#__codelineno-36-51"></a><span class="w">                </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">TRACE_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;VehicleStub#get&quot;</span><span class="p">);</span>
</span><span id="__span-36-52"><a id="__codelineno-36-52" name="__codelineno-36-52" href="#__codelineno-36-52"></a><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-53"><a id="__codelineno-36-53" name="__codelineno-36-53" href="#__codelineno-36-53"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">mVehicleStub</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">requestValue</span><span class="p">);</span><span class="w"> </span><span class="c1">// 调用实际的 VehicleStub 获取属性值</span>
</span><span id="__span-36-54"><a id="__codelineno-36-54" name="__codelineno-36-54" href="#__codelineno-36-54"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-55"><a id="__codelineno-36-55" name="__codelineno-36-55" href="#__codelineno-36-55"></a><span class="w">                    </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">TRACE_TAG</span><span class="p">);</span><span class="w"> </span><span class="c1">// 结束属性获取操作的追踪</span>
</span><span id="__span-36-56"><a id="__codelineno-36-56" name="__codelineno-36-56" href="#__codelineno-36-56"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-36-57"><a id="__codelineno-36-57" name="__codelineno-36-57" href="#__codelineno-36-57"></a><span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="s">&quot;get&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">mMaxDurationForRetryMs</span><span class="p">,</span><span class="w"> </span><span class="n">mSleepBetweenRetryMs</span><span class="p">,</span><span class="w"> </span><span class="n">maxRetries</span><span class="p">);</span>
</span><span id="__span-36-58"><a id="__codelineno-36-58" name="__codelineno-36-58" href="#__codelineno-36-58"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-59"><a id="__codelineno-36-59" name="__codelineno-36-59" href="#__codelineno-36-59"></a><span class="w">            </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">TRACE_TAG</span><span class="p">);</span><span class="w"> </span><span class="c1">// 结束重试操作的追踪</span>
</span><span id="__span-36-60"><a id="__codelineno-36-60" name="__codelineno-36-60" href="#__codelineno-36-60"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-36-61"><a id="__codelineno-36-61" name="__codelineno-36-61" href="#__codelineno-36-61"></a>
</span><span id="__span-36-62"><a id="__codelineno-36-62" name="__codelineno-36-62" href="#__codelineno-36-62"></a><span class="w">        </span><span class="c1">// 如果获取的结果为 null，并且 VHAL 返回状态为 OKAY，我们将其视为不可用</span>
</span><span id="__span-36-63"><a id="__codelineno-36-63" name="__codelineno-36-63" href="#__codelineno-36-63"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-64"><a id="__codelineno-36-64" name="__codelineno-36-64" href="#__codelineno-36-64"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="p">(</span><span class="n">StatusCode</span><span class="p">.</span><span class="na">NOT_AVAILABLE</span><span class="p">,</span>
</span><span id="__span-36-65"><a id="__codelineno-36-65" name="__codelineno-36-65" href="#__codelineno-36-65"></a><span class="w">                    </span><span class="n">errorMessage</span><span class="p">(</span><span class="s">&quot;get&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;VHAL returns null for property value&quot;</span><span class="p">));</span>
</span><span id="__span-36-66"><a id="__codelineno-36-66" name="__codelineno-36-66" href="#__codelineno-36-66"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-36-67"><a id="__codelineno-36-67" name="__codelineno-36-67" href="#__codelineno-36-67"></a>
</span><span id="__span-36-68"><a id="__codelineno-36-68" name="__codelineno-36-68" href="#__codelineno-36-68"></a><span class="w">        </span><span class="c1">// 返回获取到的属性值</span>
</span><span id="__span-36-69"><a id="__codelineno-36-69" name="__codelineno-36-69" href="#__codelineno-36-69"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-36-70"><a id="__codelineno-36-70" name="__codelineno-36-70" href="#__codelineno-36-70"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-36-71"><a id="__codelineno-36-71" name="__codelineno-36-71" href="#__codelineno-36-71"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>getValueWithRetry()</code> 实现了带重试机制的属性获取操作。
<code>invokeRetriable()</code> 是一个通用的重试机制，它接受一个 <code>Callable</code> 类型的操作，并执行该操作。如果操作失败，则会根据配置的最大重试次数进行重试，直到成功或超时。这个点在前面的 <a href="Android 15 CarService源码04-CarService 与Vehicle HAL交互.md">Android 15 CarService源码04-CarService与Vehicle HAL交互</a> 分析过了。
我们直接看 <code>mVehicleStub.get(requestValue)</code> , 也就是 <code>AidlVehicleStub.get()</code> 。</p>
<h3 id="aidlvehiclestubget">AidlVehicleStub.get()<a class="headerlink" href="#aidlvehiclestubget" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c1">// packages/services/Car/service/src/com/android/car/AidlVehicleStub.java</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AidlVehicleStub</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">VehicleStub</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="cm">     * 获取一个属性。</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="cm">     *</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="cm">     * @param requestedPropValue 要获取的属性。</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="cm">     * @return 返回车辆属性值。</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="cm">     * @throws RemoteException 如果远程操作失败。</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="cm">     * @throws ServiceSpecificException 如果 VHAL 返回特定的服务错误。</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="cm">     */</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="w">    </span><span class="nd">@Nullable</span>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">HalPropValue</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">HalPropValue</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">)</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a>
</span><span id="__span-37-18"><a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a><span class="w">        </span><span class="c1">// 记录当前时间，用于计算延迟</span>
</span><span id="__span-37-19"><a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
</span><span id="__span-37-20"><a id="__codelineno-37-20" name="__codelineno-37-20" href="#__codelineno-37-20"></a>
</span><span id="__span-37-21"><a id="__codelineno-37-21" name="__codelineno-37-21" href="#__codelineno-37-21"></a><span class="w">        </span><span class="c1">// 使用同步操作和重试机制获取属性值</span>
</span><span id="__span-37-22"><a id="__codelineno-37-22" name="__codelineno-37-22" href="#__codelineno-37-22"></a><span class="w">        </span><span class="n">HalPropValue</span><span class="w"> </span><span class="n">halPropValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOrSetSync</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">,</span>
</span><span id="__span-37-23"><a id="__codelineno-37-23" name="__codelineno-37-23" href="#__codelineno-37-23"></a><span class="w">                </span><span class="n">mPendingSyncGetValueRequestPool</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AsyncGetRequestsHandler</span><span class="p">(),</span>
</span><span id="__span-37-24"><a id="__codelineno-37-24" name="__codelineno-37-24" href="#__codelineno-37-24"></a><span class="w">                </span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-25"><a id="__codelineno-37-25" name="__codelineno-37-25" href="#__codelineno-37-25"></a><span class="w">                    </span><span class="c1">// 如果获取的状态不是 OK，抛出服务特定的异常</span>
</span><span id="__span-37-26"><a id="__codelineno-37-26" name="__codelineno-37-26" href="#__codelineno-37-26"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">StatusCode</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-27"><a id="__codelineno-37-27" name="__codelineno-37-27" href="#__codelineno-37-27"></a><span class="w">                        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">status</span><span class="p">,</span>
</span><span id="__span-37-28"><a id="__codelineno-37-28" name="__codelineno-37-28" href="#__codelineno-37-28"></a><span class="w">                                </span><span class="s">&quot;failed to get value for &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">printPropIdAreaId</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">));</span>
</span><span id="__span-37-29"><a id="__codelineno-37-29" name="__codelineno-37-29" href="#__codelineno-37-29"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-37-30"><a id="__codelineno-37-30" name="__codelineno-37-30" href="#__codelineno-37-30"></a><span class="w">                    </span><span class="c1">// 如果返回的属性值为空，返回 null</span>
</span><span id="__span-37-31"><a id="__codelineno-37-31" name="__codelineno-37-31" href="#__codelineno-37-31"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">prop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-32"><a id="__codelineno-37-32" name="__codelineno-37-32" href="#__codelineno-37-32"></a><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-37-33"><a id="__codelineno-37-33" name="__codelineno-37-33" href="#__codelineno-37-33"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-37-34"><a id="__codelineno-37-34" name="__codelineno-37-34" href="#__codelineno-37-34"></a><span class="w">                    </span><span class="c1">// 如果属性值存在，构建并返回 HalPropValue 对象</span>
</span><span id="__span-37-35"><a id="__codelineno-37-35" name="__codelineno-37-35" href="#__codelineno-37-35"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">mPropValueBuilder</span><span class="p">.</span><span class="na">build</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">prop</span><span class="p">);</span>
</span><span id="__span-37-36"><a id="__codelineno-37-36" name="__codelineno-37-36" href="#__codelineno-37-36"></a><span class="w">                </span><span class="p">});</span>
</span><span id="__span-37-37"><a id="__codelineno-37-37" name="__codelineno-37-37" href="#__codelineno-37-37"></a>
</span><span id="__span-37-38"><a id="__codelineno-37-38" name="__codelineno-37-38" href="#__codelineno-37-38"></a><span class="w">        </span><span class="c1">// 记录同步获取属性值的延迟并进行性能分析</span>
</span><span id="__span-37-39"><a id="__codelineno-37-39" name="__codelineno-37-39" href="#__codelineno-37-39"></a><span class="w">        </span><span class="n">sVehicleHalGetSyncLatencyHistogram</span><span class="p">.</span><span class="na">logSample</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span>
</span><span id="__span-37-40"><a id="__codelineno-37-40" name="__codelineno-37-40" href="#__codelineno-37-40"></a><span class="w">                </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">currentTime</span><span class="p">));</span>
</span><span id="__span-37-41"><a id="__codelineno-37-41" name="__codelineno-37-41" href="#__codelineno-37-41"></a>
</span><span id="__span-37-42"><a id="__codelineno-37-42" name="__codelineno-37-42" href="#__codelineno-37-42"></a><span class="w">        </span><span class="c1">// 返回获取的 HalPropValue</span>
</span><span id="__span-37-43"><a id="__codelineno-37-43" name="__codelineno-37-43" href="#__codelineno-37-43"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">halPropValue</span><span class="p">;</span>
</span><span id="__span-37-44"><a id="__codelineno-37-44" name="__codelineno-37-44" href="#__codelineno-37-44"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-37-45"><a id="__codelineno-37-45" name="__codelineno-37-45" href="#__codelineno-37-45"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里就不再重新分析了，请参考前面的 <a href="Android 15 CarService源码04-CarService 与Vehicle HAL交互.md">Android 15 CarService源码04-CarService与Vehicle HAL交互</a> 。</p>
<h2 id="_6">后话<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>像异步设置/获取属性、获取读写权限等接口的流程大同小异。虽然 <code>CarPropertyService</code> 还有很多内容可以讲，但是我在这一服务浪费了太多时间，不想再深入了。</p>







  
  






  <h2 id="__comments">评论</h2>
  <!-- Insert generated snippet here -->

    <script src="https://giscus.app/client.js"
        data-repo="i-rtfsc/i-rtfsc.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxNTU2NzA2OTE="
        data-category="Q&A"
        data-category-id="DIC_kwDOCUdYo84CeZYU"
        data-mapping="pathname"
        data-strict="1"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        data-loading="lazy"
        data-default-reactions-enabled="1"
        crossorigin="anonymous"
        async>
    </script>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate"
        ? "transparent_dark"
        : "light"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme)
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>


<script src="//code.tidio.co/rqu0g9yeqzoipyjjehe84aqmiqt1ap9r.js" async></script>


                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
    
    
    
    <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
        
        <a href="../car-property-manager/" class="md-footer__link md-footer__link--prev"
           aria-label="上一页: Android 15 CarService源码08-CarPropertyService">
            <div class="md-footer__button md-icon">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
                <div class="md-ellipsis">
                    Android 15 CarService源码08-CarPropertyService
                </div>
            </div>
        </a>
        
        
        
        <a href="../../vehicle/android-s-hal-intro/" class="md-footer__link md-footer__link--next"
           aria-label="下一页: Android-S Vehicle HAL架构">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
                <div class="md-ellipsis">
                    Android-S Vehicle HAL架构
                </div>
            </div>
            <div class="md-footer__button md-icon">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
        </a>
        
    </nav>
    
    
    <div class="md-footer-meta md-typeset">
        <div class="md-footer-meta__inner md-grid">
            <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2015-2025 Solo</br>The website content is licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>
    </div>
  
  
</div>

            
            <div class="md-copyright">
    <font size=1>
        
        <a href="https://icp.gov.moe/?keyword=20243250" target="_blank">萌ICP备20243250号</a>
        

        
        <span>&nbsp;|&nbsp;本站访问量：</span>
        <script async src="//finicounter.eu.org/finicounter.js"></script>
        <span id="finicount_views"></span>
        

        
        
        <span>&nbsp;|&nbsp;本站已经运行：</span>
        <span id="uptime"></span>
        <script>
            function calculateUptime() {
                let dateString = '2018-11-1'
                let start = new Date(dateString);
                let currentTime = new Date();
                let difference = currentTime - start;
                let days = Math.floor(difference / (1000 * 60 * 60 * 24));
                document.getElementById('uptime').textContent = days + '天';
            }

            calculateUptime()
        </script>
        
    </font>
</div>
            

            
            <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/i-rtfsc" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:<anqi.huang@outlook.com>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.8l167.6-182.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4"/></svg>
    </a>
  
</div>
            
        </div>
    </div>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "navigation.indexes", "navigation.top", "navigation.footer", "navigation.tracking", "navigation.path", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": {"Default": "default-tag", "Hardware": "hardware-tag", "Software": "software-tag"}, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
        <script src="../../../../javascripts/extra.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.0.2/dist/add-html-label-6e56ed67.min.js"></script>
      
    
  </body>
</html>